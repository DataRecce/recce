#!/bin/bash

# Check if there are any staged TypeScript/JavaScript files in the js directory
staged_js_files=$(git diff --cached --name-only | grep "^js/" | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$staged_js_files" ]; then
	echo "TypeScript/JavaScript files changed, running lint and type check..."
	# Convert js/path/to/file.ts to path/to/file.ts (relative to js/)
	relative_files=$(echo "$staged_js_files" | sed 's|^js/||')
	(cd js && pnpm exec biome check --diagnostic-level=error $relative_files && pnpm type:check && pnpm exec vitest run --passWithNoTests)
else
	echo "No TypeScript/JavaScript files changed, skipping lint and type check."
fi

# start templated
INSTALL_PYTHON=${INSTALL_PYTHON:-$(command -v python || true)}
ARGS="hook-impl --config=.pre-commit-config.yaml --hook-type=pre-commit"
# end templated

HERE="$(cd "$(dirname "$0")" && pwd)"
STRIP_JS_HUSKY=$(echo "$HERE" | sed 's|/js/\.husky$||')
ARGS="$ARGS --hook-dir $STRIP_JS_HUSKY -- $*"

if [ -x "$INSTALL_PYTHON" ] && "$INSTALL_PYTHON" -c "import pre_commit" 2>/dev/null; then
	exec "$INSTALL_PYTHON" -mpre_commit $ARGS
elif command -v pre-commit >/dev/null; then
	exec pre-commit $ARGS
else
	echo '`pre-commit` not found.  Did you forget to activate your virtualenv?' 1>&2
	echo "Skipping pre-commit hook."
fi
