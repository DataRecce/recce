(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{78695:function(e,t,r){Promise.resolve().then(r.bind(r,18429))},18429:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return Home}});var o=r(757);r(91702);var n=r(27726),a=r(52116),i=r(10929),l=r(99691),s=r(83978),d=r.n(s);r(5599);var c=r(55528),u=r(10126),h=r(29330),f=r(11180);function _getPrimaryKeyValue(e,t){let r={};for(let o of t)r[o]=e[o];return JSON.stringify(r)}function DataFrameColumnGroupHeader(e){let{name:t,primaryKeys:r,onPrimaryKeyChange:n}=e;return"index"===t?(0,o.jsx)(o.Fragment,{}):r.includes(t)?(0,o.jsxs)(c.k,{alignItems:"center",children:[(0,o.jsx)(u.xu,{flex:1,children:t}),(0,o.jsx)(h.J,{cursor:"pointer",as:f.ven,onClick:()=>{let e=r.filter(e=>e!==t);n(e)}})]}):(0,o.jsxs)(c.k,{alignItems:"center",children:[(0,o.jsx)(u.xu,{flex:1,children:t}),(0,o.jsx)(h.J,{cursor:"pointer",as:f.MhP,onClick:()=>{let e=[...r.filter(e=>"index"!==e),t];n(e)}})]})}function queryDiff(e,t,r,n){let a=[],i=[],l={},s={};if(!d().isEqual(e.schema.primaryKey,t.schema.primaryKey))throw Error("primary key mismatch! ".concat(e.schema.primaryKey," != ").concat(t.schema.primaryKey));0===r.length&&(r=e.schema.primaryKey),t.schema.fields.forEach(e=>{l[e.name]={},l[e.name].current=e}),e.schema.fields.forEach(e=>{l[e.name]||(l[e.name]={}),l[e.name].base=e}),Object.entries(l).forEach(e=>{let[t,{base:l,current:s}]=e;if(r.includes(t))i.push({key:"".concat(t),name:(0,o.jsx)(DataFrameColumnGroupHeader,{name:t,primaryKeys:r,onPrimaryKeyChange:n}),frozen:!0});else{if("index"===t)return;let cellClass=e=>{if(!d().isEqual(e["base__".concat(t)],e["current__".concat(t)]))return"diff-cell"};a.push({name:(0,o.jsx)(DataFrameColumnGroupHeader,{name:t,primaryKeys:r,onPrimaryKeyChange:n}),children:[{key:"base__".concat(t),name:"Base",cellClass},{key:"current__".concat(t),name:"Current",cellClass}]})}}),t.data.forEach(e=>{let t=_getPrimaryKeyValue(e,r);s[t]={},s[t].current=e}),e.data.forEach(e=>{let t=_getPrimaryKeyValue(e,r);s[t]||(s[t]={}),s[t].base=e});let c=Object.entries(s).map(e=>{let[t,{base:o,current:n}]=e,a=JSON.parse(t);return o&&Object.keys(o).forEach(e=>{r.includes(e)||(a["base__".concat(e)]=o[e])}),n&&Object.keys(n).forEach(e=>{r.includes(e)||(a["current__".concat(e)]=n[e])}),a});return{columns:[...i,...a],rows:c}}var g=r(12218);let m=g.env.NEXT_PUBLIC_API_URL||"";var p=r(11197),v=r(33695);let DiffViewDataGrid=e=>{let{loading:t,error:r,errorStep:n,columns:i,rows:l}=e;return t?(0,o.jsx)(o.Fragment,{children:"Loading..."}):r?(0,o.jsxs)(o.Fragment,{children:["Error while querying ",n," environment: ",r]}):0===i.length?(0,o.jsx)(o.Fragment,{children:"No data"}):(0,o.jsx)(a.ZP,{style:{height:"100%"},columns:i,rows:l,defaultColumnOptions:{resizable:!0}})};var components_DiffView=()=>{let[e,t]=(0,n.useState)('select * from {{ ref("mymodel") }} limit 1000'),[r,a]=(0,n.useState)(!1),[s,d]=(0,n.useState)(),[h,f]=(0,n.useState)(),[g,x]=(0,n.useState)(),[y,b]=(0,n.useState)(),[j,w]=(0,n.useState)([]),k=(0,n.useCallback)(async()=>{let t="current";try{a(!0);let r=await i.default.post("".concat(m,"/api/query"),{sql_template:e,base:!1});if(200!==r.status)throw Error("error");t="base";let o=await i.default.post("".concat(m,"/api/query"),{sql_template:e,base:!0});if(200!==o.status)throw Error("error");x(o.data),b(r.data),w([]),d(void 0),f(void 0)}catch(e){if(e instanceof l.d7){var r,o;let t=null==e?void 0:null===(o=e.response)||void 0===o?void 0:null===(r=o.data)||void 0===r?void 0:r.detail;t?d(t):d(null==e?void 0:e.message)}else d(null==e?void 0:e.message);f(t)}finally{a(!1)}},[e]),S=(0,n.useMemo)(()=>g&&y?queryDiff(g,y,j,e=>{w(e)}):{rows:[],columns:[]},[g,y,j]);return(0,o.jsxs)(c.k,{direction:"column",height:"calc(100vh - 74px)",children:[(0,o.jsx)(c.k,{justifyContent:"right",padding:"5px",children:(0,o.jsx)(p.z,{colorScheme:"blue",onClick:k,disabled:r,size:"sm",children:"Run"})}),(0,o.jsx)(v.g,{flex:"1",height:"200px",value:e,onChange:e=>t(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(k(),e.preventDefault())},placeholder:"Enter your SQL query here",rows:20,style:{width:"100%"}}),(0,o.jsx)(u.xu,{backgroundColor:"gray.100",height:"50vh",children:(0,o.jsx)(DiffViewDataGrid,{loading:r,error:s,errorStep:h,rows:S.rows,columns:S.columns})})]})},x=r(14612);function getNeighborSet(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,o=new Set,n={},dfs=(e,r)=>{if(r<0||void 0!==n[e]&&n[e]>=r)return;n[e]=r;let a=t(e);for(let e of a)dfs(e,r-1);o.add(e)};for(let t of e)dfs(t,r);return o}function buildLineageGraph(e,t){let r={},o={},buildNode=(e,t)=>({id:e,name:e,data:{},from:t,parents:{},children:{}});for(let[t,o]of Object.entries(e.parent_map)){r[t]=buildNode(t,"base");let o=e.nodes&&e.nodes[t];o&&(r[t].data.base=o,r[t].name=null==o?void 0:o.name,r[t].resourceType=null==o?void 0:o.resource_type,r[t].packageName=null==o?void 0:o.package_name)}for(let[e,o]of Object.entries(t.parent_map)){r[e]?r[e].from="both":r[e]=buildNode(e,"current");let o=t.nodes&&t.nodes[e];o&&(r[e].data.current=t.nodes&&t.nodes[e],r[e].name=null==o?void 0:o.name,r[e].resourceType=null==o?void 0:o.resource_type,r[e].packageName=null==o?void 0:o.package_name)}for(let[t,n]of Object.entries(e.parent_map))for(let e of n){let n=r[t],a=r[e],i="".concat(e,"_").concat(t);o[i]={id:i,from:"base",parent:a,child:n};let l=o[i];n.parents[e]=l,a.children[t]=l}for(let[e,n]of Object.entries(t.parent_map))for(let t of n){let n=r[e],a=r[t],i="".concat(t,"_").concat(e);o[i]?o[i].from="both":o[i]={id:i,from:"current",parent:a,child:n};let l=o[i];n.parents[t]=l,a.children[e]=l}let n=[];for(let[e,t]of Object.entries(r))if("base"===t.from)t.changeStatus="removed",n.push(t.id);else if("current"===t.from)t.changeStatus="added",n.push(t.id);else{var a,i,l,s,d,c;let e=null==t?void 0:null===(l=t.data)||void 0===l?void 0:null===(i=l.base)||void 0===i?void 0:null===(a=i.checksum)||void 0===a?void 0:a.checksum,r=null==t?void 0:null===(c=t.data)||void 0===c?void 0:null===(d=c.current)||void 0===d?void 0:null===(s=d.checksum)||void 0===s?void 0:s.checksum;e&&r&&e!==r&&(t.changeStatus="modified",n.push(t.id))}let u=getNeighborSet(n,e=>Object.keys(r[e].children));for(let e of Array.from(u))r[e].changeStatus||(r[e].changeStatus="impacted");for(let[e,t]of Object.entries(o))"base"===t.from?t.changeStatus="removed":"current"===t.from&&(t.changeStatus="added");return{nodes:r,edges:o}}function toReactflow(e){let t=[],r=[];for(let[r,o]of Object.entries(e.nodes))t.push({id:o.id,position:{x:0,y:0},data:o,type:"customNode",targetPosition:x.Ly.Left,sourcePosition:x.Ly.Right});for(let[t,o]of Object.entries(e.edges))r.push({id:o.id,type:"customEdge",source:o.parent.id,target:o.child.id,data:o});return[t,r]}function highlightPath(e,t,r,o){function union(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let o=new Set;return t.forEach(e=>{e.forEach(e=>{o.add(e)})}),o}let n=null!==o?union(getNeighborSet([o],t=>Object.keys(e.nodes[t].parents)),getNeighborSet([o],t=>Object.keys(e.nodes[t].children))):new Set,a=new Set(r.filter(e=>n.has(e.source)&&n.has(e.target)).map(e=>e.id)),i=t.map(e=>(e.data.isHighlighted=n.has(e.id),{...e})),l=r.map(e=>({...e,data:{...e.data,isHighlighted:a.has(e.id)}}));return[i,l]}var y=r(6556),b=r(77968),j=r(49473),w=r(16524),k=r(93864),S=r.n(k);r(38247);var C=r(63240),_=r(54057);let E=f.Nbv,O=f.sFB,N=f.UGs,IconImpacted=e=>(0,o.jsxs)("svg",{stroke:"currentColor",fill:"currentColor","stroke-width":"0",viewBox:"0 0 16 16",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg",...e,children:[(0,o.jsx)("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M1.5 1 h13 l.5.5 v13 l-.5.5 h-13 l-.5-.5 v-13l.5-.5zM2 2v4h-1v4h1v4h4v1h4v-1h4v-4h1v-4h-1v-4h-4v-1h-4v1h-4z"}),(0,o.jsx)("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M8 11 a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"}),(0,o.jsx)("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:""})]});function getIconForChangeStatus(e){return"added"===e?{color:"#1dce00",icon:E}:"removed"===e?{color:"#ff067e",icon:O}:"modified"===e?{color:"#ffa502",icon:N}:"impacted"===e?{color:"#fd6136",icon:IconImpacted}:{color:"inherit",icon:void 0}}function getIconForResourceType(e){return"model"===e?{color:"#c0eafd",icon:C.Fn3}:"metric"===e?{color:"#ffe6ee",icon:_._MV}:"source"===e?{color:"#a6dda6",icon:C.i1q}:"exposure"===e?{color:"#ffe6ee",icon:_.n8P}:"semantic_model"===e?{color:"#fb8caf",icon:_.R1C}:"seed"===e?{color:"#a6dda6",icon:C.tWi}:{color:"inherit",icon:void 0}}function GraphNode(e){var t,r;let n,{data:a}=e,{isHighlighted:i,resourceType:l,changeStatus:s}=a,d=(0,x.oR)(e=>e.transform[2]>.3),{icon:f}=getIconForResourceType(l),g="gray.400",m="solid";s&&(n=getIconForChangeStatus(s).icon,g=getIconForChangeStatus(s).color);let p=1,v=g,b="unset";i&&(p=1,v="orange",b="0px 5px 15px #00000040");let j=null==a?void 0:a.name;return(0,o.jsx)(y.u,{label:"model"===l?j:"".concat(j," (").concat(l,")"),placement:"top",children:(0,o.jsxs)(c.k,{width:"300px",_hover:{backgroundColor:d?"gray.100":g},borderColor:v,borderWidth:p,borderStyle:m,backgroundColor:d?"white":g,borderRadius:3,boxShadow:b,padding:0,children:[(0,o.jsx)(c.k,{backgroundColor:g,padding:2,borderRightWidth:p,borderColor:v,borderStyle:m,alignItems:"top",visibility:d?"inherit":"hidden",children:(0,o.jsx)(h.J,{as:f})}),(0,o.jsx)(c.k,{flex:"1 0 auto",mx:"1",width:"100px",direction:"column",children:(0,o.jsxs)(c.k,{width:"100%",textAlign:"left",flex:"1",p:1,alignItems:"center",visibility:d?"inherit":"hidden",children:[(0,o.jsx)(u.xu,{flex:"1",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:j}),n&&(0,o.jsx)(c.k,{children:(0,o.jsx)(h.J,{color:g,as:n,flex:"0 0 20px"})})]})}),Object.keys(null!==(t=null==a?void 0:a.parents)&&void 0!==t?t:{}).length>0&&(0,o.jsx)(x.HH,{type:"target",position:x.Ly.Left,isConnectable:!1}),Object.keys(null!==(r=null==a?void 0:a.children)&&void 0!==r?r:{}).length>0&&(0,o.jsx)(x.HH,{type:"source",position:x.Ly.Right,isConnectable:!1})]})})}function GraphEdge(e){let{sourceX:t,sourceY:r,targetX:n,targetY:a,sourcePosition:i,targetPosition:l,style:s={},markerEnd:d,data:c}=e,u={...s};(null==c?void 0:c.changeStatus)&&(u.stroke=getIconForChangeStatus(null==c?void 0:c.changeStatus).color,u.strokeDasharray="5"),(null==c?void 0:c.isHighlighted)&&(u.stroke="orange");let[h]=(0,x.OQ)({sourceX:t,sourceY:r,sourcePosition:i,targetX:n,targetY:a,targetPosition:l});return(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(x.u5,{path:h,markerEnd:d,style:{...u,...s}})})}let layout=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"LR",o=new(S()).graphlib.Graph;o.setDefaultEdgeLabel(()=>({})),o.setGraph({rankdir:r}),e.forEach(e=>{o.setNode(e.id,{width:300,height:36})}),t.forEach(e=>{o.setEdge(e.source,e.target)}),S().layout(o),e.forEach(e=>{let t=o.node(e.id);return e.position={x:t.x-150,y:t.y-18},e})},L={customNode:GraphNode},F={customEdge:GraphEdge},nodeColor=e=>{var t;return(null==e?void 0:null===(t=e.style)||void 0===t?void 0:t.backgroundColor)||"lightgray"};function ChangeStatusLegend(){return(0,o.jsx)(u.xu,{bg:"white",padding:"12px",borderWidth:"1px",borderColor:"gray.200",fontSize:"sm",children:Object.entries({added:["Added","Added resource"],removed:["Removed","Removed resource"],modified:["Modified","Modified resource"],impacted:["Impacted","Down-streams of added, removed, modified"]}).map(e=>{let[t,[r,n]]=e,{icon:a,color:i}=getIconForChangeStatus(t);return(0,o.jsx)(y.u,{label:n,children:(0,o.jsxs)(c.k,{alignItems:"center",gap:"6px",marginBottom:"2px",children:[(0,o.jsx)(h.J,{color:i,as:a})," ",r]})},t)})})}function LineageView(){let[e,t,r]=(0,x.Rr)([]),[a,s,d]=(0,x.ll)([]),[c,h]=(0,n.useState)(),[f,g]=(0,n.useState)(!1),[p,v]=(0,n.useState)(),[y,k]=(0,n.useState)(),S=(0,n.useCallback)(async()=>{let e="current";try{g(!0);let r=await i.default.get("".concat(m,"/api/lineage?base=0"));if(200!==r.status)throw Error("error");e="base";let o=await i.default.get("".concat(m,"/api/lineage?base=1"));if(200!==o.status)throw Error("error");let n=buildLineageGraph(o.data,r.data),[a,l]=toReactflow(n);layout(a,l),h(n),t(a),s(l),v(void 0),k(void 0)}catch(t){if(t instanceof l.d7){var r,o;let e=null==t?void 0:null===(o=t.response)||void 0===o?void 0:null===(r=o.data)||void 0===r?void 0:r.detail;e?v(e):v(null==t?void 0:t.message)}else v(null==t?void 0:t.message);k(e)}finally{g(!1)}},[t,s]);return((0,n.useEffect)(()=>{S()},[S]),f)?(0,o.jsx)(o.Fragment,{children:"Loading lineage data"}):p?(0,o.jsxs)(o.Fragment,{children:["Fail to load lineage data: ",p]}):(0,o.jsx)(u.xu,{width:"100%",height:"calc(100vh - 74px)",children:(0,o.jsxs)(x.x$,{nodeTypes:L,edgeTypes:F,nodes:e,edges:a,onNodesChange:r,onEdgesChange:d,onNodeMouseEnter:(r,o)=>{if(c){let[r,n]=highlightPath(c,e,a,o.id);t(r),s(n)}},onNodeMouseLeave:(r,o)=>{if(c){let[r,o]=highlightPath(c,e,a,null);t(r),s(o)}},children:[(0,o.jsx)(b.A,{color:"#ccc"}),(0,o.jsx)(j.Z,{showInteractive:!1,position:"top-right"}),(0,o.jsx)(x.s_,{position:"bottom-left",children:(0,o.jsx)(ChangeStatusLegend,{})}),(0,o.jsx)(w.a,{nodeColor:nodeColor,nodeStrokeWidth:3})]})})}var I=r(55344),D=r(1726),P=r(83622),R=r(21801),K=r(29731);function Home(){return(0,o.jsxs)(I.m,{children:[(0,o.jsxs)(D.t,{children:[(0,o.jsx)(P.O,{children:"Lineage"}),(0,o.jsx)(P.O,{children:"Query"})]}),(0,o.jsxs)(R.n,{children:[(0,o.jsx)(K.x,{children:(0,o.jsx)(LineageView,{})}),(0,o.jsx)(K.x,{children:(0,o.jsx)(components_DiffView,{})})]})]})}},5599:function(){}},function(e){e.O(0,[759,170,182,710,495,100,777,297,62,744],function(){return e(e.s=78695)}),_N_E=e.O()}]);