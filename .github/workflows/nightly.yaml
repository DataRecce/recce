name: Recce Nightly Build
on:
  schedule:
    - cron: '0 18 * * 0,1,2,3,4' # run at 2 AM (UTC + 8) every working day
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Select the type of night build'
        type: choice
        required: true
        options:
          - Alpha Release
          - Release
      alpha_version:
        description: 'Alpha version serial number'
        required: true
        type: number
        default: 0

permissions:
  contents: read

jobs:
  build-nightly-release:
    name: Build Recce Nightly Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: |
          # Install Python dependencies
          uv sync --all-extras --python 3.10

          # Install Node dependencies
          pushd js
          pnpm install --frozen-lockfile
          popd

      - name: Patch Recce Version
        id: patch_version
        run: |
          # Patch version
          if [[ "$RELEASE_TYPE" == "Alpha Release" && "$ALPHA_VERSION" != "" ]]; then
            echo "Manually alpha version serial number: $ALPHA_VERSION"
            sed -i.bak "s/\.dev.*\$/\.$(date '+%Y%m%d')a$ALPHA_VERSION/" recce/VERSION
          else
            latest_version=$(curl -s https://pypi.org/pypi/recce-nightly/json  | jq -r .info.version)
            new_version=$(cat recce/VERSION | sed "s/\.dev.*\$/\.$(date '+%Y%m%d')/")

            # Extract date-only portion of both
            latest_date=$(echo "$latest_version" | sed -E 's/^.*\.([0-9]{8}).*/\1/')
            new_date=$(date '+%Y%m%d')

            if [[ "$latest_date" < "$new_date" ]]; then
              # New date is newer, no post needed
              final_version="$new_version"
            else
              # Same date, check if latest already has postN
              if [[ "$latest_version" =~ \.post([0-9]+)$ ]]; then
                post_num=$(( ${BASH_REMATCH[1]} + 1 ))
              else
                post_num=1
              fi
              final_version="${new_version}-post${post_num}"
            fi
            echo "$final_version" > recce/VERSION
          fi
          echo "Nightly version: $(cat recce/VERSION)"
          echo "nightly_version=$(cat recce/VERSION)" >> $GITHUB_OUTPUT
        env:
          ALPHA_VERSION: ${{ inputs.alpha_version || '' }}
          RELEASE_TYPE: ${{ inputs.release_type || 'Release' }}

      - name: Patch Event API Key
        run: |
          # Patch Event API Key
          sed -i.bak "s/<API_KEY>/${EVENT_API_KEY}/" recce/event/CONFIG
        env:
          EVENT_API_KEY: ${{ secrets.AMPLITUDE_NIGHTLY_API_KEY }}

      - name: Build Front-end Static Files
        run: |
          # Build static files
          pushd js
          pnpm build
          popd
        env:
          AMPLITUDE_API_KEY: ${{ secrets.AMPLITUDE_NIGHTLY_API_KEY }}
          GTM_ID: ${{ secrets.NIGHTLY_GTM_ID }}

      - name: Release to Pypi
        run: |
          # generate pypirc
          echo "$PYPIRC" > $HOME/.pypirc

          # change package name to recce-nightly in pyproject.toml
          sed -i.bak 's/name = "recce"/name = "recce-nightly"/' pyproject.toml

          # build and upload to pypi
          uv build
          uv run twine upload dist/*
        env:
          PYPIRC: ${{ secrets.PYPI }}

      - name: Mark Sentry Release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: infuseai
          SENTRY_PROJECT: recce
        with:
          environment: nightly
          ignore_empty: true
          ignore_missing: true
          version: ${{ steps.patch_version.outputs.nightly_version }}

      # Only upload version artifact for regular nightly builds (not alpha)
      # Alpha builds are for testing unmerged PRs and should not trigger npm release
      - name: Upload version artifact for UI release
        if: inputs.release_type != 'Alpha Release'
        uses: actions/upload-artifact@v4
        with:
          name: recce-nightly-version
          path: recce/VERSION
          retention-days: 1

  build-recce-cloud-nightly:
    name: Build Recce Cloud Nightly Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          # Install Python dependencies
          uv sync --all-extras --python 3.10

      - name: Patch Recce Cloud Version
        id: patch_version
        run: |
          # Patch version directly in recce_cloud/recce_cloud/VERSION
          if [[ "$RELEASE_TYPE" == "Alpha Release" && "$ALPHA_VERSION" != "" ]]; then
            echo "Manually alpha version serial number: $ALPHA_VERSION"
            sed -i.bak "s/\.dev.*$/\.$(date '+%Y%m%d')a$ALPHA_VERSION/" recce_cloud/recce_cloud/VERSION
          else
            latest_version=$(curl -s https://pypi.org/pypi/recce-cloud-nightly/json  | jq -r .info.version)
            new_version=$(cat recce_cloud/recce_cloud/VERSION | sed "s/\.dev.*$/\.$(date '+%Y%m%d')/")

            # Extract date-only portion of both
            latest_date=$(echo "$latest_version" | sed -E 's/^.*\.([0-9]{8}).*/\1/')
            new_date=$(date '+%Y%m%d')

            if [[ "$latest_date" < "$new_date" ]]; then
              # New date is newer, no post needed
              final_version="$new_version"
            else
              if [[ "$latest_version" =~ \.post([0-9]+)$ ]]; then
                post_num=$(( ${BASH_REMATCH[1]} + 1 ))
              else
                post_num=1
              fi
              final_version="${new_version}-post${post_num}"
            fi
            echo "$final_version" > recce_cloud/recce_cloud/VERSION
          fi

          echo "Nightly version: $(cat recce_cloud/recce_cloud/VERSION)"
          echo "nightly_version=$(cat recce_cloud/recce_cloud/VERSION)" >> $GITHUB_OUTPUT
        env:
          ALPHA_VERSION: ${{ inputs.alpha_version || '' }}
          RELEASE_TYPE: ${{ inputs.release_type || 'Release' }}

      - name: Release to Pypi
        run: |
          # generate pypirc
          echo "$PYPIRC" > $HOME/.pypirc

          # change package name to recce-cloud-nightly in pyproject.toml
          sed -i.bak 's/name = "recce-cloud"/name = "recce-cloud-nightly"/' recce_cloud/pyproject.toml

          # build and upload to pypi
          uv build --package recce-cloud-nightly
          uv run twine upload dist/*
        env:
          PYPIRC: ${{ secrets.PYPI }}

      - name: Mark Sentry Release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: infuseai
          SENTRY_PROJECT: recce-cloud
        with:
          environment: nightly
          ignore_empty: true
          ignore_missing: true
          version: ${{ steps.patch_version.outputs.nightly_version }}

  trigger-build-recce-instance-launcher-image:
    name: Trigger Build Recce Instance Launcher Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: build-nightly-release
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: 2343362 # App ID of Recce Action Bot
          private-key: ${{ secrets.RECCE_ACTION_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: Trigger Recce Instance Launcher Image Build
        id: dispatch
        continue-on-error: true
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: 'build-recce-instance-launcher.yml'
          repo: 'DataRecce/recce-cloud-infra'
          ref: 'main'
          inputs: '{ "environment": "staging" }'
          token: '${{ steps.app-token.outputs.token }}'
      - name: Handle dispatch failure
        if: steps.dispatch.outcome == 'failure'
        run: |
          echo "::warning::Failed to trigger recce-cloud-infra build workflow"
          echo "::warning::Please manually trigger the build at: https://github.com/DataRecce/recce-cloud-infra/actions/workflows/build-recce-instance-launcher.yml"
          echo "::warning::Use ref: main and environment: staging"
