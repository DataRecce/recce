(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{99178:function(e,t,n){Promise.resolve().then(n.bind(n,30652))},30652:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return Home}});var r=n(757),o=n(27869);function getNeighborSet(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,r=new Set,o={},dfs=(e,n)=>{if(n<0||void 0!==o[e]&&o[e]>=n)return;o[e]=n;let i=t(e);for(let e of i)dfs(e,n-1);r.add(e)};for(let t of e)dfs(t,n);return r}function buildDefaultLineageGraphSets(e,t){function buildAllLineageGraph(e,t){let n={},r={},buildNode=(e,t)=>({id:e,name:e,data:{},from:t,parents:{},children:{},isSelected:!1});for(let[t,r]of Object.entries(e.parent_map)){n[t]=buildNode(t,"base");let r=e.nodes&&e.nodes[t];r&&(n[t].data.base=r,n[t].name=null==r?void 0:r.name,n[t].resourceType=null==r?void 0:r.resource_type,n[t].packageName=null==r?void 0:r.package_name)}for(let[e,r]of Object.entries(t.parent_map)){n[e]?n[e].from="both":n[e]=buildNode(e,"current");let r=t.nodes&&t.nodes[e];r&&(n[e].data.current=t.nodes&&t.nodes[e],n[e].name=null==r?void 0:r.name,n[e].resourceType=null==r?void 0:r.resource_type,n[e].packageName=null==r?void 0:r.package_name)}for(let[t,o]of Object.entries(e.parent_map))for(let e of o){let o=n[t],i=n[e],l="".concat(e,"_").concat(t);r[l]={id:l,from:"base",parent:i,child:o};let a=r[l];o.parents[e]=a,i.children[t]=a}for(let[e,o]of Object.entries(t.parent_map))for(let t of o){let o=n[e],i=n[t],l="".concat(t,"_").concat(e);r[l]?r[l].from="both":r[l]={id:l,from:"current",parent:i,child:o};let a=r[l];o.parents[t]=a,i.children[e]=a}return{edges:r,nodes:n}}function buildChangedOnlyLineageGraph(e,t){let n={},r={};function union(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let r=new Set;return t.forEach(e=>{e.forEach(e=>{r.add(e)})}),r}let o=selectDownstream(e,t),i=selectUpstream(e,t,1),l=union(o,i);return Object.entries(e.nodes).forEach(e=>{let[t,r]=e;l.has(t)&&(n[t]=r)}),Object.entries(e.edges).forEach(e=>{let[t,n]=e;l.has(n.parent.id)&&l.has(n.child.id)&&(r[t]=n)}),{nodes:n,edges:r}}let{nodes:n,edges:r}=buildAllLineageGraph(e,t),o=[];for(let[e,t]of Object.entries(n))if("base"===t.from)t.changeStatus="removed",o.push(t.id);else if("current"===t.from)t.changeStatus="added",o.push(t.id);else{var i,l,a,s,c,d;let e=null==t?void 0:null===(a=t.data)||void 0===a?void 0:null===(l=a.base)||void 0===l?void 0:null===(i=l.checksum)||void 0===i?void 0:i.checksum,n=null==t?void 0:null===(d=t.data)||void 0===d?void 0:null===(c=d.current)||void 0===c?void 0:null===(s=c.checksum)||void 0===s?void 0:s.checksum;e&&n&&e!==n&&(t.changeStatus="modified",o.push(t.id))}for(let[e,t]of Object.entries(r))"base"===t.from?t.changeStatus="removed":"current"===t.from&&(t.changeStatus="added");return{all:{nodes:n,edges:r},changed:buildChangedOnlyLineageGraph({nodes:n,edges:r},o),modifiedSet:o}}function selectUpstream(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return getNeighborSet(t,t=>void 0===e.nodes[t]?[]:Object.keys(e.nodes[t].parents),n)}function selectDownstream(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return getNeighborSet(t,t=>void 0===e.nodes[t]?[]:Object.keys(e.nodes[t].children),n)}function toReactflow(e,t){let n=[],r=[];for(let[t,r]of Object.entries(e.nodes))n.push({id:r.id,position:{x:0,y:0},data:r,type:"customNode",targetPosition:o.Ly.Left,sourcePosition:o.Ly.Right});for(let[t,n]of Object.entries(e.edges))r.push({id:n.id,type:"customEdge",source:n.parent.id,target:n.child.id,data:n});return highlightPath(e,t,n,r,null)}function highlightPath(e,t,n,r,o){function union(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];let r=new Set;return t.forEach(e=>{e.forEach(e=>{r.add(e)})}),r}let i=null!==o?union(selectUpstream(e,[o]),selectDownstream(e,[o])):getNeighborSet(t,t=>void 0===e.nodes[t]?[]:Object.keys(e.nodes[t].children)),l=new Set(r.filter(e=>i.has(e.source)&&i.has(e.target)).map(e=>e.id)),a=n.map(e=>({...e,data:{...e.data,isHighlighted:i.has(e.id)}})),s=r.map(e=>({...e,data:{...e.data,isHighlighted:l.has(e.id)}}));return[a,s]}function selectNode(e,t){let n=t.map(t=>{let n=t.id===e;return{...t,data:{...t.data,isSelected:t.data.isSelected!==n}}});return n}function selectNodes(e,t){let n=t.map(t=>{let n=e.includes(t.id);return{...t,data:{...t.data,isSelected:t.data.isSelected||n}}});return n}function cleanUpSelectedNodes(e){let t=e.map(e=>({...e,data:{...e.data,isSelected:!1}}));return t}var i=n(10126),l=n(83172),a=n(55528),s=n(29330),c=n(15550),d=n(17714),u=n(46543),h=n(76920),m=n(39668),x=n(83179),f=n(62648),g=n(43093),p=n(7752),y=n(94410),j=n(13824),v=n(29985),C=n(42524),b=n(36700),k=n(10287),w=n(24275),S=n(27726),_=n(26187),R=n(23704),D=n(33710),N=n(93864),E=n.n(N);n(94570);var z=n(90593),F=n(11180),L=n(63240),T=n(54057);let q=F.Nbv,O=F.sFB,I=F.UGs,IconChanged=e=>(0,r.jsxs)("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:"0",viewBox:"0 0 16 16",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg",...e,children:[(0,r.jsx)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M8 11 a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"}),(0,r.jsx)("path",{fillRule:"evenodd",clipRule:"evenodd",d:""})]});function getIconForChangeStatus(e){return"added"===e?{color:"#1dce00",icon:q}:"removed"===e?{color:"#ff4444",icon:O}:"modified"===e?{color:"#ffa502",icon:I}:{color:"inherit",icon:void 0}}function getIconForResourceType(e){return"model"===e?{color:"#c0eafd",icon:L.Fn3}:"metric"===e?{color:"#ffe6ee",icon:T._MV}:"source"===e?{color:"#a6dda6",icon:L.i1q}:"exposure"===e?{color:"#ffe6ee",icon:T.n8P}:"semantic_model"===e?{color:"#fb8caf",icon:T.R1C}:"seed"===e?{color:"#a6dda6",icon:L.tWi}:{color:"inherit",icon:void 0}}n(88727);var M=n(19920),P=n(7467),K=n(95913),A=n(89042),B=n(80294),V=n(35537),G=n(10929),Q=n(12218);let W=Q.env.NEXT_PUBLIC_API_URL?Q.env.NEXT_PUBLIC_API_URL:window.location.origin;var H=n(27471);let U=G.default.create({baseURL:W}),J=new H.S;async function submitRun(e,t,n){let r=await U.post("/api/runs",{type:e,params:t,nowait:null==n?void 0:n.nowait}),o=r.data;return o}async function waitRun(e,t){let n=await U.get("/api/runs/".concat(e,"/wait"),{params:{timeout:t}}),r=n.data;return r}async function cancelRun(e){return await U.post("/api/runs/".concat(e,"/cancel"))}async function submitQuery(e,t){return await submitRun("query",e,t)}async function submitQueryDiff(e,t){return await submitRun("query_diff",e,t)}async function submitRowCountDiff(e,t){return await submitRun("row_count_diff",e,t)}let X={allRowCount:()=>["row_count"],rowCount:e=>["row_count",e],lineage:()=>["lineage"],checks:()=>["checks","list"],check:e=>["checks",e]},Z='select * from {{ ref("mymodel") }}',Y=(0,S.createContext)({sqlQuery:Z,setSqlQuery:()=>{}});function RecceQueryContextProvider(e){let{children:t}=e,[n,o]=S.useState(Z);return(0,r.jsx)(Y.Provider,{value:{setSqlQuery:o,sqlQuery:n},children:t})}let useRecceQueryContext=()=>(0,S.useContext)(Y),$=(0,S.createContext)({isNodesFetching:[],setIsNodesFetching:()=>{}});function RowCountStateContextProvider(e){let{children:t}=e,[n,o]=S.useState([]);return(0,r.jsx)($.Provider,{value:{isNodesFetching:n,setIsNodesFetching:o},children:t})}let useRowCountStateContext=()=>(0,S.useContext)($);async function models_queryModelRowCount(e){let{result:t}=await queryRowCount([e]);return t[e]}async function queryRowCount(e){if(0===e.length)throw Error("No model names provided");let{run_id:t}=await submitRowCountDiff({node_names:e},{nowait:!0}),n=await waitRun(t);return{runId:t,result:n.result}}function useRowCountQueries(e){let[t,n]=(0,S.useState)(!1),r=(0,V.NL)(),{setIsNodesFetching:o}=useRowCountStateContext(),i=r.getQueriesData({queryKey:X.allRowCount()}).filter(t=>{let[n,r]=t,[o,i]=n;return e.includes(i)}).map(e=>{let[t,n]=e,[r,o]=t;return{modelName:o,data:n}}),l=[];return e.forEach(e=>{let{data:t}=i.find(t=>t.modelName===e)||{data:void 0,modelName:e};void 0===t&&l.push(e)}),{isLoading:t,fetchFn:async function(){n(!0),o(l);let{runId:e,result:t}=await queryRowCount(l);return Object.keys(t).forEach(e=>{let n=t[e];r.setQueryData(X.rowCount(e),{base:n.base,curr:n.curr})}),n(!1),o([]),e}}}var ee=n(44903);function ModelRowCount(e){let{rowCount:t}=e;if(!t)return(0,r.jsxs)(f.U,{children:[(0,r.jsx)(g.x,{children:"Failed to load"}),(0,r.jsx)(s.J,{as:A.KZt,color:"red.500"})]});let n=null===t.base?-1:t.base,o=null===t.curr?-1:t.curr,i=-1===n?"N/A":n,l=-1===o?"N/A":o;return n===o?(0,r.jsxs)(g.x,{children:[n," rows"]}):n<o?(0,r.jsxs)(f.U,{children:[(0,r.jsx)(g.x,{children:i}),(0,r.jsx)(s.J,{as:A.QqI,color:"green.500"}),(0,r.jsxs)(g.x,{children:[l," rows"]})]}):(0,r.jsxs)(f.U,{children:[(0,r.jsx)(g.x,{children:i}),(0,r.jsx)(s.J,{as:A.ZBs,color:"red.500"}),(0,r.jsxs)(g.x,{children:[l," rows"]}),"rows"]})}function ResourceTypeTag(e){let{node:t}=e,{icon:n}=getIconForResourceType(t.resourceType);return(0,r.jsx)(l.u,{hasArrow:!0,label:"Type of resource",children:(0,r.jsxs)(M.Vp,{children:[(0,r.jsx)(M.AD,{as:n}),(0,r.jsx)(M.Sn,{children:t.resourceType})]})})}function RowCountTag(e){let{node:t,isAutoFetching:n=!1,isInteractive:o=!0}=e,{isNodesFetching:i}=useRowCountStateContext(),{isLoading:a,data:c,refetch:d,isFetched:u,isFetching:h}=(0,ee.a)({queryKey:X.rowCount(t.name),queryFn:()=>models_queryModelRowCount(t.name),enabled:"model"===t.resourceType&&n}),m=h||i.includes(t.name),x=a||i.includes(t.name);function ProcessedRowCountTag(e){let{isLoading:t,rowCount:n}=e;return(0,r.jsx)(M.Sn,{children:(0,r.jsx)(P.N,{isLoaded:!t,noOfLines:1,skeletonHeight:2,minWidth:"30px",children:(0,r.jsx)(ModelRowCount,{rowCount:n})})})}function UnprocessedRowCountTag(e){let{isInteractive:t,invokeFunction:n}=e;return t?(0,r.jsx)(K.h,{"aria-label":"Query Row Count",icon:(0,r.jsx)(B.j3i,{}),size:"xs",onClick:()=>{n()}}):(0,r.jsx)(s.J,{as:B.ebq})}return!1===o&&!1===u&&!1===m?null:(0,r.jsx)(l.u,{hasArrow:!0,label:u||m||!o?"Number of row":"Query the number of row",openDelay:500,closeDelay:200,children:(0,r.jsxs)(M.Vp,{children:[(0,r.jsx)(M.AD,{as:A.SwK}),u||m?(0,r.jsx)(ProcessedRowCountTag,{isLoading:x,rowCount:c}):(0,r.jsx)(UnprocessedRowCountTag,{isInteractive:o,invokeFunction:d})]})})}function FetchSelectedNodesRowCountButton(e){let{selectedNodes:t,onFinish:n}=e,{isLoading:o,fetchFn:i}=useRowCountQueries(t.map(e=>e.name));return(0,r.jsxs)(x.z,{size:"xs",variant:"outline",title:"Query Row Counts",onClick:async()=>{await i(),n&&n()},isDisabled:o||0===t.length,children:[(0,r.jsx)(s.J,{as:B.j3i,mr:1}),o?"Querying":"Query Row Counts"]})}function GraphNode(e){var t,n;let c,{data:d}=e,{isHighlighted:u,isSelected:h,resourceType:m,changeStatus:x}=d,g=(0,o.oR)(e=>e.transform[2]>.3),{icon:p}=getIconForResourceType(m),y="gray.400",j="solid";x&&(c=getIconForChangeStatus(x).icon,y=getIconForChangeStatus(x).color);let v=y,C=d.isSelected?"outline":"unset",b=null==d?void 0:d.name;return(0,r.jsx)(l.u,{label:"model"===m?b:"".concat(b," (").concat(m,")"),placement:"top",children:(0,r.jsxs)(a.k,{width:"300px",_hover:{backgroundColor:g?"gray.100":y},borderColor:v,borderWidth:1,borderStyle:j,backgroundColor:g?"white":y,borderRadius:3,boxShadow:C,padding:0,className:!0===u?"node-highlight":!0===h?"node-highlight":!1===u?"node-unhighlight":void 0,children:[(0,r.jsx)(a.k,{backgroundColor:y,padding:2,borderRightWidth:1,borderColor:v,borderStyle:j,alignItems:"top",visibility:g?"inherit":"hidden",children:(0,r.jsx)(s.J,{as:p})}),(0,r.jsxs)(a.k,{flex:"1 0 auto",mx:"1",width:"100px",direction:"column",children:[(0,r.jsxs)(a.k,{width:"100%",textAlign:"left",flex:"1",p:1,alignItems:"center",visibility:g?"inherit":"hidden",children:[(0,r.jsx)(i.xu,{flex:"1",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:b}),c&&(0,r.jsx)(a.k,{children:(0,r.jsx)(s.J,{color:y,as:c,flex:"0 0 20px"})})]}),"model"===d.resourceType&&(0,r.jsx)(a.k,{flex:"1 0 auto",mx:"1",direction:"column",paddingBottom:"1",visibility:g?"inherit":"hidden",children:(0,r.jsxs)(f.U,{spacing:"8px",children:[(0,r.jsx)(z.L,{}),(0,r.jsx)(RowCountTag,{node:d,isInteractive:!1})]})})]}),Object.keys(null!==(t=null==d?void 0:d.parents)&&void 0!==t?t:{}).length>0&&(0,r.jsx)(o.HH,{type:"target",position:o.Ly.Left,isConnectable:!1}),Object.keys(null!==(n=null==d?void 0:d.children)&&void 0!==n?n:{}).length>0&&(0,r.jsx)(o.HH,{type:"source",position:o.Ly.Right,isConnectable:!1})]})})}function GraphEdge(e){let{sourceX:t,sourceY:n,targetX:i,targetY:l,sourcePosition:a,targetPosition:s,style:c={},markerEnd:d,data:u}=e,h={...c};(null==u?void 0:u.changeStatus)&&(h.stroke=getIconForChangeStatus(null==u?void 0:u.changeStatus).color,h.strokeDasharray="5"),(null==u?void 0:u.isHighlighted)===!1&&(h.filter="opacity(0.2) grayscale(50%)");let[m]=(0,o.OQ)({sourceX:t,sourceY:n,sourcePosition:a,targetX:i,targetY:l,targetPosition:s});return(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(o.u5,{path:m,markerEnd:d,style:{...h,...c}})})}var et=n(67907),en=n(74796),er=n(79315),eo=n(58909),ei=n(2593),el=n(55344),ea=n(1726),es=n(83622),ec=n(21801),ed=n(29731),eu=n(18974);function mergeKeys(e,t){let n=[...e],r=[...t],o=[];for(;n.length>0&&r.length>0;)if(o.includes(n[0]))n.shift();else if(o.includes(r[0]))r.shift();else if(n[0]===r[0])o.push(n[0]),n.shift(),r.shift();else if(r.includes(n[0])){let e=r.indexOf(n[0]);for(let t=0;t<e;t++)o.includes(r[t])||o.push(r[t]);o.push(n[0]),n.shift(),r.splice(0,e+1)}else o.push(n[0]),n.shift();return n.forEach(e=>{o.includes(e)||o.push(e)}),r.forEach(e=>{o.includes(e)||o.push(e)}),o}function mergeKeysWithStatus(e,t){let n=mergeKeys(e,t),r={};for(let o of n)e.includes(o)?t.includes(o)?r[o]=void 0:r[o]="removed":r[o]="added";let o={};e.forEach((e,t)=>{o[e]=t});let i=-1;for(let e of n){let t=o[e];void 0!==t&&(t>i?i=t:r[e]="reordered")}return r}function mergeColumns(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={},r=mergeKeysWithStatus(Object.keys(e),Object.keys(t));return Object.entries(r).forEach(e=>{let[t,r]=e;n[t]={name:t,reordered:"reordered"===r}}),Object.entries(e).map((e,t)=>{let[r,o]=e;n[r].baseIndex=t+1,n[r].baseType=o.type}),Object.entries(t).map((e,t)=>{let[r,o]=e;n[r].currentIndex=t+1,n[r].currentType=o.type}),n}function toDataGrid(e){function columnIndexCellClass(e){return void 0===e.baseIndex?"column-index-added":void 0===e.currentIndex?"column-index-removed":!0===e.reordered?"column-index-reordered":"column-index-normal"}function columnNameCellClass(e){return void 0===e.baseIndex?"column-body-added":void 0===e.currentIndex?"column-body-removed":!0===e.reordered?"column-body-reordered":"column-body-normal"}function columnTypeCellClass(e){return void 0===e.baseIndex?"column-body-added":void 0===e.currentIndex?"column-body-removed":e.baseType!==e.currentType?"column-body-type-changed":!0===e.reordered?"column-body-reordered":"column-body-normal"}let t=Object.values(e);return{columns:[{key:"baseIndex",name:"",resizable:!0,minWidth:35,cellClass:columnIndexCellClass},{key:"currentIndex",name:"",resizable:!0,minWidth:35,cellClass:columnIndexCellClass},{key:"name",name:"Name",resizable:!0,cellClass:columnNameCellClass},{key:"baseType",name:"Base Type",resizable:!0,cellClass:columnTypeCellClass},{key:"currentType",name:"Current Type",resizable:!0,cellClass:columnTypeCellClass}],rows:t}}n(75165),n(91702);var eh=n(93683),em=n(7873),ex=n(52116),ef=n(47367),eg=n(55201),ep=n.n(eg);function useToBlob(e){let{imageType:t="png",boardEffect:n=!0,shadowEffect:r=!1,borderStyle:o="solid 1px #ccc",borderRadius:i="10px",onSuccess:l,onError:a}=e,[s,c]=(0,S.useState)("idle"),d=(0,S.useRef)(null),toImage=async()=>{if(!d.current){console.error("No node to use for screenshot"),c("error"),a&&a(Error("No node to use for screenshot"));return}let e=d.current.element||d.current,s=e.style.overflow,u=e.style.border,h=e.style.borderRadius;function resetStyles(){e.style.overflow=s,e.style.border=u,e.style.borderRadius=h}try{e.style.overflow="hidden",e.style.border=n?o:"",e.style.borderRadius=n?i:"",c("loading");let s=await ep()(e,{backgroundColor:null}),d=r?document.createElement("canvas"):s;if(r){d.width=s.width+80,d.height=s.height+80;let e=d.getContext("2d");if(e)e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=20,e.shadowOffsetX=10,e.shadowOffsetY=10,e.drawImage(s,40,40);else{console.error("Error getting canvas context"),c("error"),a&&a(Error("Error getting canvas context to add shadow effect"));return}}d.toBlob(async e=>{c("success"),l&&e&&await l(e)},"image/".concat(t))}catch(e){console.error("Error converting to image",e),c("error"),a&&a(e);return}finally{resetStyles()}};return{status:s,isLoading:"loading"===s,isErrored:"error"===s,isSuccess:"success"===s,toImage,ref:d}}function useClipBoardToast(){let e=(0,c.p)();return{successToast:function(){e({description:"Copied the query result as an image to clipboard",status:"info",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})},failToast:function(t){e({title:"Failed to copy image to clipboard",description:"".concat(t),status:"error",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})}}}async function copyBlobToClipboard(e){if(!e)throw Error("No blob to copy to clipboard");try{await navigator.clipboard.write([new ClipboardItem({[e.type]:e})])}catch(e){throw console.error("Error copying to clipboard",e),e}}function useCopyToClipboardButton(){let{successToast:e,failToast:t}=useClipBoardToast(),{isLoading:n,toImage:o,ref:i}=useToBlob({imageType:"png",shadowEffect:!0,onSuccess:async n=>{try{await copyBlobToClipboard(n),e()}catch(e){t(e)}},onError:e=>{console.error("Error taking screenshot",e),t(e)}});function CopyToClipboardButton(e){let{imageType:t="png",...l}=e;return(0,r.jsx)(x.z,{size:"sm",leftIcon:(0,r.jsx)(ef.T,{}),style:{position:"absolute",bottom:"16px",right:"16px"},isLoading:n,onMouseEnter:()=>{if(i.current){let e=i.current.element||i.current;e.style.boxShadow="rgba(0, 0, 0, 0.25) 0px 54px 55px, rgba(0, 0, 0, 0.12) 0px -12px 30px, rgba(0, 0, 0, 0.12) 0px 4px 6px, rgba(0, 0, 0, 0.17) 0px 12px 13px, rgba(0, 0, 0, 0.09) 0px -3px 5px",e.style.transition="box-shadow 0.5s ease-in-out"}},onMouseLeave:()=>{if(i.current){let e=i.current.element||i.current;e.style.boxShadow=""}},onClick:async()=>{i.current&&await o()},children:"Copy to Clipboard"})}return{ref:i,CopyToClipboardButton}}function ScreenshotDataGrid(e){let{enableScreenshot:t=!0,...n}=e,{ref:o,CopyToClipboardButton:i}=useCopyToClipboardButton();return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(ex.ZP,{ref:o,...n}),t&&(0,r.jsx)(i,{imageType:"png"})]})}function SchemaView(e){let t,{base:n,current:o,enableScreenshot:i=!1}=e,{columns:l,rows:s}=(0,S.useMemo)(()=>toDataGrid(mergeColumns(null==n?void 0:n.columns,null==o?void 0:o.columns)),[n,o]),c=n&&void 0===n.columns,d=o&&void 0===o.columns;return c&&d?t="catalog.json is missing on both current and base environments.":c?t="catalog.json is missing on base environment.":d&&(t="catalog.json is missing on current environment."),(0,r.jsxs)(a.k,{direction:"column",children:[t&&(0,r.jsxs)(eh.b,{status:"warning",fontSize:"12px",p:"8px",children:[(0,r.jsx)(em.z,{}),t]}),s.length>0&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto",fontSize:"10pt",borderWidth:1},columns:l,rows:s,className:"rdg-light",enableScreenshot:i})})]})}var ey=n(29357);function SqlDiffView(e){let{base:t,current:n}=e;return(0,r.jsx)(ey.SV,{height:"500px",language:"sql",theme:"vs",original:null==t?void 0:t.raw_code,modified:null==n?void 0:n.raw_code,options:{readOnly:!0,fontSize:14,lineNumbers:"on",automaticLayout:!0,minimap:{enabled:!1},wordWrap:"on",wrappingIndent:"same"}})}var ej=n(32865),ev=n(84680);async function createSimpleCheck(){let e=await U.post("/api/checks",{type:"simple"}),t=e.data;return t}async function createCheckByNodeSchema(e){let t=await U.post("/api/checks",{type:"schema_diff",params:{node_id:e}}),n=t.data;return n}async function createCheckByRun(e){let t=await U.post("/api/checks",{run_id:e}),n=t.data;return n}async function listChecks(){let e=await U.get("/api/checks");return e.data}async function getCheck(e){let t=await U.get("/api/checks/".concat(e));return t.data}async function updateCheck(e,t){let n=await U.patch("/api/checks/".concat(e),t);return n.data}async function deleteCheck(e){let t=await U.delete("/api/checks/".concat(e));return t.data}async function reorderChecks(e){return await U.post("/api/checks/reorder",e)}var eC=n(70556);async function submitProfileDiff(e,t){return await submitRun("profile_diff",e,t)}var eb=n(41751),ek=n(83978),ew=n.n(ek);function _getPrimaryKeyValue(e,t){let n={};return n[t]=e[t],JSON.stringify(n)}function toDataDiffGrid(e,t){let n="column_name",r={schema:{fields:[],primaryKey:[]},data:[]};if(!e&&t)e=r;else if(!t&&e)t=r;else if(!e||!t)return{rows:[],columns:[]};let o=[],i={},l={};t.schema.fields.forEach(e=>{i[e.name]={},i[e.name].current=e}),e.schema.fields.forEach(e=>{i[e.name]||(i[e.name]={}),i[e.name].base=e}),Object.keys(i).forEach(e=>{if("index"===e||e===n||"profiled_at"===e)return;let cellClass=t=>{if(!ew().isEqual(t["base__".concat(e)],t["current__".concat(e)]))return"diff-cell-modified"};o.push({name:e,children:[{key:"base__".concat(e),name:"Base",renderEditCell:ex.Ug,cellClass},{key:"current__".concat(e),name:"Current",renderEditCell:ex.Ug,cellClass}]})}),t.data.forEach(e=>{let t=_getPrimaryKeyValue(e,n);l[t]={},l[t].current=e}),e.data.forEach(e=>{let t=_getPrimaryKeyValue(e,n);l[t]||(l[t]={}),l[t].base=e});let a=Object.entries(l).map(e=>{let[t,{base:r,current:o}]=e,i=JSON.parse(t);return r&&Object.keys(r).forEach(e=>{e!==n&&(i["base__".concat(e)]="boolean"==typeof r[e]?r[e].toString():r[e])}),o&&Object.keys(o).forEach(e=>{e!==n&&(i["current__".concat(e)]="boolean"==typeof o[e]?o[e].toString():o[e])}),i});return{columns:[{key:n,name:n,frozen:!0},...o],rows:a}}let ProfileDiffDataGrid=e=>{let{isFetching:t,result:n,error:o,onCancel:i,enableScreenshot:l=!1}=e,[a,s]=(0,S.useState)(!1),c=(0,S.useMemo)(()=>t?{rows:[],columns:[]}:toDataDiffGrid(null==n?void 0:n.base,null==n?void 0:n.current),[n,t]);if(t)return(0,r.jsx)(h.M,{p:"16px",height:"100%",children:(0,r.jsxs)(m.g,{children:[(0,r.jsx)(u.$,{size:"sm",mr:"8px"}),a?(0,r.jsx)(r.Fragment,{children:"Aborting..."}):(0,r.jsx)(r.Fragment,{children:"Loading..."}),!a&&i&&(0,r.jsx)(x.z,{onClick:()=>{s(!0),i&&i()},colorScheme:"blue",size:"sm",children:"Cancel"})]})});if((null==n?void 0:n.base_error)||(null==n?void 0:n.current_error)){if((null==n?void 0:n.base_error)===(null==n?void 0:n.current_error))return(0,r.jsxs)(eh.b,{status:"error",children:[(0,r.jsx)(em.z,{}),"Error: ",null==n?void 0:n.current_error]});{let renderAlert=(e,t)=>(0,r.jsxs)(eh.b,{status:"error",children:[(0,r.jsx)(em.z,{}),e," Environment Error: ",t]});return(0,r.jsxs)(eb.K,{spacing:3,children:[(null==n?void 0:n.base_error)&&renderAlert("Base",n.base_error),(null==n?void 0:n.current_error)&&renderAlert("Current",n.current_error)]})}}return o?(0,r.jsxs)(eh.b,{status:"error",children:[(0,r.jsx)(em.z,{}),"Error: ",null==o?void 0:o.message]}):0===c.columns.length?(0,r.jsx)(h.M,{height:"100%",children:"No data"}):(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto"},columns:c.columns,rows:c.rows,defaultColumnOptions:{resizable:!0,maxWidth:800,minWidth:35},className:"rdg-light",enableScreenshot:l})})},ProfileDiffModal=e=>{let{node:t}=e,n=(0,V.NL)(),{isOpen:o,onOpen:i,onClose:l}=(0,d.q)(),[,a]=(0,ej.TH)(),[s,c]=(0,S.useState)(),profileDiffFn=async e=>{let{run_id:t}=await submitProfileDiff({model:e},{nowait:!0});return c(t),await waitRun(t)},{data:u,mutate:h,error:m,isPending:f}=(0,eC.D)({mutationFn:profileDiffFn}),g=(0,S.useCallback)(async()=>{if(s)return await cancelRun(s)},[s]),b=(0,S.useCallback)(async()=>{if(!(null==u?void 0:u.run_id))return;let e=await createCheckByRun(u.run_id);n.invalidateQueries({queryKey:X.checks()}),a("/checks/".concat(e.check_id))},[null==u?void 0:u.run_id,a,n]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(p.u_,{isOpen:o,onClose:l,size:"6xl",children:[(0,r.jsx)(y.Z,{}),(0,r.jsxs)(j.h,{overflowY:"auto",height:"75%",children:[(0,r.jsx)(eo.x,{children:"Model Profile Diff"}),(0,r.jsx)(v.o,{}),(0,r.jsx)(C.f,{children:(0,r.jsx)(ProfileDiffDataGrid,{isFetching:f,result:null==u?void 0:u.result,error:m,onCancel:g})}),(0,r.jsx)(ev.m,{children:(0,r.jsx)(x.z,{mr:3,colorScheme:"blue",onClick:b,isDisabled:(()=>{let e=null==u?void 0:u.result;return!!m||!e||!!e.base_error||!!e.current_error})(),children:"Add to check"})})]})]}),(0,r.jsx)(x.z,{colorScheme:"blue",size:"sm",onClick:()=>{i(),h(t.name)},children:"Profile Diff"})]})};function ValueDiffResultView(e){let{run:t}=e,n=t.result,o=t.params,cellClass=e=>{let t=e["Matched %"];return t&&t<100?"diff-cell-modified":""};return(0,r.jsxs)(a.k,{direction:"column",gap:"5px",pt:"5px",height:"100%",children:[(0,r.jsxs)(i.xu,{px:"16px",children:["Model: ",o.model,", ",n.summary.total," total (",n.summary.total-n.summary.added-n.summary.removed," ","common, ",n.summary.added," added, ",n.summary.removed," removed)"]}),(0,r.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto",borderBlock:"1px solid lightgray"},columns:[{key:"name",name:"",maxWidth:30,renderCell:e=>{let{row:t}=e;return(0,r.jsx)(h.M,{height:"100%",children:t.Column===o.primary_key&&(0,r.jsx)(s.J,{as:F.MhP})})}},{key:"Column",name:"Column",resizable:!0},{key:"Matched",name:"Matched",resizable:!0,cellClass},{key:"Matched %",name:"Matched %",resizable:!0,renderCell:e=>{let{column:t,row:n}=e,o=n[t.key];return(0,r.jsx)(i.xu,{textAlign:"end",children:o?"".concat(o.toFixed(2)," %"):"N/A"})},cellClass}],rows:n.data.data,defaultColumnOptions:{resizable:!0},className:"rdg-light",enableScreenshot:!0})]})}var eS=n(46016);let RunModal=e=>{let{type:t,title:n,params:o,RunEditView:l,RunResultView:s}=e,[,c]=(0,ej.TH)(),{isOpen:u,onOpen:f,onClose:g}=(0,d.q)(),[b,k]=(0,S.useState)(),[w,_]=(0,S.useState)(o),[R,D]=(0,S.useState)(!1),[N,E]=(0,S.useState)(),submitRunFn=async()=>{let{run_id:e}=await submitRun(t,w,{nowait:!0});for(k(e);;){let t=await waitRun(e,2);if(E(t.progress),t.result||t.error)return t}},{data:z,mutate:F,reset:L,error:T,isPending:q}=(0,eC.D)({mutationFn:submitRunFn,onSuccess:e=>{}}),O=(0,V.NL)(),I=(0,S.useCallback)(async()=>{if(D(!0),b)return await cancelRun(b)},[b]),M=(0,S.useCallback)(()=>{F()},[F]),handleReset=()=>{D(!1),_(o),E(void 0),L()},P=(0,S.useCallback)(async()=>{if(!(null==z?void 0:z.run_id))return;let e=await createCheckByRun(z.run_id);O.invalidateQueries({queryKey:X.checks()}),c("/checks/".concat(e.check_id))},[null==z?void 0:z.run_id,c,O]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(p.u_,{isOpen:u,onClose:()=>{g(),handleReset(),q&&I()},size:"6xl",children:[(0,r.jsx)(y.Z,{}),(0,r.jsxs)(j.h,{overflowY:"auto",height:"75%",children:[(0,r.jsx)(eo.x,{children:n}),(0,r.jsx)(v.o,{}),(0,r.jsx)(C.f,{p:"0px",h:"100%",overflow:"auto",borderY:"1px solid lightgray",children:(0,r.jsx)(()=>{var e,t;let n=(null==T?void 0:null===(t=T.response)||void 0===t?void 0:null===(e=t.data)||void 0===e?void 0:e.detail)||(null==z?void 0:z.error);if(n)return(0,r.jsxs)(eh.b,{status:"error",children:[(0,r.jsx)(em.z,{}),"Error: ",n]});if(q){let e=(null==N?void 0:N.message)?null==N?void 0:N.message:"Loading...";return(0,r.jsx)(h.M,{p:"16px",height:"100%",children:(0,r.jsxs)(m.g,{children:[(0,r.jsxs)(a.k,{alignItems:"center",children:[(null==N?void 0:N.percentage)===void 0||(null==N?void 0:N.percentage)===null?(0,r.jsx)(eS.D,{isIndeterminate:!0,size:"20px",mr:"8px"}):(0,r.jsx)(eS.D,{size:"20px",value:100*N.percentage,mr:"8px"}),R?(0,r.jsx)(r.Fragment,{children:"Aborting..."}):(0,r.jsx)(r.Fragment,{children:e})]}),!R&&(0,r.jsx)(x.z,{onClick:I,colorScheme:"blue",size:"sm",children:"Cancel"})]})})}return z?(0,r.jsx)(i.xu,{h:"100%",style:{contain:"size"},children:(0,r.jsx)(s,{run:z})}):(0,r.jsx)(i.xu,{style:{contain:"size"},children:(0,r.jsx)(l,{params:w,onParamsChanged:_})})},{})}),(0,r.jsx)(ev.m,{children:(0,r.jsxs)(a.k,{gap:"10px",children:[z&&(0,r.jsx)(x.z,{colorScheme:"blue",onClick:handleReset,children:"Reset"}),(null==z?void 0:z.result)&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(x.z,{colorScheme:"blue",onClick:P,children:"Add to checklist"})}),!z&&(0,r.jsx)(x.z,{isDisabled:q,colorScheme:"blue",onClick:M,children:"Execute"})]})})]})]}),(0,r.jsx)(x.z,{colorScheme:"blue",size:"sm",onClick:f,children:n})]})};var e_=n(41171),eR=n(53930),eD=n(68665),eN=n(99691);async function getLineage(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=await U.get("/api/lineage?base=".concat(e));return t.data}async function getLineageWithError(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{let t=await getLineage(e);return{data:t}}catch(e){if(!(e instanceof eN.d7))return{error:null==e?void 0:e.message};{var t,n;let r=null==e?void 0:null===(n=e.response)||void 0===n?void 0:null===(t=n.data)||void 0===t?void 0:t.detail;if(r)return{error:r};return{error:null==e?void 0:e.message}}}}async function getLineageDiff(){let[e,t]=await Promise.all([getLineageWithError(!0),getLineageWithError(!1)]);return{base:e.data,current:t.data,base_error:e.error,current_error:t.error}}var eE=n(21123),ez=n.n(eE);let eF=(0,S.createContext)({});function LineageWatcher(e){let{refetch:t}=e,n=(0,c.p)(),[o,i]=(0,S.useState)(),l=(0,V.NL)();return(0,S.useEffect)(()=>{function httpUrlToWebSocketUrl(e){return e.replace(/(http)(s)?\:\/\//,"ws$2://")}let e=new WebSocket("".concat(httpUrlToWebSocketUrl(W),"/api/ws"));return i(e),e.onopen=()=>{e.send("ping")},e.onmessage=e=>{if("pong"!==e.data)try{let t=JSON.parse(e.data);if("refresh"===t.command){let{eventType:e,srcPath:r}=t.event,[o,i]=r.split("/").slice(-2),a=ez().parse(i).name;n({description:"Detected ".concat(o," ").concat(a," ").concat(e),status:"info",variant:"left-accent",position:"bottom-right",duration:5e3,isClosable:!0}),l.invalidateQueries({queryKey:X.lineage()})}}catch(e){console.error(e)}},()=>{e&&e.close()}},[n,l]),(0,r.jsx)(r.Fragment,{})}function LineageGraphsContextProvider(e){let{children:t}=e,{data:n,isLoading:o,error:i,refetch:l}=(0,ee.a)({queryKey:X.lineage(),queryFn:getLineageDiff}),a=(0,S.useMemo)(()=>{if(n)return buildDefaultLineageGraphSets(n.base,n.current)},[n]),s=(null==i?void 0:i.message)||(null==n?void 0:n.current_error)||(null==n?void 0:n.base_error);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(LineageWatcher,{refetch:l}),(0,r.jsx)(eF.Provider,{value:{lineageGraphSets:a,error:s,isLoading:o},children:t})]})}let useLineageGraphsContext=()=>(0,S.useContext)(eF);function extractColumnNames(e){function getNames(e){return e&&e.columns?Object.values(e.columns).map(e=>e.name):[]}let t=getNames(e.data.base),n=getNames(e.data.current),r=[];return t.forEach(e=>{r.includes(e)||r.push(e)}),n.forEach(e=>{r.includes(e)||r.push(e)}),r}function ValueDiffEditView(e){var t;let{params:n,onParamsChanged:o}=e,l=useLineageGraphsContext(),a=ew().find(null===(t=l.lineageGraphSets)||void 0===t?void 0:t.all.nodes,{name:null==n?void 0:n.model}),s=a?extractColumnNames(a):[];return(0,r.jsx)(i.xu,{m:"16px",children:(0,r.jsxs)(e_.NI,{children:[(0,r.jsx)(eR.l,{children:"Pick a primary key"}),(0,r.jsx)(eD.P,{placeholder:"Select primary key",value:null==n?void 0:n.primary_key,onChange:e=>{let t=e.target.value;o({...n,primary_key:t})},children:s.map(e=>(0,r.jsx)("option",{value:e,children:e},e))})]})})}let ValueDiffModal=e=>{let{node:t}=e;return(0,r.jsx)(RunModal,{title:"Value Diff",type:"value_diff",params:{model:t.name,primary_key:""},RunEditView:ValueDiffEditView,RunResultView:ValueDiffResultView})};function NodeView(e){let{node:t,onCloseNode:n}=e,[,o]=(0,ej.TH)(),{setSqlQuery:l}=useRecceQueryContext(),{fetchFn:s}=useRowCountQueries([t.name]),c="model"===t.resourceType||"seed"===t.resourceType||"source"===t.resourceType,{isOpen:u,onOpen:h,onClose:m}=(0,d.q)(),g=(0,S.useCallback)(async()=>{let e=t.id,n=await createCheckByNodeSchema(e);o("/checks/".concat(n.check_id))},[t,o]),_=(0,S.useCallback)(async()=>{let e=await s(),t=await createCheckByRun(e);o("/checks/".concat(t.check_id))},[o,s]);return(0,r.jsxs)(en.r,{height:"100%",templateRows:"auto auto 1fr",children:[(0,r.jsxs)(f.U,{children:[(0,r.jsx)(i.xu,{flex:"0 1 20%",p:"16px",children:(0,r.jsx)(er.X,{size:"sm",children:t.name})}),(0,r.jsx)(z.L,{}),"modified"===t.changeStatus&&(0,r.jsxs)(i.xu,{children:[(0,r.jsx)(x.z,{onClick:h,leftIcon:(0,r.jsx)(L.tvD,{}),colorScheme:"orange",variant:"solid",children:"Diff"}),(0,r.jsxs)(p.u_,{isOpen:u,onClose:m,size:"6xl",children:[(0,r.jsx)(y.Z,{}),(0,r.jsxs)(j.h,{overflowY:"auto",height:"75%",children:[(0,r.jsx)(eo.x,{children:"Model Raw Code Diff"}),(0,r.jsx)(v.o,{}),(0,r.jsx)(C.f,{children:(0,r.jsx)(SqlDiffView,{base:t.data.base,current:t.data.current})})]})]})]}),(0,r.jsx)(i.xu,{flex:"0 1 1%",p:"16px",children:(0,r.jsx)(ei.P,{onClick:n})})]}),(0,r.jsx)(i.xu,{color:"gray",paddingLeft:"16px",children:(0,r.jsxs)(f.U,{spacing:"8px",children:[(0,r.jsx)(ResourceTypeTag,{node:t}),"model"===t.resourceType&&(0,r.jsx)(RowCountTag,{node:t})]})}),c&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(el.m,{overflow:"auto",as:a.k,children:[(0,r.jsx)(ea.t,{children:(0,r.jsx)(es.O,{children:"Columns"})}),(0,r.jsx)(ec.n,{overflow:"auto",height:"calc(100% - 42px)",children:(0,r.jsx)(ed.x,{p:0,overflowY:"auto",height:"100%",children:(0,r.jsx)(SchemaView,{base:t.data.base,current:t.data.current})})})]}),(0,r.jsxs)(f.U,{p:"16px",children:[(0,r.jsxs)(b.v,{children:[(0,r.jsx)(eu.j,{as:x.z,size:"sm",colorScheme:"blue",children:"Add check"}),(0,r.jsxs)(k.q,{children:[(0,r.jsx)(w.s,{onClick:g,children:"Schema Check"}),(0,r.jsx)(w.s,{onClick:_,children:"Row Count Check"})]})]}),(0,r.jsx)(z.L,{}),"model"===t.resourceType&&(0,r.jsxs)(r.Fragment,{children:["added"!==t.changeStatus&&"removed"!==t.changeStatus&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(ProfileDiffModal,{node:t}),(0,r.jsx)(ValueDiffModal,{node:t},null==t?void 0:t.id)]}),(0,r.jsx)(x.z,{colorScheme:"blue",size:"sm",onClick:()=>{l('select * from {{ ref("'.concat(t.name,'") }}')),o("/query")},children:"Query"})]})]})]})]})}var eL=n(43898),eT=n(17180);let eq={added:["Model Added","Added resource"],removed:["Model Removed","Removed resource"],modified:["Model Modified","Modified resource"],col_added:["Column Added","Added column"],col_removed:["Column Removed","Removed column"],col_changed:["Column Modified","Modified column"],folder_changed:["Modified","Modified folder"]};function ChangeSummary_getIconForChangeStatus(e){if("added"===e)return{color:"#1dce00",icon:q};if("removed"===e)return{color:"#ff067e",icon:O};if("modified"===e)return{color:"#ffa502",icon:I};if("col_added"===e)return{color:"#1dce00",icon:q};if("col_removed"===e)return{color:"#ff067e",icon:O};if("col_changed"===e)return{color:"#ffa502",icon:I};if("folder_changed"===e)return{color:"#ffa502",icon:IconChanged};return{color:"inherit",icon:void 0}}function SummaryText(e){let{name:t,value:n,tip:o}=e;return(0,r.jsxs)(m.g,{alignItems:"stretch",children:[(0,r.jsxs)(g.x,{fontSize:"sm",color:"gray",children:[t,o&&(0,r.jsx)(l.u,{label:o,children:(0,r.jsx)(i.xu,{display:"inline-block",children:(0,r.jsx)(s.J,{mx:"2px",as:A.H33,boxSize:3})})})]}),n]})}function ChangeStatusCountLabel(e){let{changeStatus:t,value:n}=e,[o]=t?eq[t]:[""],{icon:i,color:l}=ChangeSummary_getIconForChangeStatus(t);return(0,r.jsxs)(m.g,{alignItems:"stretch",children:[(0,r.jsxs)(a.k,{alignItems:"center",fontSize:"sm",color:"gray",children:[(0,r.jsx)(s.J,{mr:"5px",as:i,color:l}),o]}),(0,r.jsx)(g.x,{fontSize:"sm",children:n})]})}function calculateColumnChange(e,t){let n=0,r=0,o=0;return(e||t)&&(t&&Object.keys(t.columns||{}).forEach(t=>{(!e||!e.columns||!e.columns[t])&&n++}),e&&Object.keys(e.columns||{}).forEach(e=>{(!t||!t.columns||!t.columns[e])&&r++}),t&&e&&Object.keys(t.columns||{}).forEach(n=>{e.columns&&t.columns&&e.columns[n]&&e.columns[n].type!==t.columns[n].type&&o++})),{adds:n,removes:r,modifies:o}}function calculateChangeSummary(e,t){let n=0,r=0,o=0,i=0,l=0,a=0;return t.forEach(t=>{"added"===e.nodes[t].changeStatus?n++:"removed"===e.nodes[t].changeStatus?r++:"modified"===e.nodes[t].changeStatus&&o++;let s=e.nodes[t].data.base,c=e.nodes[t].data.current,d=calculateColumnChange(s,c);i+=d.adds,l+=d.removes,a+=d.modifies}),{adds:n,removes:r,modifies:o,col_added:i,col_removed:l,col_changed:a}}function ChangeSummary(e){let{lineageGraphSets:t}=e,{adds:n,removes:o,modifies:l,col_added:a,col_removed:s,col_changed:c}=calculateChangeSummary(t.all,t.modifiedSet);return(0,r.jsxs)(en.r,{templateColumns:"1fr 1fr",mb:"10px",borderTop:"1px solid lightgray",padding:"2.5vw",children:[(0,r.jsx)(i.xu,{borderColor:"lightgray",children:(0,r.jsx)(SummaryText,{name:"Code Changes",value:(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(en.r,{templateColumns:"1fr 1fr 1fr",width:"100%",children:[(0,r.jsx)(ChangeStatusCountLabel,{changeStatus:"added",value:n}),(0,r.jsx)(ChangeStatusCountLabel,{changeStatus:"removed",value:o}),(0,r.jsx)(ChangeStatusCountLabel,{changeStatus:"modified",value:l})]})})})}),(0,r.jsx)(i.xu,{borderLeft:"1px",paddingLeft:"12px",borderColor:"lightgray",children:(0,r.jsx)(SummaryText,{name:"Column Changes",value:(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(en.r,{templateColumns:"1fr 1fr 1fr",width:"100%",children:[(0,r.jsx)(ChangeStatusCountLabel,{changeStatus:"col_added",value:a}),(0,r.jsx)(ChangeStatusCountLabel,{changeStatus:"col_removed",value:s}),(0,r.jsx)(ChangeStatusCountLabel,{changeStatus:"col_changed",value:c})]})})})})]})}var eO=n(76353),eI=n(53248),eM=n(9763),eP=n(95853);function SchemaDiffCard(e){let{node:t,...n}=e;return(0,r.jsxs)(eO.Z,{maxWidth:"500px",children:[(0,r.jsxs)(eI.O,{children:[(0,r.jsx)(er.X,{fontSize:18,children:n.title}),(0,r.jsxs)(f.U,{spacing:"8px",p:"16px",children:[(0,r.jsx)(ResourceTypeTag,{node:t}),"model"===t.resourceType&&(0,r.jsx)(RowCountTag,{node:t,isAutoFetching:!0})]})]}),(0,r.jsx)(eM.e,{children:(0,r.jsx)(a.k,{children:(0,r.jsx)(SchemaView,{base:t.data.base,current:t.data.current})})})]})}function listChangedNodes(e){let t=[],n=e.all.nodes;return e.modifiedSet.forEach(e=>{var r,o;let i=n[e],l=mergeKeysWithStatus(Object.keys((null===(r=i.data.base)||void 0===r?void 0:r.columns)||{}),Object.keys((null===(o=i.data.current)||void 0===o?void 0:o.columns)||{})),a=!Object.values(l).every(e=>void 0===e);a&&i.data.base&&i.data.current&&t.push(i)}),t}function SchemaSummary(e){let{lineageGraphSets:t}=e,[n,o]=(0,S.useState)([]);return(0,S.useEffect)(()=>{o(listChangedNodes(t))},[t]),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a.k,{w:"100%",paddingBottom:"10px",marginBottom:"20px",marginTop:"20px",children:(0,r.jsx)(er.X,{fontSize:24,children:"Schema Summary"})}),(0,r.jsx)(a.k,{w:"100%",paddingBottom:"10px",marginBottom:"20px",children:0===n.length?(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(g.x,{fontSize:18,color:"gray",children:"No schema changes detected."})}):(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(eP.M,{minChildWidth:"400px",spacing:"2vw",padding:"2.5vw",width:"100%",backgroundColor:"lightgray",children:n.map(e=>(0,r.jsx)(SchemaDiffCard,{title:e.name,node:e},e.id))})})})]})}function SummaryView(){let{lineageGraphSets:e}=useLineageGraphsContext();return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(a.k,{direction:"column",w:"100%",minHeight:"650px",children:[(0,r.jsx)(a.k,{w:"100%",paddingBottom:"10px",marginBottom:"20px",children:(0,r.jsx)(er.X,{fontSize:24,children:"Change Summary"})}),e&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(ChangeSummary,{lineageGraphSets:e}),(0,r.jsx)(eT.i,{}),(0,r.jsx)(SchemaSummary,{lineageGraphSets:e})]})]})})}var eK=n(45438),eA=n(40312),eB=n(52246),eV=n(25807);function AddSchemaChangesCheckButton(e){let{nodes:t,onFinish:n}=e,[,o]=(0,ej.TH)();return(0,r.jsxs)(x.z,{size:"xs",variant:"outline",isDisabled:0===t.length,onClick:async()=>{let e;1===t.length?e=await createCheckByNodeSchema(t[0].id):await Promise.all(t.map(async e=>{await createCheckByNodeSchema(e.id)})),n(),e?o("/checks/".concat(e.check_id)):o("/checks")},children:[(0,r.jsx)(s.J,{as:B.Edg}),"Add schema check"]})}function AddRowCountCheckButton(e){let{nodes:t,onFinish:n}=e,[,o]=(0,ej.TH)(),{isLoading:i,fetchFn:l}=useRowCountQueries(t.map(e=>e.name));return(0,r.jsxs)(x.z,{size:"xs",variant:"outline",isDisabled:i||0===t.length,onClick:async()=>{let e=await l(),t=await createCheckByRun(e);t?o("/checks/".concat(t.check_id)):o("/checks"),n()},children:[(0,r.jsx)(s.J,{as:A.SwK}),i?"Adding row count check":"Add row count check"]})}function NodeSelector(e){let{nodes:t,isOpen:n,onClose:o}=e;function countSelectedNodes(e){return e.filter(e=>e.isSelected).length}let l=t.filter(e=>e.isSelected);return(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(eA.R,{in:n,style:{zIndex:10},children:(0,r.jsx)(i.xu,{bg:"white",rounded:"md",shadow:"dark-lg",children:(0,r.jsxs)(f.U,{p:"5px 15px",mt:"4",divider:(0,r.jsx)(eB.c,{borderColor:"gray.200"}),spacing:4,children:[(0,r.jsxs)(eV.h,{size:"xs",isAttached:!0,variant:"outline",rounded:"xs",onClick:o,children:[(0,r.jsxs)(x.z,{children:[countSelectedNodes(t)," selected"]}),(0,r.jsx)(K.h,{"aria-label":"Exit select Mode",icon:(0,r.jsx)(eK.D,{})})]}),(0,r.jsxs)(f.U,{children:[(0,r.jsx)(FetchSelectedNodesRowCountButton,{selectedNodes:l.length>0?l:[],onFinish:o}),(0,r.jsx)(AddSchemaChangesCheckButton,{nodes:l.length>0?l:[],onFinish:o}),(0,r.jsx)(AddRowCountCheckButton,{nodes:l.length>0?l:[],onFinish:o})]})]})})})})}let layout=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"LR",r=new(E()).graphlib.Graph;r.setDefaultEdgeLabel(()=>({})),r.setGraph({rankdir:n}),e.forEach(e=>{r.setNode(e.id,{width:300,height:36})}),t.forEach(e=>{r.setEdge(e.source,e.target)}),E().layout(r),e.forEach(e=>{let t=r.node(e.id);return e.position={x:t.x-150,y:t.y-18},e})},eG={customNode:GraphNode},eQ={customEdge:GraphEdge},nodeColor=e=>{var t,n;return(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.changeStatus)?getIconForChangeStatus(null==e?void 0:null===(n=e.data)||void 0===n?void 0:n.changeStatus).color:"lightgray"},eW={all:"All",changed_models:"Changed Models"};function ChangeStatusLegend(){return(0,r.jsx)(i.xu,{bg:"white",padding:"12px",borderWidth:"1px",borderColor:"gray.200",fontSize:"sm",children:Object.entries({added:["Added","Added resource"],removed:["Removed","Removed resource"],modified:["Modified","Modified resource"]}).map(e=>{let[t,[n,o]]=e,{icon:i,color:c}=getIconForChangeStatus(t);return(0,r.jsx)(l.u,{label:o,children:(0,r.jsxs)(a.k,{alignItems:"center",gap:"6px",marginBottom:"2px",children:[(0,r.jsx)(s.J,{color:c,as:i})," ",n]})},t)})})}function _LineageView(){let{getNodes:e}=(0,o._K)(),t=(0,c.p)(),[n,l,N]=(0,o.Rr)([]),[E,z,F]=(0,o.ll)([]),[L,T]=(0,S.useState)(),[q,O]=(0,S.useState)(),{lineageGraphSets:I,isLoading:M,error:P}=useLineageGraphsContext(),{isOpen:K,onOpen:B,onClose:V}=(0,d.q)(),[G,Q]=(0,S.useState)("detail"),[W,H]=(0,S.useState)(),[U,J]=(0,S.useState)("changed_models"),[X,Z]=(0,S.useState)(!1),[Y,$]=(0,S.useState)({x:0,y:0});if((0,S.useEffect)(()=>{if(!I)return;let e="changed_models"===U?I.changed:I.all,t=I.modifiedSet,[n,r]=toReactflow(e,I.modifiedSet);layout(n,r),T(e),O(t),l(n),z(r)},[l,z,U,I]),M)return(0,r.jsx)(a.k,{width:"100%",height:"100%",alignItems:"center",justifyContent:"center",children:(0,r.jsx)(u.$,{size:"xl"})});let closeContextMenu=()=>{Z(!1),$({x:0,y:0})},onCopyImage=async()=>{let n=(0,o.YH)(e()),r=(0,o.lx)(n,1024,768,.1,2),i=document.querySelector(".react-flow__viewport");if(i)try{let e=await (0,eL.SE)(i,{backgroundColor:"#ffffff00",width:1024,height:768,style:{width:"".concat(1024),height:"".concat(768),transform:"translate(".concat(r[0],"px, ").concat(r[1],"px) scale(").concat(r[2],")")}});if(null===e){console.error("Fail to convert react flow to image");return}await navigator.clipboard.write([new ClipboardItem({[e.type]:e})]),t({description:"Copied the Lineage View as an image to clipboard",status:"info",variant:"left-accent",position:"bottom",duration:2e3,isClosable:!0})}catch(e){t({title:"Failed to copy image to clipboard",description:"".concat(e),status:"error",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})}};return P?(0,r.jsxs)(r.Fragment,{children:["Fail to load lineage data: ",P]}):"changed_models"===U&&(void 0===q||(null==q?void 0:q.length)===0)?(0,r.jsx)(h.M,{h:"100%",children:(0,r.jsxs)(m.g,{children:[(0,r.jsx)(r.Fragment,{children:"No change detected"}),(0,r.jsx)(x.z,{colorScheme:"blue",onClick:()=>{J("all")},children:"Show all nodes"})]})}):(0,r.jsxs)(a.k,{width:"100%",height:"100%",children:[(0,r.jsx)(i.xu,{flex:"1 0 0px",children:(0,r.jsxs)(o.x$,{nodeTypes:eG,edgeTypes:eQ,nodes:n,edges:E,onNodesChange:N,onEdgesChange:F,onNodeClick:(e,t)=>{if(closeContextMenu(),"action"===G){let e=selectNode(t.id,n);l(e)}else H(t.id)},onNodeMouseEnter:(e,t)=>{if(L&&void 0!==q){let[e,r]=highlightPath(L,q,n,E,t.id);l(e),z(r)}},onNodeMouseLeave:(e,t)=>{if(L&&void 0!==q){let[e,t]=highlightPath(L,q,n,E,null);l(e),z(t)}},onNodeContextMenu:(e,t)=>{"action"===G&&(e.preventDefault(),$({x:e.clientX,y:e.clientY,selectedNode:t}),Z(!0))},onClick:closeContextMenu,maxZoom:1,minZoom:.1,fitView:!0,children:[(0,r.jsx)(_.A,{color:"#ccc"}),(0,r.jsxs)(R.Z,{showInteractive:!1,position:"top-right",children:[(0,r.jsx)(R.B,{title:"switch mode",onClick:()=>{J("all"===U?"changed_models":"all");let e=cleanUpSelectedNodes(n);l(e)},children:(0,r.jsx)(s.J,{as:A.Bw1})}),(0,r.jsx)(R.B,{title:"copy image",onClick:onCopyImage,children:(0,r.jsx)(s.J,{as:A.C3L})}),(0,r.jsx)(R.B,{title:"summary",onClick:B,children:(0,r.jsx)(s.J,{as:A.SnF})})]}),(0,r.jsx)(o.s_,{position:"bottom-left",children:(0,r.jsxs)(f.U,{children:[(0,r.jsx)(ChangeStatusLegend,{}),(0,r.jsxs)(i.xu,{p:2,flex:"0 1 160px",fontSize:"14px",children:[(0,r.jsx)(g.x,{color:"gray",mb:"2px",children:"Actions"}),(0,r.jsx)(m.g,{spacing:1,align:"baseline",children:(0,r.jsx)(x.z,{size:"xs",variant:"outline",isDisabled:"action"===G,onClick:()=>{let e=cleanUpSelectedNodes(n);l(e),Q("detail"===G?"action":"detail")},children:"Select Models"})})]})]})}),(0,r.jsx)(o.s_,{position:"top-left",children:(0,r.jsx)(g.x,{fontSize:"xl",color:"grey",opacity:.5,children:eW[U]})}),(0,r.jsx)(o.s_,{position:"bottom-center",children:(0,r.jsx)(NodeSelector,{nodes:n.map(e=>e.data),isOpen:"action"===G,onClose:()=>{Q("detail");let e=cleanUpSelectedNodes(n);l(e)}})}),(0,r.jsx)(D.a,{nodeColor:nodeColor,nodeStrokeWidth:3})]})}),(0,r.jsxs)(p.u_,{isOpen:K,onClose:V,size:"6xl",children:[(0,r.jsx)(y.Z,{}),(0,r.jsxs)(j.h,{overflowY:"auto",height:"80%",children:[(0,r.jsx)(v.o,{}),(0,r.jsx)(C.f,{children:(0,r.jsx)(SummaryView,{})})]})]}),"detail"===G&&W&&(null==L?void 0:L.nodes[W])&&(0,r.jsx)(i.xu,{flex:"0 0 500px",borderLeft:"solid 1px lightgray",height:"100%",children:(0,r.jsx)(NodeView,{node:null==L?void 0:L.nodes[W],onCloseNode:()=>{H(void 0)}})}),X&&(0,r.jsx)(b.v,{isOpen:!0,onClose:closeContextMenu,children:(0,r.jsxs)(k.q,{style:{position:"absolute",left:"".concat(Y.x,"px"),top:"".concat(Y.y,"px")},children:[(0,r.jsx)(w.s,{icon:(0,r.jsx)(et.Cv2,{}),onClick:()=>{let e=Y.selectedNode;if("action"!==G||void 0===e||void 0===L)return;let t=e.id,r=selectUpstream(L,[t]),o=selectNodes([...r],n);l(o)},children:"Select parent nodes"}),(0,r.jsx)(w.s,{icon:(0,r.jsx)(et.IMj,{}),onClick:()=>{let e=Y.selectedNode;if("action"!==G||void 0===e||void 0===L)return;let t=e.id,r=selectDownstream(L,[t]),o=selectNodes([...r],n);l(o)},children:"Select child nodes"})]})})]})}function LineageView(){return(0,r.jsx)(o.tV,{children:(0,r.jsx)(_LineageView,{})})}var eH=n(12844),eU=n(98786);function RecceContextProvider(e){let{children:t}=e;return(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(RecceQueryContextProvider,{children:(0,r.jsx)(LineageGraphsContextProvider,{children:(0,r.jsx)(RowCountStateContextProvider,{children:t})})})})}function useVersionNumber(){let[e,t]=(0,S.useState)("");return(0,S.useEffect)(()=>{(async function(){try{let e=await U.get("/api/version");t(e.data)}catch(e){console.error("Error fetching version number:",e)}})()},[]),e}var eJ=n(51348),eX=n(44525),eZ=n(234),eY=n(96094),e$=n(25535),e0=n(36334);function CheckBreadcrumb(e){let{name:t,setName:n}=e,[o,l]=(0,S.useState)(!1),[a,s]=(0,S.useState)(t),c=(0,S.useRef)(null),d=(0,S.useCallback)(()=>{n(a),l(!1)},[n,l,a]);return(0,S.useEffect)(()=>{let handleClickOutside=e=>{c.current&&!c.current.contains(e.target)&&d()};return o&&document.addEventListener("mousedown",handleClickOutside),()=>{document.removeEventListener("mousedown",handleClickOutside)}},[o,c,d]),(0,r.jsxs)(eZ.a,{flex:"0 1",fontSize:"12pt",fontWeight:"500",separator:(0,r.jsx)(e0.X,{color:"gray.500"}),children:[(0,r.jsx)(eY.g,{children:(0,r.jsx)(i.xu,{children:"Checklist"})}),(0,r.jsx)(eY.g,{flex:"0 1",cursor:"pointer",children:o?(0,r.jsx)(e$.I,{ref:c,value:a,onChange:e=>{s(e.target.value)},onKeyDown:e=>{"Enter"===e.key?(n(a),l(!1)):"Escape"===e.key&&(s(t),l(!1))},size:"sm",w:"auto",minW:"200px",maxW:"600px"}):(0,r.jsx)(i.xu,{onClick:()=>{s(t),l(!0)},textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",children:t})})]})}var e1=n(69005),e2=n(14800),e5=n(2600),e3=n(68677),e6=n(83358),query_SqlEditor=e=>{let{value:t,onChange:n,onRun:o,onRunDiff:i,options:l={},...a}=e;return(0,r.jsx)(ey.ZP,{language:"sql",theme:"vs",value:t,onChange:e=>{void 0!==e&&n&&n(e)},onMount:(e,t)=>{o&&e.addCommand(t.KeyMod.CtrlCmd|t.KeyCode.Enter,o),i&&e.addCommand(t.KeyMod.CtrlCmd|t.KeyMod.Shift|t.KeyCode.Enter,i)},options:{tabSize:2,fontSize:16,lineNumbers:"on",automaticLayout:!0,minimap:{enabled:!1},wordWrap:"on",wrappingIndent:"indent",...l}})};function querydiff_getPrimaryKeyValue(e,t){let n={};for(let r of t)n[r]=e[r];return JSON.stringify(n)}function DataFrameColumnGroupHeader(e){let{name:t,primaryKeys:n,onPrimaryKeyChange:o}=e;return"index"===t?(0,r.jsx)(r.Fragment,{}):n.includes(t)?(0,r.jsxs)(a.k,{alignItems:"center",children:[(0,r.jsx)(i.xu,{flex:1,children:t}),o&&(0,r.jsx)(s.J,{cursor:"pointer",as:F.ven,onClick:()=>{let e=n.filter(e=>e!==t);o(e)}})]}):(0,r.jsxs)(a.k,{alignItems:"center",children:[(0,r.jsx)(i.xu,{flex:1,children:t}),o&&(0,r.jsx)(s.J,{cursor:"pointer",as:F.MhP,onClick:()=>{let e=[...n.filter(e=>"index"!==e),t];o(e)}})]})}function querydiff_toDataDiffGrid(e,t,n){let o=(null==n?void 0:n.primaryKeys)||[],i=(null==n?void 0:n.changedOnly)||!1,l={schema:{fields:[],primaryKey:[]},data:[]};if(!e&&t)e=l,0===o.length&&(o=t.schema.primaryKey);else if(!t&&e)t=l,0===o.length&&(o=e.schema.primaryKey);else{if(!e||!t)return{rows:[],columns:[]};if(!ew().isEqual(e.schema.primaryKey,t.schema.primaryKey))throw Error("primary key mismatch! ".concat(e.schema.primaryKey," != ").concat(t.schema.primaryKey));0===o.length&&(o=e.schema.primaryKey)}let a=[],s=[],c=mergeKeysWithStatus(e.schema.fields.map(e=>e.name),t.schema.fields.map(e=>e.name)),d={};e.data.forEach(e=>{d[querydiff_getPrimaryKeyValue(e,o)]=e});let u={};t.data.forEach(e=>{u[querydiff_getPrimaryKeyValue(e,o)]=e});let h=mergeKeysWithStatus(Object.keys(d),Object.keys(u)),m=Object.entries(h).map(e=>{let[t,n]=e,r=d[t],i=u[t],l=JSON.parse(t);if(r&&Object.keys(r).forEach(e=>{o.includes(e)||(l["base__".concat(e)]=r[e])}),i&&Object.keys(i).forEach(e=>{o.includes(e)||(l["current__".concat(e)]=i[e])}),r){if(i)for(let[e,t]of Object.entries(c))!("index"===e||o.includes(e))&&"added"!==t&&"removed"!==t&&(ew().isEqual(r[e],i[e])||(l.status="modified",c[e]="modified"));else l.status="removed"}else l.status="added";return l});return i&&(m=m.filter(e=>"added"===e.status||"removed"===e.status||"modified"===e.status)),Object.entries(c).forEach(e=>{let[t,l]=e;if(o.includes(t))s.push({key:"".concat(t),name:(0,r.jsx)(DataFrameColumnGroupHeader,{name:t,primaryKeys:o,onPrimaryKeyChange:null==n?void 0:n.onPrimaryKeyChange}),frozen:!0,cellClass:e=>"index"===t?"index-column":e.status?"diff-header-".concat(e.status):void 0});else{if("index"===t||i&&"added"!==l&&"removed"!==l&&"modified"!==l)return;let e="added"===l?"diff-header-added":"removed"===l?"diff-header-removed":void 0,cellClass=e=>{let n=e.status;if("removed"===n)return"diff-cell-removed";if("added"===n)return"diff-cell-added";if("added"===l);else if("removed"===l);else if(!ew().isEqual(e["base__".concat(t)],e["current__".concat(t)]))return"diff-cell-modified"};a.push({headerCellClass:e,name:(0,r.jsx)(DataFrameColumnGroupHeader,{name:t,primaryKeys:o,onPrimaryKeyChange:"added"!==l&&"removed"!==l?null==n?void 0:n.onPrimaryKeyChange:void 0}),children:[{key:"base__".concat(t),name:"Base",renderEditCell:ex.Ug,headerCellClass:e,cellClass},{key:"current__".concat(t),name:"Current",renderEditCell:ex.Ug,headerCellClass:e,cellClass}]})}}),{columns:[...s,...a],rows:m}}n(7866);let QueryDiffDataGrid=e=>{var t,n,o,l;let{isFetching:a,run:s,error:c,changedOnly:d,primaryKeys:f,setPrimaryKeys:g,onCancel:p,enableScreenshot:y}=e,[j,v]=(0,S.useState)(!1),C=(0,S.useMemo)(()=>{var e,t;return a?{rows:[],columns:[]}:querydiff_toDataDiffGrid(null==s?void 0:null===(e=s.result)||void 0===e?void 0:e.base,null==s?void 0:null===(t=s.result)||void 0===t?void 0:t.current,{changedOnly:d,primaryKeys:f,onPrimaryKeyChange:g})},[s,a,f,g,d]);if(a)return(0,r.jsx)(h.M,{p:"16px",height:"100%",children:(0,r.jsxs)(m.g,{children:[(0,r.jsxs)(i.xu,{children:[(0,r.jsx)(u.$,{size:"sm",mr:"8px"}),j?(0,r.jsx)(r.Fragment,{children:"Aborting..."}):(0,r.jsx)(r.Fragment,{children:"Loading..."})]}),!j&&p&&(0,r.jsx)(x.z,{onClick:()=>{v(!0),p&&p()},colorScheme:"blue",size:"sm",children:"Cancel"})]})});let b=(null==c?void 0:null===(n=c.response)||void 0===n?void 0:null===(t=n.data)||void 0===t?void 0:t.detail)||(null==c?void 0:c.message)||(null==s?void 0:s.error)||(null==s?void 0:null===(o=s.result)||void 0===o?void 0:o.current_error)||(null==s?void 0:null===(l=s.result)||void 0===l?void 0:l.base_error);return b?(0,r.jsxs)(eh.b,{status:"error",children:[(0,r.jsx)(em.z,{}),"Error: ",b]}):0===C.columns.length?(0,r.jsx)(h.M,{height:"100%",children:"No data"}):d&&0===C.rows.length?(0,r.jsx)(h.M,{height:"100%",children:"No change"}):(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto"},columns:C.columns,rows:C.rows,defaultColumnOptions:{resizable:!0,maxWidth:800,minWidth:35},className:"rdg-light",enableScreenshot:y})})};function QueryDiffView(e){var t,n,o;let{check:l}=e;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e1.U,{defaultIndex:[],allowToggle:!0,children:(0,r.jsxs)(e2.Q,{children:[(0,r.jsxs)(e5.K,{children:["query",(0,r.jsx)(e3.X,{})]}),(0,r.jsx)(e6.H,{children:(0,r.jsx)(i.xu,{height:"400px",width:"100%",border:"lightgray 1px solid ",children:(0,r.jsx)(query_SqlEditor,{value:(null===(t=null==l?void 0:l.params)||void 0===t?void 0:t.sql_template)||"",options:{readOnly:!0}})})})]})}),(0,r.jsx)(i.xu,{flex:"1",style:{contain:"size"},children:(null==l?void 0:l.type)==="query_diff"&&(0,r.jsx)(QueryDiffDataGrid,{run:null==l?void 0:l.last_run,primaryKeys:(null===(n=null==l?void 0:l.params)||void 0===n?void 0:n.primary_keys)||[],changedOnly:(null===(o=null==l?void 0:l.params)||void 0===o?void 0:o.changed_only)||!1})})]})}function SchemaDiffView(e){let{check:t}=e,{lineageGraphSets:n}=useLineageGraphsContext(),o=t.params,i=o.node_id,l=i?null==n?void 0:n.all.nodes[i]:void 0;return l?(0,r.jsx)(SchemaView,{base:l.data.base,current:l.data.current,enableScreenshot:!0}):(0,r.jsx)(r.Fragment,{})}var e4=n(33695),e8=n(34030);function CheckDescription(e){let{value:t,onChange:n}=e,[o,i]=(0,S.useState)(!1),[l,s]=(0,S.useState)();return o?(0,r.jsxs)(a.k,{direction:"column",align:"flex-end",children:[(0,r.jsx)(e4.g,{h:"200px",value:l,onChange:e=>{s(e.target.value)},onKeyDown:e=>{"Escape"===e.key&&i(!1)}}),(0,r.jsxs)(a.k,{gap:"12px",alignItems:"flex-end",children:[(0,r.jsx)(e8.r,{onClick:()=>{setTimeout(()=>{i(!1)},100)},colorScheme:"blue",children:"cancel"}),(0,r.jsx)(x.z,{mt:"8px",size:"sm",colorScheme:"blue",onClick:()=>{n&&(n(l),i(!1))},children:"Update"})]})]}):(0,r.jsx)(g.x,{maxHeight:"400px",overflow:"auto",fontSize:"11pt",onClick:()=>{s(t||""),i(!0)},whiteSpace:"pre-line",color:t?"inherit":"lightgray",children:t||"Add description here"})}function QueryDataGrid_toDataGrid(e){let t=e.schema.fields.map(e=>({key:e.name,name:"index"===e.name?"":e.name,width:"index"===e.name?10:"auto",cellClass:"index"===e.name?"index-column":void 0}));return{columns:t,rows:e.data}}let QueryDataGrid=e=>{var t,n,o,l;let{isFetching:a,run:s,error:c,onCancel:d,enableScreenshot:f}=e,[g,p]=(0,S.useState)(!1),y=null==s?void 0:null===(t=s.result)||void 0===t?void 0:t.result,j=(0,S.useMemo)(()=>a||!y?{rows:[],columns:[]}:QueryDataGrid_toDataGrid(y),[a,y]);if(a)return(0,r.jsx)(h.M,{p:"16px",height:"100%",children:(0,r.jsxs)(m.g,{children:[(0,r.jsxs)(i.xu,{children:[(0,r.jsx)(u.$,{size:"sm",mr:"8px"}),g?(0,r.jsx)(r.Fragment,{children:"Aborting..."}):(0,r.jsx)(r.Fragment,{children:"Loading..."})]}),!g&&d&&(0,r.jsx)(x.z,{onClick:()=>{p(!0),d&&d()},colorScheme:"blue",size:"sm",children:"Cancel"})]})});let v=(null==c?void 0:null===(o=c.response)||void 0===o?void 0:null===(n=o.data)||void 0===n?void 0:n.detail)||(null==s?void 0:s.error)||(null==s?void 0:null===(l=s.result)||void 0===l?void 0:l.error);return v?(0,r.jsxs)(eh.b,{status:"error",children:[(0,r.jsx)(em.z,{}),"Error: ",v]}):0===j.columns.length?(0,r.jsx)(h.M,{height:"100%",children:"No data"}):(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto"},columns:j.columns,rows:j.rows,defaultColumnOptions:{resizable:!0,maxWidth:800,minWidth:35},className:"rdg-light",enableScreenshot:f})})};function QueryView(e){var t;let{check:n}=e;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e1.U,{defaultIndex:[],allowToggle:!0,children:(0,r.jsxs)(e2.Q,{children:[(0,r.jsxs)(e5.K,{children:["query",(0,r.jsx)(e3.X,{})]}),(0,r.jsx)(e6.H,{children:(0,r.jsx)(i.xu,{height:"400px",width:"100%",border:"lightgray 1px solid ",children:(0,r.jsx)(query_SqlEditor,{value:(null===(t=null==n?void 0:n.params)||void 0===t?void 0:t.sql_template)||"",options:{readOnly:!0}})})})]})}),(0,r.jsx)(i.xu,{flex:"1",style:{contain:"size"},children:(null==n?void 0:n.type)==="query"&&(0,r.jsx)(QueryDataGrid,{run:null==n?void 0:n.last_run,enableScreenshot:!0})})]})}function ProfileDiffView(e){var t;let{check:n}=e;return(0,r.jsx)(i.xu,{flex:"1",style:{contain:"size"},children:(0,r.jsx)(ProfileDiffDataGrid,{isFetching:!1,result:null==n?void 0:null===(t=n.last_run)||void 0===t?void 0:t.result,enableScreenshot:!0})})}function RowCountDiffView(e){var t,n;let{check:o}=e;function columnCellClass(e){if(e.base===e.current);else if(e.base<e.current||"N/A"===e.base)return"column-body-added";else if(e.base>e.current||"N/A"===e.current)return"column-body-removed";return"column-body-normal"}let i=Object.keys((null===(t=o.last_run)||void 0===t?void 0:t.result)||{}).map(e=>{var t;let n=null===(t=o.last_run)||void 0===t?void 0:t.result[e],r=(null==n?void 0:n.base)||null,i=(null==n?void 0:n.curr)||null;return{name:e,base:null===r?"N/A":Number(r),current:null===i?"N/A":Number(i)}});return(0,r.jsx)(a.k,{direction:"column",children:Object.keys(null===(n=o.last_run)||void 0===n?void 0:n.result).length>0&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto",fontSize:"10pt",borderWidth:1},columns:[{key:"name",name:"Name",cellClass:columnCellClass},{key:"base",name:"Base Rows",cellClass:columnCellClass},{key:"current",name:"Current Rows",cellClass:columnCellClass}],rows:i,className:"rdg-light",enableScreenshot:!0})})})}let CheckDetail=e=>{let{checkId:t}=e,n=(0,V.NL)(),[,o]=(0,ej.TH)(),{isLoading:l,error:c,data:d}=(0,ee.a)({queryKey:X.check(t),queryFn:()=>getCheck(t),refetchOnMount:!1,staleTime:3e5}),{mutate:u}=(0,eC.D)({mutationFn:e=>updateCheck(t,e),onSuccess:()=>{n.invalidateQueries({queryKey:X.check(t)}),n.invalidateQueries({queryKey:X.checks()})}}),{mutate:m}=(0,eC.D)({mutationFn:()=>deleteCheck(t),onSuccess:()=>{n.invalidateQueries({queryKey:X.checks()}),o("/checks")}});return l?(0,r.jsx)(h.M,{h:"100%",children:"Loading"}):c?(0,r.jsxs)(h.M,{h:"100%",children:["Error: ",c.message]}):(0,r.jsxs)(a.k,{height:"100%",width:"100%",maxHeight:"100%",direction:"column",children:[(0,r.jsxs)(a.k,{p:"0px 16px",alignItems:"center",children:[(0,r.jsx)(CheckBreadcrumb,{name:(null==d?void 0:d.name)||"",setName:e=>{u({name:e})}}),(0,r.jsxs)(b.v,{children:[(0,r.jsx)(eu.j,{as:K.h,icon:(0,r.jsx)(s.J,{as:F.D_A}),variant:"ghost"}),(0,r.jsx)(k.q,{children:(0,r.jsx)(w.s,{icon:(0,r.jsx)(eX.p,{}),onClick:()=>m(),children:"Delete"})})]}),(0,r.jsx)(z.L,{}),(0,r.jsx)(eJ.X,{isChecked:null==d?void 0:d.is_checked,onChange:e=>{let t=e.target.checked;u({is_checked:t})},children:"Check"})]}),(0,r.jsx)(i.xu,{p:"8px 16px",minHeight:"100px",children:(0,r.jsx)(CheckDescription,{value:null==d?void 0:d.description,onChange:e=>{u({description:e})}},null==d?void 0:d.check_id)}),d&&"query"===d.type&&(0,r.jsx)(QueryView,{check:d}),d&&"query_diff"===d.type&&(0,r.jsx)(QueryDiffView,{check:d}),d&&"value_diff"===d.type&&(null==d?void 0:d.last_run)&&(0,r.jsx)(ValueDiffResultView,{run:d.last_run}),d&&"schema_diff"===d.type&&(0,r.jsx)(SchemaDiffView,{check:d}),d&&"profile_diff"===d.type&&(0,r.jsx)(ProfileDiffView,{check:d}),d&&"row_count_diff"===d.type&&(0,r.jsx)(RowCountDiffView,{check:d})]})};var e7=n(99986),e9=n(15012),te=n(38505);let ChecklistItem=e=>{let{check:t,selected:n,onSelect:o}=e,l=(0,V.NL)(),c=t.check_id,{mutate:d}=(0,eC.D)({mutationFn:e=>updateCheck(c,e),onSuccess:()=>{l.invalidateQueries({queryKey:X.check(c)}),l.invalidateQueries({queryKey:X.checks()})}}),u=(e=>{switch(e){case"schema_diff":return e9.uhn;case"query":case"query_diff":return e9.r2i;case"value_diff":return e9.pRi;case"profile_diff":return e9.dku;case"row_count_diff":return A.SwK;default:return e9.WzH}})(t.type);return(0,r.jsxs)(a.k,{width:"100%",p:"10px 20px",cursor:"pointer",_hover:{bg:"gray.200"},bg:n?"gray.100":"inherit",onClick:()=>o(t.check_id),alignItems:"center",gap:"5px",children:[(0,r.jsx)(s.J,{as:u}),(0,r.jsx)(i.xu,{flex:"1",textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",children:t.name}),t.is_checked&&(0,r.jsx)(s.J,{color:"green",as:L.FJM})]})},CheckList=e=>{let{checks:t,selectedItem:n,onCheckSelected:o,onChecksReordered:i}=e;return(0,r.jsx)(te.Z5,{onDragEnd:e=>{e.destination&&i(e.source.index,e.destination.index)},children:(0,r.jsx)(te.bK,{droppableId:"checklist",children:e=>(0,r.jsxs)(m.g,{...e.droppableProps,ref:e.innerRef,w:"full",spacing:"0",flex:"1",children:[t.map((e,t)=>(0,r.jsx)(te._l,{draggableId:e.check_id,index:t,children:t=>(0,r.jsx)(a.k,{ref:t.innerRef,...t.draggableProps,...t.dragHandleProps,w:"full",children:(0,r.jsx)(ChecklistItem,{check:e,selected:e.check_id===n,onSelect:o},e.check_id)})},e.check_id)),e.placeholder]})})})},CheckPage=()=>{let[,e]=(0,ej.TH)(),[,t]=(0,ej.yj)("/checks/:checkId"),n=(0,V.NL)(),{successToast:o,failToast:s}=CheckPage_useClipBoardToast(),c=null==t?void 0:t.checkId,{isLoading:d,error:u,data:g,status:p}=(0,ee.a)({queryKey:X.checks(),queryFn:listChecks,refetchOnMount:!0}),y=(0,S.useCallback)(t=>{e("/checks/".concat(t))},[e]),[j,v]=(0,S.useState)(g||[]),{mutate:C}=(0,eC.D)({mutationFn:e=>reorderChecks(e),onSuccess:()=>{n.invalidateQueries({queryKey:X.checks()})}}),b=(0,S.useCallback)((e,t)=>{let n=[...j],[r]=n.splice(e,1);n.splice(t,0,r),C({source:e,destination:t}),v(n)},[j,v,C]),k=(0,S.useCallback)(async()=>{let e=await createSimpleCheck();n.invalidateQueries({queryKey:X.checks()}),y(e.check_id)},[n,y]);return((0,S.useEffect)(()=>{"success"===p&&(!c&&g.length>0&&e("/checks/".concat(g[0].check_id)),v(g))},[p,c,g,v,e]),d)?(0,r.jsx)(r.Fragment,{children:"Loading"}):u?(0,r.jsxs)(r.Fragment,{children:["Error: ",u.message]}):(null==g?void 0:g.length)?(0,r.jsxs)(a.k,{height:"100%",children:[(0,r.jsx)(i.xu,{flex:"0 0 400px",borderRight:"lightgray solid 1px",height:"100%",style:{contain:"size"},children:(0,r.jsxs)(m.g,{spacing:0,align:"flex-end",h:"100%",children:[(0,r.jsxs)(f.U,{children:[(0,r.jsx)(l.u,{label:"Create a simple check",children:(0,r.jsx)(K.h,{variant:"unstyled","aria-label":"Create a simple check",onClick:k,icon:(0,r.jsx)(e7.d,{})})}),(0,r.jsx)(l.u,{label:"Copy checklist to the clipboard",children:(0,r.jsx)(K.h,{variant:"unstyled","aria-label":"Copy checklist to the clipboard",mr:"10px",onClick:()=>{let e=buildMarkdown(g);if(!navigator.clipboard){s(Error("Copy to clipboard is available only in secure contexts (HTTPS)"));return}navigator.clipboard.writeText(e).then(()=>{o("Copied ".concat(g.length," checks to the clipboard"))}).catch(e=>{s(e)})},icon:(0,r.jsx)(ef.T,{})})})]}),(0,r.jsx)(eT.i,{mb:"8px"}),(0,r.jsx)(CheckList,{checks:j,selectedItem:c,onCheckSelected:y,onChecksReordered:b})]})}),(0,r.jsx)(i.xu,{flex:"1",height:"100%",width:"calc(100% - 400px)",children:(0,r.jsx)(ej.rs,{children:(0,r.jsx)(ej.AW,{path:"/checks/:checkId",children:e=>(0,r.jsx)(CheckDetail,{checkId:e.checkId})})})})]}):(0,r.jsx)(h.M,{h:"100%",children:(0,r.jsxs)(m.g,{children:[(0,r.jsx)(i.xu,{children:"No checks"}),(0,r.jsx)(x.z,{colorScheme:"blue",onClick:k,children:"Create a simple check"})]})})};function buildMarkdown(e){let t=e.map(e=>"<details><summary>".concat(buildTitle(e),"</summary>\n\n").concat(buildDescription(e),"\n\n</details>"));return t.join("\n\n")}function buildTitle(e){return"".concat(e.is_checked?"✅ ":"").concat(e.name)}function buildDescription(e){return e.description?e.description:"_(no description)_"}function CheckPage_useClipBoardToast(){let e=(0,c.p)();return{successToast:function(t){e({description:t,status:"info",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})},failToast:function(t){e({title:"Failed to copy checklist to clipboard",description:"".concat(t),status:"error",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})}}}let QueryPage=()=>{let{sqlQuery:e,setSqlQuery:t}=useRecceQueryContext(),[n,o]=(0,S.useState)([]),[s,c]=(0,S.useState)(),[d,u]=(0,S.useState)(),[h,m]=(0,S.useState)(!1),f=(0,V.NL)(),[,g]=(0,ej.TH)(),queryFn=async t=>{c(t);let{run_id:n}="query"===t?await submitQuery({sql_template:e},{nowait:!0}):await submitQueryDiff({sql_template:e},{nowait:!0});return u(n),await waitRun(n)},{data:p,mutate:y,error:j,isPending:v}=(0,eC.D)({mutationFn:queryFn,onSuccess:e=>{o([]),m(!1)}}),C=(0,S.useCallback)(async()=>{if(d)return await cancelRun(d)},[d]),b=(0,S.useCallback)(async()=>{if(!(null==p?void 0:p.run_id))return;let e=await createCheckByRun(p.run_id);"query_diff"===p.type&&await updateCheck(e.check_id,{params:{...e.params,primary_keys:n,changed_only:h}}),f.invalidateQueries({queryKey:X.checks()}),g("/checks/".concat(e.check_id))},[null==p?void 0:p.run_id,null==p?void 0:p.type,g,n,f,h]),k=!v&&(null==p?void 0:p.run_id)&&!(null==p?void 0:p.error);return(0,r.jsxs)(a.k,{direction:"column",height:"100%",children:[(0,r.jsxs)(a.k,{justifyContent:"right",padding:"5px",gap:"5px",children:[(0,r.jsx)(x.z,{colorScheme:"blue",onClick:()=>y("query_diff"),isDisabled:v,size:"sm",children:"Run Diff"}),(0,r.jsx)(x.z,{colorScheme:"blue",onClick:()=>y("query"),isDisabled:v,size:"sm",children:"Run"})]}),(0,r.jsx)(i.xu,{flex:"1",border:"1px solid #CBD5E0",height:"200px",width:"100%",children:(0,r.jsx)(query_SqlEditor,{value:e,onChange:t,onRun:()=>y("query"),onRunDiff:()=>y("query_diff")})}),(0,r.jsxs)(a.k,{backgroundColor:"rgb(249,249,249)",height:"50vh",direction:"column",children:[k&&(0,r.jsxs)(a.k,{borderBottom:"1px solid lightgray",justifyContent:"flex-end",gap:"5px",children:["query_diff"===s&&(0,r.jsx)(eJ.X,{isChecked:h,onChange:()=>{m(!h)},children:"Changed only"}),(0,r.jsx)(l.u,{label:"Add to Checklist",children:(0,r.jsx)(K.h,{variant:"unstyled",size:"sm","aria-label":"Add",icon:(0,r.jsx)(e7.d,{}),onClick:b})})]}),"query"===s?(0,r.jsx)(QueryDataGrid,{isFetching:v,run:p,error:j,onCancel:C,enableScreenshot:!1},d):(0,r.jsx)(QueryDiffDataGrid,{isFetching:v,run:p,error:j,changedOnly:h,primaryKeys:n,setPrimaryKeys:o,onCancel:C,enableScreenshot:!1},d)]})]})};var tt=n(72952);let hashNavigate=e=>(0,tt.c4)("#!"+e),useHashLocation=()=>{let e=(0,tt.LD)(()=>window.location.hash.replace(/^#!/,"")||"/",()=>"/ssr");return[e,hashNavigate]};var tn=n(12218);function getCookie(e){var t=document.cookie.match("(^|;)\\s*"+e+"\\s*=\\s*([^;]+)");return t?t.pop():""}function NavBar(){let[e,t]=(0,ej.TH)(),n=useVersionNumber(),o=[["Lineage","/lineage"],["Query","/query"],["Checklist","/checks"]],l=ew().findIndex(o,t=>{let[,n]=t;return e.startsWith(n)});return(0,r.jsx)(el.m,{index:l,children:(0,r.jsxs)(ea.t,{children:[o.map(e=>{let[n,o]=e;return(0,r.jsx)(es.O,{onClick:()=>{t(o)},children:n},n)}),(0,r.jsx)(i.xu,{position:"absolute",right:"0",top:"0",p:"2",color:"gray.500",children:n})]})})}function Home(){(0,S.useLayoutEffect)(()=>{let e=getCookie("recce_user_id");if(e&&tn.env.AMPLITUDE_API_KEY)try{eU.S1(tn.env.AMPLITUDE_API_KEY,e,{defaultTracking:!0})}catch(e){console.error(e)}},[]);let e="calc(100vh - 42px)";return(0,r.jsx)(eH.x,{children:(0,r.jsx)(V.aH,{client:J,children:(0,r.jsx)(RecceContextProvider,{children:(0,r.jsxs)(ej.F0,{hook:useHashLocation,children:[(0,r.jsx)(NavBar,{}),(0,r.jsx)(i.xu,{p:0,h:e,maxH:e,overflow:"auto",children:(0,r.jsxs)(ej.rs,{children:[(0,r.jsx)(ej.AW,{path:"/lineage",children:(0,r.jsx)(LineageView,{})}),(0,r.jsx)(ej.AW,{path:"/query",children:(0,r.jsx)(QueryPage,{})}),(0,r.jsx)(ej.AW,{path:"/checks/:slug*",children:(0,r.jsx)(CheckPage,{})}),(0,r.jsx)(ej.AW,{path:"/ssr",children:(0,r.jsx)(r.Fragment,{children:"Loading"})}),(0,r.jsx)(ej.AW,{children:(0,r.jsx)(ej.l_,{to:"/lineage"})})]})})]})})})})}},88727:function(){},7866:function(){},75165:function(){}},function(e){e.O(0,[145,170,521,531,182,710,971,495,599,512,453,297,62,744],function(){return e(e.s=99178)}),_N_E=e.O()}]);