(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{99178:function(e,n,t){Promise.resolve().then(t.bind(t,12275))},12275:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return Home}});var i=t(757),r=t(27869);function getNeighborSet(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,i=new Set,r={},dfs=(e,t)=>{if(t<0||void 0!==r[e]&&r[e]>=t)return;r[e]=t;let l=n(e);for(let e of l)dfs(e,t-1);i.add(e)};for(let n of e)dfs(n,t);return i}function union(){for(var e=arguments.length,n=Array(e),t=0;t<e;t++)n[t]=arguments[t];let i=new Set;return n.forEach(e=>{e.forEach(e=>{i.add(e)})}),i}var l=t(93864),o=t.n(l);function buildLineageGraph(e,n){let t={},i={},buildNode=(e,n)=>({id:e,name:e,data:{},from:n,parents:{},children:{},isSelected:!1});for(let[n,i]of Object.entries(e.parent_map)){t[n]=buildNode(n,"base");let i=e.nodes&&e.nodes[n];i&&(t[n].data.base=i,t[n].name=null==i?void 0:i.name,t[n].resourceType=null==i?void 0:i.resource_type,t[n].packageName=null==i?void 0:i.package_name)}for(let[e,i]of Object.entries(n.parent_map)){t[e]?t[e].from="both":t[e]=buildNode(e,"current");let i=n.nodes&&n.nodes[e];i&&(t[e].data.current=n.nodes&&n.nodes[e],t[e].name=null==i?void 0:i.name,t[e].resourceType=null==i?void 0:i.resource_type,t[e].packageName=null==i?void 0:i.package_name)}for(let[n,r]of Object.entries(e.parent_map))for(let e of r){let r=t[n],l=t[e],o="".concat(e,"_").concat(n);i[o]={id:o,from:"base",parent:l,child:r};let s=i[o];r.parents[e]=s,l.children[n]=s}for(let[e,r]of Object.entries(n.parent_map))for(let n of r){let r=t[e],l=t[n],o="".concat(n,"_").concat(e);i[o]?i[o].from="both":i[o]={id:o,from:"current",parent:l,child:r};let s=i[o];r.parents[n]=s,l.children[e]=s}let r=[];for(let[e,n]of Object.entries(t))if("base"===n.from)n.changeStatus="removed",r.push(n.id);else if("current"===n.from)n.changeStatus="added",r.push(n.id);else{var l,o,s,a,c,d;let e=null==n?void 0:null===(s=n.data)||void 0===s?void 0:null===(o=s.base)||void 0===o?void 0:null===(l=o.checksum)||void 0===l?void 0:l.checksum,t=null==n?void 0:null===(d=n.data)||void 0===d?void 0:null===(c=d.current)||void 0===c?void 0:null===(a=c.checksum)||void 0===a?void 0:a.checksum;e&&t&&e!==t&&(n.changeStatus="modified",r.push(n.id))}for(let[e,n]of Object.entries(i))"base"===n.from?n.changeStatus="removed":"current"===n.from&&(n.changeStatus="added");return{nodes:t,edges:i,modifiedSet:r,manifestMetadata:{base:e.manifest_metadata||void 0,current:n.manifest_metadata||void 0},catalogMetadata:{base:e.catalog_metadata||void 0,current:n.catalog_metadata||void 0}}}function selectUpstream(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return getNeighborSet(n,n=>void 0===e.nodes[n]?[]:Object.keys(e.nodes[n].parents),t)}function selectDownstream(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return getNeighborSet(n,n=>void 0===e.nodes[n]?[]:Object.keys(e.nodes[n].children),t)}function selectViewOptions(e,n){var t;let i=Object.values(e.nodes),r=n.view_mode||"changed_models";if("changed_models"===r){let n=selectUpstream(e,e.modifiedSet,1),t=selectDownstream(e,e.modifiedSet),r=union(n,t);i=i.filter(e=>r.has(e.id))}if(void 0!==n.node_ids){let e=new Set(n.node_ids);i=i.filter(n=>e.has(n.id))}let l=void 0!==n.packages?n.packages:(null===(t=e.manifestMetadata.current)||void 0===t?void 0:t.project_name)?[e.manifestMetadata.current.project_name]:void 0;return void 0!==l&&(i=i.filter(e=>!!e.packageName&&l.includes(e.packageName))),new Set(i.map(e=>e.id))}function toReactflow(e,n){let t=[],i=[];function getWeight(e){return"base"===e?0:"current"===e?2:1}function compareFn(e,n){let t=getWeight(e.from),i=getWeight(n.from);return t<i?-1:t>i?1:0}let l=n?selectViewOptions(e,n):void 0,o=Object.values(e.nodes).sort(compareFn);for(let e of o)(!l||l.has(e.id))&&t.push({id:e.id,position:{x:0,y:0},data:e,type:"customNode",targetPosition:r.Ly.Left,sourcePosition:r.Ly.Right});let s=Object.values(e.edges).sort(compareFn);for(let e of s)(!l||l.has(e.parent.id)&&l.has(e.child.id))&&i.push({id:e.id,type:"customEdge",source:e.parent.id,target:e.child.id,data:e});return layout(t,i),highlightChanged(e,t,i)}let layout=function(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"LR",i=new(o()).graphlib.Graph;i.setDefaultEdgeLabel(()=>({})),i.setGraph({rankdir:t}),e.forEach(e=>{i.setNode(e.id,{width:300,height:36})}),n.forEach(e=>{i.setEdge(e.source,e.target)}),o().layout(i),e.forEach(e=>{let n=i.node(e.id);return e.position={x:n.x-150,y:n.y-18},e})};function highlightNodes(e,n,t){let i=new Set(e),r=new Set(t.filter(e=>i.has(e.source)&&i.has(e.target)).map(e=>e.id)),l=n.map(e=>({...e,data:{...e.data,isHighlighted:i.has(e.id)}})),o=t.map(e=>({...e,data:{...e.data,isHighlighted:r.has(e.id)}}));return[l,o]}function highlightChanged(e,n,t){let i=selectDownstream(e,e.modifiedSet);return highlightNodes(Array.from(i),n,t)}function selectSingleNode(e,n){let t=n.map(n=>{let t=n.id===e;return{...n,data:{...n.data,isSelected:t}}});return t}function selectNode(e,n){let t=n.map(n=>{let t=n.id===e;return{...n,data:{...n.data,isSelected:n.data.isSelected!==t}}});return t}function selectNodes(e,n){let t=n.map(n=>{let t=e.includes(n.id);return{...n,data:{...n.data,isSelected:n.data.isSelected||t}}});return t}function cleanUpNodes(e,n){let t=e.map(e=>({...e,data:{...e.data,isSelected:!1,isActionMode:n,action:void 0}}));return t}var s=t(55528),a=t(46543),c=t(76920),d=t(39668),u=t(10126),h=t(83179),m=t(29330),x=t(62648),p=t(64966),f=t(40312),g=t(36700),v=t(10287),j=t(48950),y=t(27726),C=t(26187),b=t(23704),k=t(33710);t(94570);var w=t(83172),S=t(90593),_=t(11180),R=t(63240),T=t(54057);let D=_.Nbv,I=_.sFB,E=_.UGs;function getIconForChangeStatus(e){return"added"===e?{color:"#1dce00",icon:D}:"removed"===e?{color:"#ff4444",icon:I}:"modified"===e?{color:"#ffa502",icon:E}:{color:"inherit",icon:void 0}}function getIconForResourceType(e){return"model"===e?{color:"#c0eafd",icon:R.Fn3}:"metric"===e?{color:"#ffe6ee",icon:T._MV}:"source"===e?{color:"#a6dda6",icon:R.i1q}:"exposure"===e?{color:"#ffe6ee",icon:T.n8P}:"semantic_model"===e?{color:"#fb8caf",icon:T.R1C}:"seed"===e?{color:"#a6dda6",icon:R.tWi}:{color:"inherit",icon:void 0}}t(88727);var N=t(85036),z=t(49294),M=t(46016),A=t(19920),O=t(19103),L=t(95913),F=t(89042),P=t(10929),V=t(12218);let q=V.env.NEXT_PUBLIC_API_URL?V.env.NEXT_PUBLIC_API_URL:window.location.origin;var B=t(27471);let H=P.Z.create({baseURL:q}),K=new B.S;async function submitRun(e,n,t){let i=await H.post("/api/runs",{type:e,params:n,nowait:null==t?void 0:t.nowait}),r=i.data;return r}async function waitRun(e,n){let t=await H.get("/api/runs/".concat(e,"/wait"),{params:{timeout:n}}),i=t.data;return i}async function cancelRun(e){return await H.post("/api/runs/".concat(e,"/cancel"))}async function submitRunFromCheck(e,n){let t=await H.post("/api/checks/".concat(e,"/run"),{nowait:null==n?void 0:n.nowait}),i=t.data;return i}async function searchRuns(e,n,t){let i=await H.post("/api/runs/search",{type:e,params:n,limit:t});return i.data}async function aggregateRuns(){let e=await H.post("/api/runs/aggregate",{});return e.data}async function submitRowCountDiff(e,n){return await submitRun("row_count_diff",e,n)}async function queryModelRowCount(e){let{result:n}=await queryRowCount([e]);return n[e]}async function queryRowCount(e){if(0===e.length)throw Error("No model names provided");let{run_id:n}=await submitRowCountDiff({node_names:e},{nowait:!0}),t=await waitRun(n);return{runId:n,result:t.result}}let W={rowCount:e=>["row_count",e],lineage:()=>["lineage"],checks:()=>["checks","list"],check:e=>["checks",e],run:e=>["runs",e],runsAggregated:()=>["runs_aggregated"]};var U=t(44903),Q=t(62516),G=t(35537);async function getServerInfo(){let e=await H.get("/api/info");return e.data}async function getModelInfo(e){let n=await H.get("/api/model/".concat(e));return n.data}var J=t(15550),Z=t(21123),X=t.n(Z);let Y=(0,y.createContext)({});function LineageWatcher(e){let{refetch:n}=e,t=(0,J.p)(),[r,l]=(0,y.useState)(),o=(0,G.NL)();return(0,y.useEffect)(()=>{function httpUrlToWebSocketUrl(e){return e.replace(/(http)(s)?\:\/\//,"ws$2://")}let e=new WebSocket("".concat(httpUrlToWebSocketUrl(q),"/api/ws"));return l(e),e.onopen=()=>{e.send("ping")},e.onmessage=e=>{if("pong"!==e.data)try{let n=JSON.parse(e.data);if("refresh"===n.command){let{eventType:e,srcPath:i}=n.event,[r,l]=i.split("/").slice(-2),s=X().parse(l).name;t({description:"Detected ".concat(r," ").concat(s," ").concat(e),status:"info",variant:"left-accent",position:"bottom-right",duration:5e3,isClosable:!0}),o.invalidateQueries({queryKey:W.lineage()})}}catch(e){console.error(e)}},()=>{e&&e.close()}},[t,o]),(0,i.jsx)(i.Fragment,{})}function LineageGraphContextProvider(e){var n,t;let{children:r}=e,{data:l,isLoading:o,error:s,refetch:a}=(0,U.a)({queryKey:W.lineage(),queryFn:getServerInfo}),{data:c,refetch:d}=(0,U.a)({queryKey:W.runsAggregated(),queryFn:aggregateRuns}),u=(0,y.useMemo)(()=>{let e=null==l?void 0:l.lineage;if(e&&e.base&&e.current)return buildLineageGraph(e.base,e.current)},[l]),h=null==s?void 0:s.message,m=null==l?void 0:l.lineage,x=null==l?void 0:l.demo,p=null==l?void 0:l.review_mode,f=null==l?void 0:l.adapter_type,g=null==l?void 0:l.git,v=null==l?void 0:l.pull_request,j=null==m?void 0:null===(n=m.base)||void 0===n?void 0:n.manifest_metadata,C=null==m?void 0:null===(t=m.current)||void 0===t?void 0:t.manifest_metadata,b={adapterType:f,git:g,pullRequest:v,dbt:{base:j,current:C},sqlmesh:null==l?void 0:l.sqlmesh};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(LineageWatcher,{refetch:a}),(0,i.jsx)(Y.Provider,{value:{lineageGraph:u,retchLineageGraph:()=>{a()},envInfo:b,reviewMode:p,isDemoSite:x,error:h,isLoading:o,runsAggregated:c,refetchRunsAggregated:()=>{d()}},children:r})]})}let useLineageGraphContext=()=>(0,y.useContext)(Y),useRunsAggregated=()=>{let{runsAggregated:e,refetchRunsAggregated:n}=useLineageGraphContext();return[e,n]};function deltaPercentageString(e,n){if(e<n){let t=(n-e)/e*100;return"+".concat(t>=.1?t.toFixed(1):" <0.1 ","%")}if(!(e>n))return"0 %";{let t=(e-n)/e*100;return"-".concat(t>=.1?t.toFixed(1):" <0.1 ","%")}}var $=t(79935),ee=t(15012),en=t(41171),et=t(53930),ei=t(68665),er=t(83978),el=t.n(er);function extractColumns(e){function getColumns(e){return e&&e.columns?Object.values(e.columns):[]}let n=getColumns(e.data.base),t=getColumns(e.data.current);return unionColumns(n,t)}function unionColumns(e,n){let t=[];return e.forEach(e=>{t.some(n=>n.name===e.name)||t.push(e)}),n.forEach(e=>{t.some(n=>n.name===e.name)||t.push(e)}),t}var hooks_useModelColumns=e=>{var n;let{lineageGraph:t}=useLineageGraphContext(),[i,r]=(0,y.useState)([]),[l,o]=(0,y.useState)(),[s,a]=(0,y.useState)(!0),[c,d]=(0,y.useState)(null),u=el().find(null==t?void 0:t.nodes,{name:e}),h=(0,y.useMemo)(()=>u?extractColumns(u):[],[u]),m=u?null===(n=u.data.current)||void 0===n?void 0:n.primary_key:void 0;return(0,y.useEffect)(()=>{let fetchData=async()=>{try{let e=await getModelInfo(null==u?void 0:u.id),n=e.model;if(!n||!n.base.columns||!n.current.columns){r([]);return}o(n.current.primary_key);let t=Object.values(n.base.columns),i=Object.values(n.current.columns);r(unionColumns(t,i))}catch(e){d(e)}};h.length>0?(r(h),o(m)):(null==u?void 0:u.id)===void 0?r([]):fetchData(),a(!1)},[null==u?void 0:u.id,h,m]),{columns:i,primaryKey:l,isLoading:s,error:c}};function isStringDataType(e){return["CHAR","VARCHAR","TINYTEXT","TEXT","MEDIUMTEXT","LONGTEXT","NCHAR","NVARCHAR","VARCHAR2","NVARCHAR2","CLOB","NCLOB","VARCHAR(MAX)","XML","JSON","BOOLEAN","TINYINT(1)","BIT","NUMBER(1)","BOOL"].includes(e.toUpperCase())}function isDateTimeType(e){return["DATE","DATETIME","TIMESTAMP","TIME","YEAR","DATETIME2","SMALLDATETIME","DATETIMEOFFSET","INTERVAL","TIMESTAMPTZ","TIMETZ","TIMESTAMP WITH TIME ZONE","TIMESTAMP WITH LOCAL TIME ZONE","TIMESTAMP_LTZ","TIMESTAMP_NTZ","TIMESTAMP_TZ"].includes(e.toUpperCase())}function HistogramDiffForm(e){let{params:n,onParamsChanged:t,setIsReadyToExecute:r}=e,{columns:l,isLoading:o,error:s}=hooks_useModelColumns(n.model),a=l.filter(e=>!isStringDataType(e.type)&&!isDateTimeType(e.type));return o?(0,i.jsx)(u.xu,{children:"Loading..."}):0===a.length||s?(0,i.jsx)(u.xu,{children:"Error: Please provide the 'catalog.json' to list column candidates"}):(0,i.jsx)(u.xu,{m:"16px",children:(0,i.jsxs)(en.NI,{children:[(0,i.jsx)(et.l,{children:"Pick a column to show Histogram Diff"}),(0,i.jsx)(ei.P,{placeholder:"Select column",value:null==n?void 0:n.column_name,onChange:e=>{var i;let l=e.target.value;r(!!l);let o=(null===(i=a.find(e=>e.name===l))||void 0===i?void 0:i.type)||"";t({...n,column_name:l,column_type:o})},children:a.map(e=>(0,i.jsxs)("option",{value:e.name,children:[e.name," : ",e.type]},e.name))})]})})}var eo=t(79315),es=t(85670),ea=t(84021);function formatNumber(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"en-US",t=arguments.length>2?arguments[2]:void 0;return"number"!=typeof e?e:new Intl.NumberFormat(n,t).format(e)}function formatters_formatIntervalMinMax(e){let n=e>0&&e<=.001,t=e<1&&e>=.999,formatter=function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e;return formatNumber(n,"en-US",{style:"percent",minimumFractionDigits:1})};if(n){let e=formatter(.001);return"<".concat(e)}if(t){let e=formatter(.999);return">".concat(e)}return formatter()}function formatters_formatAsAbbreviatedNumber(e){if("number"!=typeof e)return e;{let n=Math.abs(e),t=n>=.01,i=n>=1e6,r=n>=1e9,l=n>=1e15;if(l||n>=1e12)return new Intl.NumberFormat("en-US",{style:"unit",unit:"liter",unitDisplay:"narrow",maximumFractionDigits:l?0:2}).format(e/1e12).replace("L","T");if(r||i||n>=1e3){let n={base:r?1e9:i?1e6:1e3,unit:r?"B":i?"M":"K"};return new Intl.NumberFormat("en-US",{style:"unit",unit:"liter",unitDisplay:"narrow",maximumFractionDigits:1}).format(e/n.base).replace("L",n.unit)}return n>=1?new Intl.NumberFormat("en-US",{maximumFractionDigits:2}).format(e):new Intl.NumberFormat("en-US",{maximumFractionDigits:t?3:2,notation:t||0===n?"standard":"scientific"}).format(e)}}let ec="#63B3ED",ed="#F6AD55",eu="".concat(ec,"A5"),eh="".concat(ed,"A5");function SquareIcon(e){let{color:n}=e;return(0,i.jsx)(u.xu,{display:"inline-block",w:"10px",h:"10px",bgColor:n,mr:"2",borderRadius:"sm"})}function HistogramChart(e){let{data:n,hideAxis:t=!1,animation:r=!1}=e;es.kL.register(es.ZL,es.RM,es.f$,es.uw,es.u);let l=getHistogramChartOptions(n,t,{animation:r}),o=getHistogramChartData(n);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(s.k,{alignItems:"center",direction:"row",children:[(0,i.jsx)(S.L,{}),(0,i.jsxs)(p.x,{as:"h3",size:"sm",p:"2",color:"gray",children:[(0,i.jsx)(SquareIcon,{color:eh})," Base"]}),(0,i.jsxs)(p.x,{as:"h3",size:"sm",p:"2",color:"gray",children:[(0,i.jsx)(SquareIcon,{color:eu})," Current"]}),(0,i.jsx)(S.L,{})]}),(0,i.jsx)(ea.kL,{type:"bar",options:l,data:o,plugins:[]})]})}function getHistogramChartDataset(e,n,t,i,r){let{counts:l=[]}=r,o="datetime"===e?l.map((e,t)=>({x:n[t],y:e})):l;return{label:t,data:o,backgroundColor:i,borderColor:i,hoverBackgroundColor:i,borderWidth:0,categoryPercentage:1,barPercentage:1,xAxisID:"x"}}function getHistogramChartData(e){let{datasets:n,type:t,binEdges:i}=e,[r,l]=n,o=getHistogramChartDataset(t,i,"Current",eu,l),s=getHistogramChartDataset(t,i,"Base",eh,r),a=i.map((e,n)=>formatDisplayedBinItem(i,n)).slice(0,-1);return{labels:a,datasets:[o,s]}}function getHistogramChartOptions(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],{...t}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{datasets:i,type:r,samples:l=0,binEdges:o}=e,[s,a]=i,c="datetime"===r;return{responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{mode:"index",intersect:!1,callbacks:{title(e){let[{dataIndex:n,datasetIndex:t}]=e,i=formatDisplayedBinItem(o,n);return"".concat(c?"Date Range":"string"===r?"Text Length":"Value Range","\n").concat(i)},label(e){let{datasetIndex:n,dataIndex:t,dataset:{label:i}}=e,r=0===n?a.counts:s.counts,o=formatters_formatIntervalMinMax(r[t]/l),c=r[t];return"".concat(i,": ").concat(c," (").concat(o,")")}}}},scales:getScales(e,n),...t}}function getScales(e){let{datasets:n,min:t=0,max:i=0,type:r,binEdges:l}=e,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1],[s,a]=n,c=Math.max(...a.counts,...s.counts),d=l.map((e,n)=>formatDisplayedBinItem(l,n)).slice(0,-1);return{x:"datetime"===r?{display:!o,type:"timeseries",min:t,max:i,adapters:{date:{}},time:{minUnit:"day"},grid:{display:!1},ticks:{minRotation:30,maxRotation:30,maxTicksLimit:8}}:{display:!o,type:"category",grid:{display:!1},ticks:{callback:(e,n)=>d[n]},stacked:!0},y:{display:!o,type:"linear",max:c,border:{dash:[2,2]},grid:{color:"lightgray"},ticks:{maxTicksLimit:8,callback:function(e,n){return formatters_formatAsAbbreviatedNumber(e)}},beginAtZero:!0}}}function formatDisplayedBinItem(e,n){let t=e[n],i=e[n+1],r=formatters_formatAsAbbreviatedNumber(t),l=formatters_formatAsAbbreviatedNumber(i),o="".concat(r," - ").concat(l);return o}var em=t(47367),ex=t(15347),ep=t(7752),ef=t(94410),eg=t(77708),ev=t(58909),ej=t(29985),ey=t(42524),eC=t(17072),eb=t(84680),ek=t(55201),ew=t.n(ek),eS=t(43898);function useClipBoardToast(){let e=(0,J.p)();return{successToast:function(n){e({description:n,status:"info",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})},failToast:function(n,t){e({title:n,description:"".concat(t),status:"error",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})}}}var e_=t(16062),eR=t(68686),eT=t.n(eR);let eD="ignore-screenshot";function useCopyToClipboard(e){let{renderLibrary:n="html2canvas",imageType:t="png",backgroundColor:i=null,boardEffect:r=!0,shadowEffect:l=!1,borderStyle:o="solid 1px #ccc",borderRadius:s="10px",onSuccess:a,onError:c,ignoreElements:d}=e,[u,h]=(0,y.useState)("idle"),m=(0,y.useRef)(null),{onOpen:x,setImgBlob:p,ImageDownloadModal:f}=useImageDownloadModal(),toImage=async()=>{if(!m.current)throw console.error("No node to use for screenshot"),Error("No node to use for screenshot");let e=m.current.element||m.current,t=e.style.overflow,a=e.style.border,c=e.style.borderRadius,u=e.style.backgroundColor,x=e.style.height;function resetStyles(){e.style.overflow=t,e.style.border=a,e.style.borderRadius=c,e.style.backgroundColor=u,e.style.height=x}try{var p;e.style.overflow="hidden",e.style.border=r?o:"",e.style.borderRadius=r?s:"",e.style.backgroundColor=i||"",e.style.height=e.offsetHeight+"px";let t=document.createElement("style");document.head.appendChild(t),null===(p=t.sheet)||void 0===p||p.insertRule("body > div:last-child img { display: inline-block; }");let a=d?e=>!d(e):void 0;h("loading");let c="html2canvas"===n?await ew()(e,{logging:!1,backgroundColor:null,ignoreElements:d}):await (0,eS.rT)(e,{filter:a});t.remove();let u=l?document.createElement("canvas"):c;if(l){u.width=c.width+80,u.height=c.height+80;let e=u.getContext("2d");if(e)e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=20,e.shadowOffsetX=10,e.shadowOffsetY=10,e.drawImage(c,40,40);else throw console.error("Error getting canvas context"),Error("Error getting canvas context to add shadow effect")}let m=await fetch(u.toDataURL());return await m.blob()}catch(e){throw console.error("Error converting to image",e),e}finally{resetStyles()}},copyToClipboard=async()=>{try{await navigator.clipboard.write([new ClipboardItem({["image/".concat(t)]:toImage()})]),h("success"),a&&a()}catch(e){if("ClipboardItem is not defined"===e.message){let e=await toImage();p(e),x(),h("success")}else h("error"),console.error("Error copying to clipboard",e),c&&c(e)}};return{status:u,isLoading:"loading"===u,isErrored:"error"===u,isSuccess:"success"===u,copyToClipboard,ImageDownloadModal:f,ref:m}}function useCopyToClipboardButton(e){let{successToast:n,failToast:t}=useClipBoardToast(),{isLoading:r,copyToClipboard:l,ImageDownloadModal:o,ref:s}=useCopyToClipboard({imageType:"png",shadowEffect:!0,backgroundColor:(null==e?void 0:e.backgroundColor)||null,onSuccess:()=>{n("Copied the query result as an image to clipboard")},onError:e=>{console.error("Error taking screenshot",e),t("Failed to copy image to clipboard",e)}});function CopyToClipboardButton(e){let{imageType:n="png",...t}=e;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(h.z,{size:"sm",leftIcon:(0,i.jsx)(em.T,{}),style:{position:"absolute",bottom:"16px",right:"16px"},isLoading:r,onMouseEnter:()=>{if(s.current){let e=s.current.element||s.current;e.style.boxShadow="rgba(0, 0, 0, 0.25) 0px 54px 55px, rgba(0, 0, 0, 0.12) 0px -12px 30px, rgba(0, 0, 0, 0.12) 0px 4px 6px, rgba(0, 0, 0, 0.17) 0px 12px 13px, rgba(0, 0, 0, 0.09) 0px -3px 5px",e.style.transition="box-shadow 0.5s ease-in-out"}},onMouseLeave:()=>{if(s.current){let e=s.current.element||s.current;e.style.boxShadow=""}},onClick:async()=>{if(s.current){await l();let e=s.current.element||s.current;e.style.boxShadow=""}},children:"Copy to Clipboard"}),(0,i.jsx)(o,{})]})}return{ref:s,CopyToClipboardButton}}function useImageDownloadModal(){let{isOpen:e,onOpen:n,onClose:t}=(0,ex.q)(),[r,l]=(0,y.useState)();return{onOpen:n,setImgBlob:l,ImageDownloadModal:function(){let[n,l]=(0,y.useState)();return(0,y.useEffect)(()=>{if(!r)return;let e=new FileReader;e.readAsDataURL(r),e.onloadend=e=>{var n,t;(null===(n=e.target)||void 0===n?void 0:n.result)&&(null===(t=e.target)||void 0===t?void 0:t.result)!==null&&l(e.target.result)}},[l]),(0,i.jsxs)(ep.u_,{size:"3xl",isOpen:e,onClose:t,children:[(0,i.jsx)(ef.Z,{}),(0,i.jsxs)(eg.h,{children:[(0,i.jsx)(ev.x,{children:"Screenshot Preview"}),(0,i.jsx)(ej.o,{}),(0,i.jsxs)(ey.f,{children:[(0,i.jsxs)(s.k,{px:"10px",gap:"10px",direction:"column",children:[(0,i.jsxs)(s.k,{alignItems:"center",gap:"5px",children:[(0,i.jsx)(N.s,{color:"red.600"}),(0,i.jsx)(p.x,{fontWeight:"500",display:"inline",children:"Copy to the Clipboard"})," ","is not supported in the current browser"]}),(0,i.jsx)(p.x,{children:"Please download it directly"})]}),(0,i.jsx)(eC.E,{src:n,alt:"screenshot"})]}),(0,i.jsxs)(eb.m,{children:[(0,i.jsx)(h.z,{mr:3,onClick:t,children:"Close"}),(0,i.jsx)(h.z,{colorScheme:"blue",onClick:()=>{if(!r)return;let e=new Date,n="recce-screenshot-".concat((0,e_.ZP)(e,"yyyy-MM-dd-HH-mm-ss"),".png");eT()(r,n),t()},children:"Download"})]})]})]})}}}let ScreenshotBox=e=>{let{backgroundColor:n="white",blockSize:t,children:r,...l}=e,{ref:o,CopyToClipboardButton:s}=useCopyToClipboardButton({backgroundColor:n});return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(u.xu,{ref:o,...l,overflowY:"auto",overflowX:"hidden",children:(0,i.jsx)(u.xu,{backgroundColor:n,height:"100%",blockSize:t,children:r})}),(0,i.jsx)(s,{imageType:"png"})]})};function HistogramDiffResultView(e){var n,t,r,l,o,a;let{run:c}=e,d=c.params,h=null===(n=c.result)||void 0===n?void 0:n.base,m=null===(t=c.result)||void 0===t?void 0:t.current,p=null===(r=c.result)||void 0===r?void 0:r.min,f=null===(l=c.result)||void 0===l?void 0:l.max,g=null===(o=c.result)||void 0===o?void 0:o.bin_edges;return h&&m?(0,i.jsx)(s.k,{direction:"column",height:"500px",children:(0,i.jsxs)(ScreenshotBox,{height:"100%",children:[(0,i.jsxs)(eo.X,{as:"h1",size:"md",paddingTop:"4",textAlign:"center",children:["Model ",d.model,".",d.column_name]}),(0,i.jsxs)(x.U,{children:[(0,i.jsx)(S.L,{}),(0,i.jsx)(u.xu,{w:"80%",h:"300px",m:"4",children:(0,i.jsx)(HistogramChart,{data:{type:(null===(a=c.params)||void 0===a?void 0:a.column_type)||"",datasets:[m,h],min:p,max:f,samples:h.total,binEdges:g}})}),(0,i.jsx)(S.L,{})]})]})}):(0,i.jsx)("div",{children:"Loading..."})}t(91702);var eI=t(52116);function ScreenshotDataGrid(e){let{enableScreenshot:n=!0,...t}=e,{ref:r,CopyToClipboardButton:l}=useCopyToClipboardButton();return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(eI.ZP,{ref:r,...t}),n&&(0,i.jsx)(l,{imageType:"png"})]})}function EmptyRowsRenderer(){return(0,i.jsx)(s.k,{h:"35px",alignItems:"center",justifyContent:"center",bg:"gray.100",style:{textAlign:"center",gridColumn:"1/-1"},children:(0,i.jsx)(p.x,{fontWeight:"600",children:" No rows"})})}function mergeKeys(e,n){let t=[...e],i=[...n],r=[];for(;t.length>0&&i.length>0;)if(r.includes(t[0]))t.shift();else if(r.includes(i[0]))i.shift();else if(t[0]===i[0])r.push(t[0]),t.shift(),i.shift();else if(i.includes(t[0])){let e=i.indexOf(t[0]);for(let n=0;n<e;n++)r.includes(i[n])||r.push(i[n]);r.push(t[0]),t.shift(),i.splice(0,e+1)}else r.push(t[0]),t.shift();return t.forEach(e=>{r.includes(e)||r.push(e)}),i.forEach(e=>{r.includes(e)||r.push(e)}),r}function mergeKeysWithStatus(e,n){let t=mergeKeys(e,n),i={};for(let r of t)e.includes(r)?n.includes(r)?i[r]=void 0:i[r]="removed":i[r]="added";let r={};e.forEach((e,n)=>{r[e]=n});let l=-1;for(let e of t){let n=r[e];void 0!==n&&(n>l?l=n:i[e]="reordered")}return i}function _getColumnMap(e,n){let t={},i=mergeKeysWithStatus(e.columns.map(e=>e.name),n.columns.map(e=>e.name));return Object.entries(i).map(i=>{let[r,l]=i;t[r]={status:l,baseColumnIndex:e.columns.findIndex(e=>e.name===r),currentColumnIndex:n.columns.findIndex(e=>e.name===r)}}),t}function _getPrimaryKeyIndexes(e,n){let t=[];for(let i of n){let n=e.findIndex(e=>e.name===i);if(n<0)throw Error("Column ".concat(i," not found"));t.push(n)}return t}function _getPrimaryKeyValue(e,n,t){let i={};if(0===n.length)return JSON.stringify({_index:t._index});for(let r of n){let n=e[r];i[n.name]=t[r]}return JSON.stringify(i)}function DataFrameColumnGroupHeader(e){let{name:n,columnStatus:t,onPrimaryKeyChange:r,onPinnedColumnsChange:l,...o}=e,a=o.primaryKeys||[],c=o.pinnedColumns||[],d=a.includes(n),h=c.includes(n);return"index"===n?(0,i.jsx)(i.Fragment,{}):(0,i.jsxs)(s.k,{alignItems:"center",gap:"10px",className:"grid-header",children:[(0,i.jsx)(u.xu,{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:n}),"added"!==t&&"removed"!==t&&r&&(0,i.jsx)(m.J,{className:d?"close-icon":"key-icon",display:d?"block":"none",cursor:"pointer",as:d?_.ven:_.MhP,onClick:d?()=>{let e=a.filter(e=>e!==n);r&&r(e)}:()=>{let e=[...a.filter(e=>"index"!==e),n];r&&r(e)}}),!d&&l&&(0,i.jsx)(m.J,{className:h?"unpin-icon":"pin-icon",display:h?"block":"none",cursor:"pointer",as:h?_.$kI:_.oJP,onClick:h?()=>{let e=c.filter(e=>e!==n);l&&l(e)}:()=>{let e=[...c,n];l&&l(e)}})]})}t(7866);let defaultRenderCell=e=>{let{row:n,column:t}=e,r=n[t.key];return(0,i.jsx)(i.Fragment,{children:"boolean"==typeof r?r.toString():r})};function toDataDiffGrid(e,n,t){let r=e||{columns:[],data:[]},l=n||{columns:[],data:[]},o=(null==t?void 0:t.primaryKeys)||[],s=(null==t?void 0:t.pinnedColumns)||[],a=(null==t?void 0:t.changedOnly)||!1,c=[],d=_getColumnMap(r,l),u={},h={},m=!1,x=!1;if(0===o.length)r.data.forEach((e,n)=>{e._index=n+1,u[JSON.stringify({_index:n+1})]=e}),l.data.forEach((e,n)=>{e._index=n+1,h[JSON.stringify({_index:n+1})]=e});else{let e=_getPrimaryKeyIndexes(r.columns,o);r.data.forEach((n,t)=>{let i=_getPrimaryKeyValue(r.columns,e,n);i in u&&(m=!0),u[i]=n}),e=_getPrimaryKeyIndexes(l.columns,o),l.data.forEach((n,t)=>{let i=_getPrimaryKeyValue(l.columns,e,n);i in h&&(x=!0),h[i]=n})}let p=mergeKeysWithStatus(Object.keys(u),Object.keys(h)),f=Object.entries(p).map(e=>{let[n,t]=e,i=u[n],s=h[n],a=JSON.parse(n);if(i&&r.columns.forEach((e,n)=>{o.includes(e.name)||(a["base__".concat(e.name)]=i[n])}),s&&l.columns.forEach((e,n)=>{o.includes(e.name)||(a["current__".concat(e.name)]=s[n])}),i){if(s)for(let[e,n]of Object.entries(d))"index"===e||o.includes(e)||n.baseColumnIndex<0||n.currentColumnIndex<0||el().isEqual(i[n.baseColumnIndex],s[n.currentColumnIndex])||(a.status="modified",n.status="modified");else a.status="removed"}else a.status="added";return a});a&&(f=f.filter(e=>"added"===e.status||"removed"===e.status||"modified"===e.status));let toColumn=(e,n)=>{let r="added"===n?"diff-header-added":"removed"===n?"diff-header-removed":void 0,cellClass=t=>{let i=t.status;if("removed"===i)return"diff-cell-removed";if("added"===i)return"diff-cell-added";if("added"===n);else if("removed"===n);else if(!el().isEqual(t["base__".concat(e)],t["current__".concat(e)]))return"diff-cell-modified"};return{headerCellClass:r,name:(0,i.jsx)(DataFrameColumnGroupHeader,{name:e,columnStatus:n,...t}),children:[{key:"base__".concat(e),name:"Base",renderEditCell:eI.Ug,headerCellClass:r,cellClass,renderCell:defaultRenderCell,size:"auto"},{key:"current__".concat(e),name:"Current",renderEditCell:eI.Ug,headerCellClass:r,cellClass,renderCell:defaultRenderCell,size:"auto"}]}};return 0===o.length?c.push({key:"_index",name:"",cellClass:"index-column"}):o.forEach(e=>{let n=d[e].status||"";c.push({key:"".concat(e),name:(0,i.jsx)(DataFrameColumnGroupHeader,{name:e,columnStatus:n,...t}),frozen:!0,cellClass:e=>{if(e.status)return"diff-header-".concat(e.status)}})}),s.forEach(e=>{let n=d[e].status||"";"index"===e||o.includes(e)||c.push(toColumn(e,n))}),Object.entries(d).forEach(e=>{let[n,t]=e,i=t.status||"";"index"===n||o.includes(n)||s.includes(n)||a&&"added"!==i&&"removed"!==i&&"modified"!==i||c.push(toColumn(n,i))}),{columns:c,rows:f,invalidPKeyBase:m,invalidPKeyCurrent:x}}function ProfileDiffResultView(e){var n;let{run:t,viewOptions:r,onViewOptionsChanged:l}=e,o=t.result;t.params;let s=(0,y.useMemo)(()=>(null==r?void 0:r.pinned_columns)||[],[r]),a=((null==o?void 0:null===(n=o.current)||void 0===n?void 0:n.columns)||[]).find(e=>"column_name"===e.name.toLowerCase()),d=(null==a?void 0:a.name)||"column_name",u=(0,y.useMemo)(()=>toDataDiffGrid(null==o?void 0:o.base,null==o?void 0:o.current,{primaryKeys:[d],pinnedColumns:s,onPinnedColumnsChange:e=>{l&&l({...r,pinned_columns:e})}}),[o,d,s,r,l]);return 0===u.columns.length?(0,i.jsx)(c.M,{height:"100%",children:"No data"}):(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto"},columns:u.columns,rows:u.rows,defaultColumnOptions:{resizable:!0,maxWidth:800,minWidth:35},className:"rdg-light",enableScreenshot:!0})})}function valuediff_getColumnMap(e){let n={};return e.columns.map((e,t)=>{n[e.name]={index:t}}),n}function valuediff_getPrimaryKeyIndexes(e,n){let t=[];for(let i of n){let n=e.findIndex(e=>e.name===i);if(n<0)throw Error("Column ".concat(i," not found"));t.push(n)}return t}function valuediff_getPrimaryKeyValue(e,n,t){let i={};if(0===n.length)return JSON.stringify({_index:t._index});for(let r of n){let n=e[r];i[n.name]=t[r]}return JSON.stringify(i)}function valuediff_DataFrameColumnGroupHeader(e){let{name:n,columnStatus:t,onPrimaryKeyChange:r,onPinnedColumnsChange:l,...o}=e,a=o.primaryKeys||[],c=o.pinnedColumns||[],d=a.includes(n),h=c.includes(n);return"index"===n?(0,i.jsx)(i.Fragment,{}):(0,i.jsxs)(s.k,{alignItems:"center",gap:"10px",className:"grid-header",children:[(0,i.jsx)(u.xu,{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:n}),!d&&l&&(0,i.jsx)(m.J,{className:h?"unpin-icon":"pin-icon",display:h?"block":"none",cursor:"pointer",as:h?_.$kI:_.oJP,onClick:h?()=>{let e=c.filter(e=>e!==n);l&&l(e)}:()=>{let e=[...c,n];l&&l(e)}})]})}let valuediff_defaultRenderCell=e=>{let{row:n,column:t}=e,r=n[t.key];return(0,i.jsx)(i.Fragment,{children:"boolean"==typeof r?r.toString():r})};function toValueDiffGrid(e,n,t){let r=(null==t?void 0:t.pinnedColumns)||[],l=(null==t?void 0:t.changedOnly)||!1,o=[],s=valuediff_getColumnMap(e),a={},c={};if(0===n.length)throw Error("Primary keys are required");let d=valuediff_getPrimaryKeyIndexes(e.columns,n),u=(s.in_a||s.IN_A).index,h=(s.in_b||s.IN_B).index;e.data.forEach((n,t)=>{let i=valuediff_getPrimaryKeyValue(e.columns,d,n);n[u]&&(a[i]=n),n[h]&&(c[i]=n)});let m=mergeKeysWithStatus(Object.keys(a),Object.keys(c)),x=Object.entries(m).map(t=>{let[i,r]=t,l=a[i],o=c[i],d=JSON.parse(i);if(l&&e.columns.forEach((e,t)=>{n.includes(e.name)||(d["base__".concat(e.name)]=l[t])}),o&&e.columns.forEach((e,t)=>{n.includes(e.name)||(d["current__".concat(e.name)]=o[t])}),l){if(o)for(let[e,t]of Object.entries(s))!("index"===e||n.includes(e))&&(el().isEqual(l[t.index],o[t.index])||(d.status="modified",t.status="modified"));else d.status="removed"}else d.status="added";return d});l&&(x=x.filter(e=>"added"===e.status||"removed"===e.status||"modified"===e.status));let toColumn=(e,n)=>{let r="added"===n?"diff-header-added":"removed"===n?"diff-header-removed":void 0,cellClass=t=>{let i=t.status;if("removed"===i)return"diff-cell-removed";if("added"===i)return"diff-cell-added";if("added"===n);else if("removed"===n);else if(!el().isEqual(t["base__".concat(e)],t["current__".concat(e)]))return"diff-cell-modified"};return{headerCellClass:r,name:(0,i.jsx)(valuediff_DataFrameColumnGroupHeader,{name:e,columnStatus:n,...t}),children:[{key:"base__".concat(e),name:"Base",renderEditCell:eI.Ug,headerCellClass:r,cellClass,renderCell:valuediff_defaultRenderCell,size:"auto"},{key:"current__".concat(e),name:"Current",renderEditCell:eI.Ug,headerCellClass:r,cellClass,renderCell:valuediff_defaultRenderCell,size:"auto"}]}};return n.forEach(e=>{let n=s[e].status||"";o.push({key:"".concat(e),name:(0,i.jsx)(valuediff_DataFrameColumnGroupHeader,{name:e,columnStatus:n,...t}),frozen:!0,cellClass:e=>{if(e.status)return"diff-header-".concat(e.status)}})}),r.forEach(e=>{let t=s[e].status||"";n.includes(e)||o.push(toColumn(e,t))}),Object.entries(s).forEach(e=>{let[t,i]=e,s=i.status||"";"in_a"===t||"in_b"===t||n.includes(t)||r.includes(t)||l&&"added"!==s&&"removed"!==s&&"modified"!==s||o.push(toColumn(t,s))}),{columns:o,rows:x}}var eE=t(99986),eN=t(51348);let RunToolbar=e=>{let{run:n,warnings:t,viewOptions:r,onAddToChecklist:l,onViewOptionsChanged:o}=e;return(0,i.jsxs)(s.k,{borderBottom:"1px solid lightgray",justifyContent:"flex-end",gap:"5px",alignItems:"center",px:"10px",bg:t&&t.length>0?"orange.100":"inherit",children:[(0,i.jsx)(d.g,{alignItems:"flex-start",spacing:0,children:t&&t.map((e,n)=>(0,i.jsxs)(u.xu,{children:[(0,i.jsx)(z.a,{color:"orange.600"})," ",e]},n))}),(0,i.jsx)(S.L,{minHeight:"32px"}),(0,i.jsx)(eN.X,{isChecked:null==r?void 0:r.changed_only,onChange:()=>{let e=!(null==r?void 0:r.changed_only);o&&o({...r,changed_only:e})},children:"Changed only"}),l&&(0,i.jsx)(w.u,{label:"Add to Checklist",children:(0,i.jsx)(L.h,{variant:"unstyled",size:"sm","aria-label":"Add",icon:(0,i.jsx)(eE.d,{}),onClick:()=>l(n)})})]})},_QueryDiffResultView=e=>{var n,t,r,l,o,a;let{run:d,onAddToChecklist:u,viewOptions:h,onViewOptionsChanged:m}=e,x=(0,y.useMemo)(()=>(null==h?void 0:h.primary_keys)||[],[h]),p=(0,y.useMemo)(()=>(null==h?void 0:h.changed_only)||!1,[h]),f=(0,y.useMemo)(()=>(null==h?void 0:h.pinned_columns)||[],[h]),g=(0,y.useMemo)(()=>{var e,n;return toDataDiffGrid(null==d?void 0:null===(e=d.result)||void 0===e?void 0:e.base,null==d?void 0:null===(n=d.result)||void 0===n?void 0:n.current,{changedOnly:p,primaryKeys:x,onPrimaryKeyChange:e=>{m&&m({...h,primary_keys:e})},pinnedColumns:f,onPinnedColumnsChange:e=>{m&&m({...h,pinned_columns:e})}})},[d,h,p,x,f,m]),v=(0,y.useMemo)(()=>{let e=x.join(", ");return g.invalidPKeyBase&&g.invalidPKeyCurrent?"Warning: The primary key '".concat(e,"' is not unique in the base and current environments"):g.invalidPKeyBase?"Warning: The primary key '".concat(e,"' is not unique in the base environment"):g.invalidPKeyCurrent?"Warning: The primary key '".concat(e,"' is not unique in the current environment"):void 0},[g.invalidPKeyBase,g.invalidPKeyCurrent,x]),j=(null===(t=d.result)||void 0===t?void 0:null===(n=t.current)||void 0===n?void 0:n.limit)||0,C=j>0&&((null==d?void 0:null===(l=d.result)||void 0===l?void 0:null===(r=l.current)||void 0===r?void 0:r.more)||(null==d?void 0:null===(a=d.result)||void 0===a?void 0:null===(o=a.base)||void 0===o?void 0:o.more))?"Warning: Displayed results are limited to ".concat(j.toLocaleString()," records. To ensure complete data retrieval, consider applying a LIMIT or WHERE clause to constrain the result set."):null,b=[];return(v&&b.push(v),C&&b.push(C),0===g.columns.length)?(0,i.jsx)(c.M,{height:"100%",children:"No data"}):p&&0===g.rows.length?(0,i.jsxs)(s.k,{direction:"column",backgroundColor:"rgb(249, 249, 249)",height:"100%",children:[(0,i.jsx)(RunToolbar,{run:d,viewOptions:h,onAddToChecklist:u,onViewOptionsChanged:m,warnings:b}),(0,i.jsx)(c.M,{height:"100%",children:"No change"}),";"]}):(0,i.jsxs)(s.k,{direction:"column",backgroundColor:"rgb(249, 249, 249)",height:"100%",children:[(0,i.jsx)(RunToolbar,{run:d,viewOptions:h,onAddToChecklist:u,onViewOptionsChanged:m,warnings:b}),(0,i.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto"},columns:g.columns,rows:g.rows,renderers:{noRowsFallback:(0,i.jsx)(EmptyRowsRenderer,{})},defaultColumnOptions:{resizable:!0,maxWidth:800,minWidth:35},className:"rdg-light",enableScreenshot:!0})]})},_QueryDiffJoinResultView=e=>{var n,t,r,l;let{run:o,onAddToChecklist:a,viewOptions:d,onViewOptionsChanged:u}=e,h=(0,y.useMemo)(()=>(null==d?void 0:d.changed_only)||!1,[d]),m=(0,y.useMemo)(()=>(null==d?void 0:d.pinned_columns)||[],[d]),x=(0,y.useMemo)(()=>{var e,n;if(!(null===(e=o.result)||void 0===e?void 0:e.diff)||!(null==o?void 0:null===(n=o.params)||void 0===n?void 0:n.primary_keys))return{columns:[],rows:[]};let t=o.params.primary_keys;return toValueDiffGrid(null==o?void 0:o.result.diff,t,{changedOnly:h,pinnedColumns:m,onPinnedColumnsChange:e=>{u&&u({...d,pinned_columns:e})}})},[o,d,h,m,u]),p=(null===(t=o.result)||void 0===t?void 0:null===(n=t.diff)||void 0===n?void 0:n.limit)||0,f=p>0&&(null==o?void 0:null===(l=o.result)||void 0===l?void 0:null===(r=l.diff)||void 0===r?void 0:r.more)?"Warning: Displayed results are limited to ".concat(p.toLocaleString()," records. To ensure complete data retrieval, consider applying a LIMIT or WHERE clause to constrain the result set."):null,g=[];return(f&&g.push(f),0===x.columns.length)?(0,i.jsx)(c.M,{height:"100%",children:"No data"}):h&&0===x.rows.length?(0,i.jsxs)(s.k,{direction:"column",backgroundColor:"rgb(249, 249, 249)",height:"100%",children:[(0,i.jsx)(RunToolbar,{run:o,viewOptions:d,onAddToChecklist:a,onViewOptionsChanged:u,warnings:g}),(0,i.jsx)(c.M,{height:"100%",children:"No change"})]}):(0,i.jsxs)(s.k,{direction:"column",backgroundColor:"rgb(249, 249, 249)",height:"100%",children:[(0,i.jsx)(RunToolbar,{run:o,viewOptions:d,onAddToChecklist:a,onViewOptionsChanged:u,warnings:g}),(0,i.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto"},columns:x.columns,rows:x.rows,renderers:{noRowsFallback:(0,i.jsx)(EmptyRowsRenderer,{})},defaultColumnOptions:{resizable:!0,maxWidth:800,minWidth:35},className:"rdg-light",enableScreenshot:!0})]})},QueryDiffResultView=e=>{var n;return(null===(n=e.run)||void 0===n?void 0:n.result)!==void 0&&null!==e.run.result.diff?(0,i.jsx)(_QueryDiffJoinResultView,{...e}):(0,i.jsx)(_QueryDiffResultView,{...e})};function DataFrameColumnHeader(e){let{name:n,pinnedColumns:t=[],onPinnedColumnsChange:r=()=>{}}=e,l=t.includes(n);return(0,i.jsxs)(s.k,{className:"grid-header",alignItems:"center",children:[(0,i.jsx)(u.xu,{flex:1,children:n}),(0,i.jsx)(m.J,{className:l?"unpin-icon":"pin-icon",display:l?"block":"none",cursor:"pointer",as:l?_.$kI:_.oJP,onClick:l?()=>{let e=t.filter(e=>e!==n);r(e)}:()=>{let e=[...t,n];r(e)}})]})}function toDataGrid(e,n){let t=[],r=n.pinnedColumns||[],toColumn=(e,t)=>({key:String(e),name:(0,i.jsx)(DataFrameColumnHeader,{name:t,...n}),width:"auto",renderCell:defaultRenderCell});return t.push({key:"_index",name:"",width:10,cellClass:"index-column"}),r.forEach(n=>{let i=el().findIndex(e.columns,e=>e.name===n);i<0||t.push(toColumn(i,n))}),e.columns.forEach((e,n)=>{r.includes(e.name)||t.push(toColumn(n,e.name))}),e.data.forEach((e,n)=>{e._index=n+1}),{columns:t,rows:e.data}}let QueryResultView=e=>{let{run:n,viewOptions:t,onViewOptionsChanged:r,onAddToChecklist:l}=e,o=(0,y.useMemo)(()=>(null==t?void 0:t.pinned_columns)||[],[t]),a=null==n?void 0:n.result,d=(0,y.useMemo)(()=>a?toDataGrid(a,{pinnedColumns:o,onPinnedColumnsChange:e=>{r&&r({...t,pinned_columns:e})}}):{rows:[],columns:[]},[a,o,t,r]);if(0===d.columns.length)return(0,i.jsx)(c.M,{height:"100%",children:"No data"});let h=(null==a?void 0:a.limit)||0,m=h>0&&(null==a?void 0:a.more)?"Warning: Displayed results are limited to ".concat(h.toLocaleString()," records. To ensure complete data retrieval, consider applying a LIMIT or WHERE clause to constrain the result set."):null;return(0,i.jsxs)(s.k,{direction:"column",backgroundColor:"rgb(249, 249, 249)",height:"100%",children:[(l||m)&&(0,i.jsxs)(s.k,{borderBottom:"1px solid lightgray",alignItems:"center",gap:"5px",px:"10px",bg:m?"orange.100":"inherit",children:[m&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(z.a,{color:"orange.600",alignSelf:"center"})," ",(0,i.jsx)(u.xu,{children:m})]}),(0,i.jsx)(S.L,{minHeight:"32px"}),l&&(0,i.jsx)(w.u,{label:"Add to Checklist",children:(0,i.jsx)(L.h,{variant:"unstyled",size:"sm","aria-label":"Add",icon:(0,i.jsx)(eE.d,{}),onClick:()=>l(n)})})]}),(0,i.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto"},columns:d.columns,rows:d.rows,renderers:{noRowsFallback:(0,i.jsx)(EmptyRowsRenderer,{})},defaultColumnOptions:{resizable:!0,maxWidth:800,minWidth:35},className:"rdg-light",enableScreenshot:!0})]})};function RowCountDiffResultView(e){let{run:n}=e;function columnCellClass(e){if(e.base===e.current);else if(e.base<e.current||"N/A"===e.base)return"column-body-added";else if(e.base>e.current||"N/A"===e.current)return"column-body-removed";return"column-body-normal"}let t=n.result||{},r=Object.keys(n.result||{}).map(e=>{let n=t[e],i=(null==n?void 0:n.base)||null,r=(null==n?void 0:n.curr)||null,l="No Change";return null!==i&&null!==r?l=i!==r?deltaPercentageString(i,r):"No Change":i===r?l="N/A":null===i?l="Added":null===r&&(l="Removed"),{name:e,base:null===i?"N/A":Number(i),current:null===r?"N/A":Number(r),delta:l}});return(0,i.jsx)(s.k,{direction:"column",children:Object.keys(t).length>0&&(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto",fontSize:"10pt",borderWidth:1},columns:[{key:"name",name:"Name",cellClass:columnCellClass},{key:"base",name:"Base Rows",cellClass:columnCellClass},{key:"current",name:"Current Rows",cellClass:columnCellClass},{key:"delta",name:"Delta",cellClass:columnCellClass}],rows:r,renderers:{noRowsFallback:(0,i.jsx)(EmptyRowsRenderer,{})},className:"rdg-light",enableScreenshot:!0})})})}function TopKDiffForm(e){let{params:n,onParamsChanged:t,setIsReadyToExecute:r}=e,{columns:l,isLoading:o,error:s}=hooks_useModelColumns(n.model),a=l.map(e=>e.name);return((0,y.useEffect)(()=>{r(!!n.column_name)},[n,r]),o)?(0,i.jsx)(u.xu,{children:"Loading..."}):0===a.length||s?(0,i.jsx)(u.xu,{children:"Error: Please provide the 'catalog.json' to list column candidates"}):(0,i.jsx)(u.xu,{m:"16px",children:(0,i.jsxs)(en.NI,{children:[(0,i.jsx)(et.l,{children:"Pick a column to show top-k"}),(0,i.jsx)(ei.P,{placeholder:"Select column",value:null==n?void 0:n.column_name,onChange:e=>{let i=e.target.value;t({...n,column_name:i})},children:a.map(e=>(0,i.jsx)("option",{value:e,children:e},e))})]})})}var ez=t(34030),eM=t(17180);let eA="#63B3ED";function prepareSummaryList(e,n){let t=n?10:e.counts.length,i=e.counts.slice(0,t),r=e.valids-i.reduce((e,n)=>e+n,0),l=e.values.slice(0,t);return l.concat([r]).map((n,t)=>{let l;let o=t===i.length,s=o?r:i[t],a=!1;return o?(l="(others)",a=!0):null==n?(l="(null)",a=!0):"string"==typeof n&&0===n.length?(l="(empty)",a=!0):l=String(n),{isLastItemOthers:o,isSpecialLabel:a,label:l,count:s,displayCount:formatters_formatAsAbbreviatedNumber(s),displayRatio:formatters_formatIntervalMinMax(s/e.valids)||"N/A"}})}function TopKChartTooltip(e){let{base:n,current:t,children:r}=e;return(0,i.jsx)(w.u,{label:(0,i.jsxs)(u.xu,{children:[(0,i.jsxs)(p.x,{children:[(0,i.jsx)(SquareIcon,{color:ec}),"Current: ",t.count," (",t.displayRatio,")"]}),(0,i.jsxs)(p.x,{children:[(0,i.jsx)(SquareIcon,{color:ed}),"Base: ",n.count," (",n.displayRatio,")"]})]}),placement:"auto",hasArrow:!0,children:r})}function TopKSummaryBarChart(e){let{topKDiff:n,isDisplayTopTen:t}=e,r=prepareSummaryList(n.current,t),l=prepareSummaryList(n.base,t);return(0,i.jsxs)(u.xu,{w:"100%",px:20,py:4,children:[(0,i.jsxs)(s.k,{alignItems:"center",direction:"row",children:[(0,i.jsx)(S.L,{}),(0,i.jsxs)(p.x,{as:"h3",size:"sm",p:"2",color:"gray",children:[(0,i.jsx)(SquareIcon,{color:ed})," Base"]}),(0,i.jsxs)(p.x,{as:"h3",size:"sm",p:"2",color:"gray",children:[(0,i.jsx)(SquareIcon,{color:ec})," Current"]}),(0,i.jsx)(S.L,{})]}),r.map((e,t)=>{let r=l[t];return e.isLastItemOthers&&0===e.count&&0===r.count?(0,i.jsx)(i.Fragment,{}):(0,i.jsxs)(y.Fragment,{children:[(0,i.jsx)(TopKChartTooltip,{base:r,current:e,children:(0,i.jsxs)(s.k,{alignItems:"center",width:"100%",_hover:{bg:"blackAlpha.300"},px:4,children:[(0,i.jsx)(p.x,{noOfLines:1,width:"10em",fontSize:"sm",color:e.isSpecialLabel?"gray.400":"inherit",children:e.label}),(0,i.jsxs)(s.k,{width:"70%",direction:"column",children:[(0,i.jsxs)(s.k,{height:"1em",children:[(0,i.jsx)(CategoricalBarChart,{topkCount:e.count,topkLabel:e.label,valids:n.current.valids,color:ec}),(0,i.jsx)(p.x,{ml:5,mr:2,fontSize:"sm",width:"6em",children:e.displayCount}),(0,i.jsx)(p.x,{color:"gray.400",fontSize:"sm",width:"4em",children:e.displayRatio})]}),(0,i.jsxs)(s.k,{height:"1em",children:[(0,i.jsx)(CategoricalBarChart,{topkCount:r.count,topkLabel:r.label,valids:n.base.valids,color:ed}),(0,i.jsx)(p.x,{ml:5,mr:2,fontSize:"sm",width:"6em",children:r.displayCount}),(0,i.jsx)(p.x,{color:"gray.400",fontSize:"sm",width:"4em",children:r.displayRatio})]})]})]})}),(0,i.jsx)(eM.i,{})]},t)})]})}function CategoricalBarChart(e){let{topkCount:n,topkLabel:t,valids:r,animation:l=!1,color:o=eA}=e;es.kL.register(es.uw,es.ZL,es.f$);let s=getCatBarChartOptions(n,r,{animation:l}),a=getCatBarChartData({topkCount:n,topkLabel:t,color:o});return(0,i.jsx)(ea.$Q,{data:a,options:s,plugins:[]})}function getCatBarChartOptions(e,n){let{...t}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{display:!1,max:n,grid:{display:!1}},y:{display:!1}},plugins:{tooltip:{enabled:!1}},...t}}function getCatBarChartData(e){let{topkLabel:n,topkCount:t,color:i=eA}=e;return{labels:[n],datasets:[{indexAxis:"y",data:[t],backgroundColor:i,hoverBackgroundColor:i,borderWidth:0,borderColor:i,barPercentage:1,categoryPercentage:.6}]}}function TopKDiffResultView(e){let{run:n}=e,[t,r]=(0,y.useState)(!0),l=n.result,o=n.params,a=l.base,c=l.current;return(0,i.jsxs)(s.k,{direction:"column",height:"100%",children:[(0,i.jsxs)(ScreenshotBox,{blockSize:"auto",children:[(0,i.jsxs)(eo.X,{as:"h1",size:"md",paddingTop:4,textAlign:"center",children:["Model ",o.model,".",o.column_name]}),(0,i.jsxs)(x.U,{children:[(0,i.jsx)(S.L,{}),(0,i.jsx)(TopKSummaryBarChart,{topKDiff:l,valids:c.valids||0,isDisplayTopTen:t}),(0,i.jsx)(S.L,{})]})]}),(0,i.jsx)(S.L,{}),(a.values.length>10||c.values.length>10)&&(0,i.jsx)(s.k,{p:5,justify:"start",children:(0,i.jsx)(ez.r,{onClick:()=>r(e=>!e),textColor:"blue.500",children:t?"View More Items":"View Only Top-10"})})]})}var eO=t(25535),eL=t(11546);function ValueDiffForm(e){let{params:n,onParamsChanged:t,setIsReadyToExecute:r}=e,[l,o]=(0,y.useState)(!n.columns||0===n.columns.length),s=null==n?void 0:n.model,a=null==n?void 0:n.primary_key,{columns:c,primaryKey:h,isLoading:m,error:x}=hooks_useModelColumns(n.model);(0,y.useEffect)(()=>{!a&&h&&t({...n,primary_key:h})},[a,h,n,t]),(0,y.useEffect)(()=>{r(!!a&&!!s)},[a,s,r]);let p=c.map(e=>e.name),f=Array.isArray(a)?a:a?[a]:void 0;return m?(0,i.jsx)(u.xu,{children:"Loading..."}):0===p.length||x?(0,i.jsx)(u.xu,{children:"Error: Please provide the 'catalog.json' to list column candidates"}):(0,i.jsxs)(d.g,{gap:5,m:"8px 24px",paddingBottom:"200px",children:[(0,i.jsxs)(en.NI,{children:[(0,i.jsx)(et.l,{children:"Model"}),(0,i.jsx)(eO.I,{isReadOnly:!0,value:null==n?void 0:n.model})]}),(0,i.jsxs)(en.NI,{children:[(0,i.jsx)(et.l,{children:"Primary key"}),(0,i.jsx)(eL.Z,{placeholder:"Select primary key",isMulti:!0,closeMenuOnSelect:!1,options:(p||[]).map(e=>({label:e,value:e})),value:(f||[]).map(e=>({label:e,value:e})),onChange:e=>{t({...n,primary_key:1==e.length?e[0].value:e.map(e=>e.value)})}})]}),(0,i.jsxs)(en.NI,{children:[(0,i.jsx)(et.l,{children:"Columns"}),(0,i.jsx)(eN.X,{marginBottom:"10px",isChecked:l,onChange:e=>{o(e.target.checked),t({...n,columns:void 0})},children:"All columns"}),!l&&(0,i.jsx)(eL.Z,{isMulti:!0,closeMenuOnSelect:!1,options:(p||[]).map(e=>({label:e,value:e})),value:(n.columns||[]).map(e=>({label:e,value:e})),onChange:e=>{t({...n,columns:(e||[]).map(e=>e.value)})}})]})]})}var eF=t(18974),eP=t(78448),eV=t(93573);async function createSimpleCheck(){let e=await H.post("/api/checks",{type:"simple"}),n=e.data;return n}async function createCheckByNodeSchema(e){let n=await H.post("/api/checks",{type:"schema_diff",params:{node_id:e}}),t=n.data;return t}async function createCheckByRun(e,n){let t=await H.post("/api/checks",{run_id:e,view_options:n}),i=t.data;return i}async function listChecks(){let e=await H.get("/api/checks");return e.data}async function getCheck(e){let n=await H.get("/api/checks/".concat(e));return n.data}async function updateCheck(e,n){let t=await H.patch("/api/checks/".concat(e),n);return t.data}async function deleteCheck(e){let n=await H.delete("/api/checks/".concat(e));return n.data}async function reorderChecks(e){return await H.post("/api/checks/reorder",e)}var eq=t(70556),eB=t(32865),eH=t(93683),eK=t(7873);let RunView=e=>{var n,t;let{isPending:r,isAborting:l,isCheckDetail:o,progress:a,error:m,run:x,onCancel:p,viewOptions:f,onViewOptionsChanged:g,RunResultView:v,children:j,onExecuteRun:y}=e,C=(null==m?void 0:null===(t=m.response)||void 0===t?void 0:null===(n=t.data)||void 0===n?void 0:n.detail)||(null==x?void 0:x.error);if(C)return(0,i.jsxs)(eH.b,{status:"error",children:[(0,i.jsx)(eK.z,{}),"Error: ",C]});if(r){let e=(null==a?void 0:a.message)?null==a?void 0:a.message:"Loading...";return(0,i.jsx)(c.M,{p:"16px",height:"100%",bg:"rgb(249,249,249)",children:(0,i.jsxs)(d.g,{children:[(0,i.jsxs)(s.k,{alignItems:"center",children:[(null==a?void 0:a.percentage)===void 0||(null==a?void 0:a.percentage)===null?(0,i.jsx)(M.D,{isIndeterminate:!0,size:"20px",mr:"8px"}):(0,i.jsx)(M.D,{size:"20px",value:100*a.percentage,mr:"8px"}),l?(0,i.jsx)(i.Fragment,{children:"Aborting..."}):(0,i.jsx)(i.Fragment,{children:e})]}),!l&&(0,i.jsx)(h.z,{onClick:p,colorScheme:"blue",size:"sm",children:"Cancel"})]})})}if(!x)return o?(0,i.jsx)(c.M,{bg:"rgb(249,249,249)",height:"100%",children:(0,i.jsx)(h.z,{onClick:y,colorScheme:"blue",size:"sm",children:"Run Query"})}):(0,i.jsx)(c.M,{bg:"rgb(249,249,249)",height:"100%",children:"No Data"});if(j&&v)throw Error("RunView requires either a children or a RunResultView prop, but not both.");if(!j&&!v)throw Error("RunView requires at least one of children or RunResultView prop.");return(0,i.jsxs)(u.xu,{h:"100%",style:{contain:"size layout"},overflow:"auto",children:[v&&(0,i.jsx)(v,{run:x,viewOptions:f,onViewOptionsChanged:g}),j&&j({run:x,viewOptions:f,onViewOptionsChanged:g})]})};var eW=t(48689);let RunModal=e=>{let{isOpen:n,onClose:t,type:r,title:l,params:o,initialRun:a,RunForm:c,RunResultView:d}=e,[,m]=(0,eB.TH)(),[x,p]=(0,y.useState)(),[f,g]=(0,y.useState)(o),[v,j]=(0,y.useState)(!1),[C,b]=(0,y.useState)(!1),[k,w]=(0,y.useState)(),[S,_]=(0,y.useState)(),[R,T]=(0,y.useState)(a),submitRunFn=async()=>{let{run_id:e}=await submitRun(r,f,{nowait:!0});for(p(e);;){let n=await waitRun(e,2);if(w(n.progress),n.result||n.error)return j(!1),w(void 0),n}},{data:D,mutate:I,reset:E,error:N,isPending:z}=(0,eq.D)({mutationFn:submitRunFn});(0,y.useEffect)(()=>{n&&void 0===c&&void 0===R&&I()},[n]);let M=(0,G.NL)(),A=(0,y.useCallback)(async()=>{if(j(!0),x)return await cancelRun(x)},[x]),O=(0,y.useCallback)(()=>{I()},[I]),L=(0,y.useCallback)(()=>{I(),T(void 0)},[I]),handleReset=()=>{j(!1),g(o),w(void 0),T(void 0),E()},F=(0,y.useCallback)(async()=>{let e=R?R.run_id:null==D?void 0:D.run_id;if(void 0===e)return;let n=await createCheckByRun(e,S);M.invalidateQueries({queryKey:W.checks()}),m("/checks/".concat(n.check_id))},[null==D?void 0:D.run_id,R,m,M,S]),handleClose=async()=>{t(),z&&x&&await cancelRun(x),handleReset()},P=!!(null==R?void 0:R.result)||!!(null==D?void 0:D.result),V=!!(null==R?void 0:R.error)||!!(null==D?void 0:D.error)||!!N,q=(null==R?void 0:R.run_at)?(0,eW.Z)(new Date(R.run_at),{addSuffix:!0}):null;return(0,i.jsxs)(ep.u_,{isOpen:n,onClose:handleClose,size:"6xl",scrollBehavior:"inside",children:[(0,i.jsx)(ef.Z,{}),(0,i.jsxs)(eg.h,{overflowY:"auto",height:"75%",children:[(0,i.jsxs)(ev.x,{children:[l,!D&&!z&&q&&(0,i.jsx)(u.xu,{textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",fontSize:"10pt",children:q})]}),(0,i.jsx)(ej.o,{}),(0,i.jsx)(ey.f,{p:"0px",h:"100%",overflow:"auto",borderY:"1px solid lightgray",children:z||D||N||R?(0,i.jsx)(RunView,{isPending:z,isAborting:v,run:R||D,error:N,progress:k,onCancel:A,viewOptions:S,onViewOptionsChanged:_,RunResultView:d}):(0,i.jsx)(u.xu,{style:{contain:"layout"},children:c&&(0,i.jsx)(c,{params:f,onParamsChanged:g,setIsReadyToExecute:b})})}),(0,i.jsx)(eb.m,{children:(0,i.jsxs)(s.k,{gap:"10px",children:[(P||V)&&c&&(0,i.jsx)(h.z,{colorScheme:"blue",onClick:handleReset,children:"Reset"}),P&&(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(h.z,{colorScheme:"blue",onClick:F,children:"Add to checklist"})}),z&&(0,i.jsx)(h.z,{onClick:A,isDisabled:v,colorScheme:"blue",children:"Cancel"}),!P&&!V&&!z&&(0,i.jsx)(h.z,{isDisabled:z||!C,colorScheme:"blue",onClick:O,children:"Execute"}),P&&!c&&(0,i.jsx)(h.z,{colorScheme:"blue",onClick:L,children:"Rerun"})]})})]})]})},eU=(0,y.createContext)({runAction:()=>{}}),useCloseModalEffect=e=>{let[n]=(0,eB.TH)();(0,y.useEffect)(()=>{e()},[e,n])};function _ActionModal(e){var n;let{action:t,isOpen:r,onClose:l}=e,o=findByRunType(t.type);if(void 0===o)throw Error("Unknown run type: ".concat(t.type));let{title:s,RunResultView:a,RunForm:c}=o;if(void 0===a)throw Error("Run type ".concat(t.type," does not have a result view"));return(0,i.jsx)(RunModal,{isOpen:r,onClose:l,title:s,type:t.type,params:t.params,initialRun:t.lastRun,RunResultView:a,RunForm:(null===(n=t.options)||void 0===n?void 0:n.showForm)&&c?c:void 0},t.session)}function RecceActionContextProvider(e){let{children:n}=e,[t,r]=(0,y.useState)(),{isOpen:l,onOpen:o,onClose:s}=(0,ex.q)(),a=(0,y.useCallback)(async(e,n,t)=>{let i;let l=new Date().getTime().toString();if(null==t?void 0:t.showLast){let t=await searchRuns(e,n,1);1===t.length&&(i=t[0])}r({session:l,type:e,params:n,lastRun:i,options:t}),o()},[r,o]);return useCloseModalEffect(s),(0,i.jsxs)(eU.Provider,{value:{runAction:a},children:[t&&(0,i.jsx)(_ActionModal,{action:t,isOpen:l,onClose:s}),n]})}let useRecceActionContext=()=>(0,y.useContext)(eU);function ColumnNameCell(e){let{params:n,column:t,containerRef:r}=e,{runAction:l}=useRecceActionContext(),handleValueDiffDetail=(e,t)=>{let i={...n,...e};l("value_diff_detail",i,t)};return(0,i.jsxs)(s.k,{children:[(0,i.jsx)(u.xu,{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:t}),(0,i.jsx)(S.L,{}),(0,i.jsx)(g.v,{children:e=>{let{isOpen:n}=e;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(eF.j,{className:"row-context-menu",visibility:n?"visible":"hidden",width:n?"auto":"0px",minWidth:n?"auto":"0px",as:L.h,icon:(0,i.jsx)(m.J,{as:_.D_A}),variant:"unstyled",size:"sm"}),(0,i.jsx)(eP.h,{containerRef:r,children:(0,i.jsx)(v.q,{lineHeight:"20px",children:(0,i.jsxs)(eV.k,{title:"Action",as:u.xu,fontSize:"8pt",children:[(0,i.jsx)(j.s,{fontSize:"10pt",onClick:()=>handleValueDiffDetail({},{showForm:!0}),children:"Show mismatched values..."}),(0,i.jsxs)(j.s,{fontSize:"10pt",onClick:()=>handleValueDiffDetail({columns:[t]},{showForm:!1}),children:["Show mismatched values for '",t,"'"]})]})})})]})}})]})}function ValueDiffResultView(e){let{run:n}=e,t=n.result,r=n.params,cellClass=e=>{let n=e[2];return null!=n&&n<1?"diff-cell-modified":""},l=(0,y.useRef)(),o=Array.isArray(r.primary_key)?r.primary_key:[r.primary_key],a=[{key:"__is_pk__",name:"",maxWidth:30,renderCell:e=>{let{row:n}=e;return(0,i.jsx)(c.M,{height:"100%",children:o.includes(n[0])&&(0,i.jsx)(m.J,{as:_.MhP})})}},{key:"0",name:"Column",resizable:!0,renderCell:e=>{let{row:n,column:t}=e;return(0,i.jsx)(ColumnNameCell,{column:n[t.key],params:r,containerRef:l})},cellClass:"cell-show-context-menu"},{key:"1",name:"Matched",resizable:!0,cellClass},{key:"2",name:"Matched %",resizable:!0,renderCell:e=>{let{column:n,row:t}=e,r=t[n.key];return(0,i.jsx)(u.xu,{textAlign:"end",children:void 0!=r&&null!==r?"".concat((100*r).toFixed(2)," %"):"N/A"})},cellClass}];return(0,i.jsxs)(s.k,{direction:"column",gap:"5px",pt:"5px",height:"100%",ref:l,children:[(0,i.jsxs)(u.xu,{px:"16px",children:["Model: ",r.model,", ",t.summary.total," total (",t.summary.total-t.summary.added-t.summary.removed," ","common, ",t.summary.added," added, ",t.summary.removed," removed)"]}),(0,i.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto",borderBlock:"1px solid lightgray"},columns:a,rows:t.data.data,renderers:{noRowsFallback:(0,i.jsx)(EmptyRowsRenderer,{})},defaultColumnOptions:{resizable:!0},className:"rdg-light",enableScreenshot:!0})]})}var eQ=t(79648),eG=t(80294);let eJ={lineage_diff:{title:"Lineage Diff",icon:ee.Ks7},schema_diff:{title:"Schema Diff",icon:eG.C8A},query:{title:"Query",icon:ee.r2i,RunResultView:QueryResultView},query_diff:{title:"Query Diff",icon:ee.r2i,RunResultView:QueryDiffResultView},row_count_diff:{title:"Row Count Diff",icon:eG.QUK,RunResultView:RowCountDiffResultView},profile_diff:{title:"Profile Diff",icon:ee.KA6,RunResultView:ProfileDiffResultView},value_diff:{title:"Value Diff",icon:ee.pRi,RunResultView:ValueDiffResultView,RunForm:ValueDiffForm},value_diff_detail:{title:"Value Diff Detail",icon:ee.pRi,RunResultView:e=>{var n,t;let{run:r,onAddToChecklist:l,viewOptions:o,onViewOptionsChanged:a}=e,d=(0,y.useMemo)(()=>(null==o?void 0:o.changed_only)||!1,[o]),u=(0,y.useMemo)(()=>(null==o?void 0:o.pinned_columns)||[],[o]),h=(0,y.useMemo)(()=>{var e;if(!r.result||!(null==r?void 0:null===(e=r.params)||void 0===e?void 0:e.primary_key))return{columns:[],rows:[]};let n=r.params.primary_key,t=Array.isArray(n)?n:[n];return toValueDiffGrid(null==r?void 0:r.result,t,{changedOnly:d,pinnedColumns:u,onPinnedColumnsChange:e=>{a&&a({...o,pinned_columns:e})}})},[r,o,d,u,a]),m=(null===(n=r.result)||void 0===n?void 0:n.limit)||0,x=m>0&&(null==r?void 0:null===(t=r.result)||void 0===t?void 0:t.more)?"Warning: Displayed results are limited to ".concat(m.toLocaleString()," records. To ensure complete data retrieval, consider applying a LIMIT or WHERE clause to constrain the result set."):null,p=[];return(x&&p.push(x),0===h.columns.length)?(0,i.jsx)(c.M,{height:"100%",children:"No data"}):d&&0===h.rows.length?(0,i.jsxs)(s.k,{direction:"column",backgroundColor:"rgb(249, 249, 249)",height:"100%",children:[(0,i.jsx)(RunToolbar,{run:r,viewOptions:o,onAddToChecklist:l,onViewOptionsChanged:a,warnings:p}),(0,i.jsx)(c.M,{height:"100%",children:"No change"}),";"]}):(0,i.jsxs)(s.k,{direction:"column",backgroundColor:"rgb(249, 249, 249)",height:"100%",children:[(0,i.jsx)(RunToolbar,{run:r,viewOptions:o,onAddToChecklist:l,onViewOptionsChanged:a,warnings:p}),(0,i.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto"},columns:h.columns,rows:h.rows,renderers:{noRowsFallback:(0,i.jsx)(EmptyRowsRenderer,{})},defaultColumnOptions:{resizable:!0,maxWidth:800,minWidth:35},className:"rdg-light",enableScreenshot:!0})]})},RunForm:ValueDiffForm},top_k_diff:{title:"Top-K Diff",icon:eQ.Pkc,RunResultView:TopKDiffResultView,RunForm:TopKDiffForm},histogram_diff:{title:"Histogram Diff",icon:ee.dku,RunResultView:HistogramDiffResultView,RunForm:HistogramDiffForm}},findByRunType=e=>eJ[e];function ResourceTypeTag(e){let{node:n}=e,{icon:t}=getIconForResourceType(n.resourceType);return(0,i.jsx)(w.u,{hasArrow:!0,label:"Type of resource",children:(0,i.jsxs)(A.Vp,{children:[(0,i.jsx)(A.AD,{as:t}),(0,i.jsx)(A.Sn,{children:n.resourceType})]})})}function _RowCountByRate(e){let{rowCount:n}=e,t=n.base,r=n.curr,l=null===n.base?"N/A":"".concat(n.base," rows"),o=null===n.curr?"N/A":"".concat(n.curr," rows");return null===t&&null===r?(0,i.jsx)(i.Fragment,{children:" Failed to load"}):null===t||null===r?(0,i.jsxs)(x.U,{children:[(0,i.jsx)(p.x,{children:l}),(0,i.jsx)(m.J,{as:F.Rgz}),(0,i.jsx)(p.x,{children:o})]}):t===r?(0,i.jsxs)(x.U,{children:[(0,i.jsx)(p.x,{children:o}),(0,i.jsx)(m.J,{as:Q.lxc,color:"gray.500"}),(0,i.jsx)(p.x,{color:"gray.500",children:"No Change"})]}):t<r?(0,i.jsxs)(x.U,{children:[(0,i.jsx)(p.x,{children:o}),(0,i.jsx)(m.J,{as:Q.Tvk,color:"green.500"}),(0,i.jsx)(p.x,{color:"green.500",children:deltaPercentageString(t,r)})]}):(0,i.jsxs)(x.U,{children:[(0,i.jsx)(p.x,{children:o}),(0,i.jsx)(m.J,{as:Q.ebp,color:"red.500"}),(0,i.jsx)(p.x,{color:"red.500",children:deltaPercentageString(t,r)})]})}function RowCountTag(e){var n,t,r;let l,{rowCount:o,node:s,isInteractive:a}=e,{runsAggregated:c,refetchRunsAggregated:d}=useLineageGraphContext(),u=null==c?void 0:null===(t=c[s.id])||void 0===t?void 0:null===(n=t.row_count_diff)||void 0===n?void 0:n.result,{data:h,refetch:m,isFetching:x}=(0,U.a)({queryKey:W.rowCount(s.name),queryFn:()=>queryModelRowCount(s.name),enabled:!1,initialData:o}),p=h||o||u,f=null===(r=findByRunType("row_count_diff"))||void 0===r?void 0:r.icon;if(p){let e=(null==p?void 0:p.base)===null?"N/A":null==p?void 0:p.base,n=(null==p?void 0:p.curr)===null?"N/A":null==p?void 0:p.curr;l="".concat(e," -> ").concat(n," rows")}return(0,i.jsx)(w.u,{label:l,children:(0,i.jsxs)(A.Vp,{children:[(0,i.jsx)(A.AD,{as:f}),(0,i.jsx)(A.Sn,{children:p||x?(0,i.jsx)(O.N,{isLoaded:!x,noOfLines:1,skeletonHeight:2,minWidth:"30px",children:p?(0,i.jsx)(_RowCountByRate,{rowCount:p}):"row count"}):(0,i.jsx)(i.Fragment,{children:"row count"})}),a&&(0,i.jsx)(A.bq,{as:L.h,isLoading:x,"aria-label":"Query Row Count",icon:(0,i.jsx)($.n,{}),size:"xs",onClick:async()=>{await m(),null==d||d()}})]})})}let ActionTag=e=>{let{node:n,action:t}=e,{status:r,skipReason:l,run:o}=t;if("pending"===r)return(0,i.jsx)(M.D,{size:"20px",value:0});if("skipped"===r)return(0,i.jsxs)(s.k,{fontSize:"10pt",color:"gray",children:[(0,i.jsx)(u.xu,{children:"Skipped"}),l&&(0,i.jsx)(w.u,{label:l,children:(0,i.jsx)(N.s,{})})]});if(!o)return(0,i.jsx)(M.D,{isIndeterminate:!0,size:"20px"});let{error:a,result:c,run_id:d,progress:h}=o;if("running"===r)return(null==h?void 0:h.percentage)===void 0?(0,i.jsx)(M.D,{isIndeterminate:!0,size:"20px"}):(0,i.jsx)(M.D,{size:"20px",value:(null==h?void 0:h.percentage)*100});if(a)return(0,i.jsxs)(s.k,{fontSize:"10pt",color:"gray",children:[(0,i.jsx)(u.xu,{children:"Error"}),l&&(0,i.jsx)(w.u,{label:a,children:(0,i.jsx)(z.a,{})})]});if("value_diff"===o.type){let e=0;for(let n of c.data.data)n[2]<1&&e++;return(0,i.jsx)(A.Vp,{children:(0,i.jsx)(A.Sn,{children:(0,i.jsx)(s.k,{fontSize:"10pt",color:e>0?"red":"green",alignItems:"center",gap:"3px",children:e>0?"".concat(e," columns mismatched"):"All columns match"})})})}if("row_count_diff"===o.type){let e=o.result;return(0,i.jsx)(RowCountTag,{rowCount:e[n.name],node:n,isInteractive:!1})}return(0,i.jsx)(i.Fragment,{children:d})};function isSchemaChanged(e,n){if(!e||!n)return;let t=Object.keys(e),i=Object.keys(n);if(t.length!==i.length)return!0;for(let e=0;e<t.length;e++)if(t[e]!==i[e])return!0;for(let t of i)if(!e[t]||e[t].type!==n[t].type)return!0;return!1}let NodeRunsAggregated=e=>{var n,t,r,l;let o,a,{id:c}=e,{lineageGraph:d,runsAggregated:h}=useLineageGraphContext(),x=null==h?void 0:h[c],p=null==d?void 0:d.nodes[c];if(!x&&!p)return(0,i.jsx)(i.Fragment,{});if((null==p?void 0:p.data.base)&&(null==p?void 0:p.data.current)){let e=null===(r=p.data.base)||void 0===r?void 0:r.columns,n=null===(l=p.data.current)||void 0===l?void 0:l.columns;o=isSchemaChanged(e,n)}if(x&&x.row_count_diff){let e=x.row_count_diff;a=e.result.curr!==e.result.base}return(0,i.jsxs)(s.k,{gap:"5px",children:[void 0!==o&&(0,i.jsx)(w.u,{label:"Schema (".concat(o?"changed":"no change",")"),openDelay:500,children:(0,i.jsx)(u.xu,{height:"16px",children:(0,i.jsx)(m.J,{as:null===(n=findByRunType("schema_diff"))||void 0===n?void 0:n.icon,color:o?getIconForChangeStatus("modified").color:"lightgray"})})}),void 0!==a&&(0,i.jsx)(w.u,{label:"Row count (".concat(a?"changed":"no change",")"),openDelay:500,children:(0,i.jsx)(u.xu,{height:"16px",children:(0,i.jsx)(m.J,{as:null===(t=findByRunType("row_count_diff"))||void 0===t?void 0:t.icon,color:a?getIconForChangeStatus("modified").color:"lightgray"})})})]})};function GraphNode(e){var n,t;let l,{data:o}=e,{isHighlighted:a,isSelected:c,resourceType:d,changeStatus:h}=o,p=(0,r.oR)(e=>e.transform[2]>.3),{icon:f}=getIconForResourceType(d),g="gray.400",v="solid";h&&(l=getIconForChangeStatus(h).icon,g=getIconForChangeStatus(h).color);let j=g,y=o.isSelected?"rgba(3, 102, 214, 0.5) 5px 5px 10px 3px":"unset",C=null==o?void 0:o.name;return(0,i.jsx)(w.u,{label:"model"===d?C:"".concat(C," (").concat(d,")"),placement:"top",children:(0,i.jsxs)(s.k,{width:"300px",_hover:{backgroundColor:p?"gray.100":g},borderColor:j,borderWidth:1,borderStyle:v,backgroundColor:p?"white":g,borderRadius:3,boxShadow:y,transition:"box-shadow 0.2s ease-in-out",padding:0,className:!0===a?"node-highlight":!0===c?"node-highlight":!1===a?"node-unhighlight":void 0,children:[(0,i.jsx)(s.k,{backgroundColor:g,padding:2,borderRightWidth:1,borderColor:j,borderStyle:v,alignItems:"top",visibility:p?"inherit":"hidden",children:(0,i.jsx)(m.J,{as:f})}),(0,i.jsxs)(s.k,{flex:"1 0 auto",mx:"1",width:"100px",direction:"column",children:[(0,i.jsxs)(s.k,{width:"100%",textAlign:"left",flex:"1",p:1,alignItems:"center",visibility:p?"inherit":"hidden",children:[(0,i.jsx)(u.xu,{flex:"1",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",children:C}),l&&(0,i.jsx)(s.k,{children:(0,i.jsx)(m.J,{color:g,as:l,flex:"0 0 20px"})})]}),(0,i.jsx)(s.k,{flex:"1 0 auto",mx:"1",direction:"column",paddingBottom:"1",visibility:p?"inherit":"hidden",children:(0,i.jsxs)(x.U,{spacing:"8px",children:[(0,i.jsx)(S.L,{}),o.isActionMode?o.action?(0,i.jsx)(ActionTag,{node:o,action:o.action}):(0,i.jsx)(i.Fragment,{}):"model"===o.resourceType?(0,i.jsx)(NodeRunsAggregated,{id:o.id}):(0,i.jsx)(i.Fragment,{})]})})]}),Object.keys(null!==(n=null==o?void 0:o.parents)&&void 0!==n?n:{}).length>0&&(0,i.jsx)(r.HH,{type:"target",position:r.Ly.Left,isConnectable:!1}),Object.keys(null!==(t=null==o?void 0:o.children)&&void 0!==t?t:{}).length>0&&(0,i.jsx)(r.HH,{type:"source",position:r.Ly.Right,isConnectable:!1})]})})}function GraphEdge(e){let{sourceX:n,sourceY:t,targetX:l,targetY:o,sourcePosition:s,targetPosition:a,style:c={},markerEnd:d,data:u}=e,h={...c};(null==u?void 0:u.changeStatus)&&(h.stroke=getIconForChangeStatus(null==u?void 0:u.changeStatus).color,h.strokeDasharray="5"),(null==u?void 0:u.isHighlighted)===!1&&(h.filter="opacity(0.2) grayscale(50%)");let[m]=(0,r.OQ)({sourceX:n,sourceY:t,sourcePosition:s,targetX:l,targetY:o,targetPosition:a});return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(r.u5,{path:m,markerEnd:d,style:{...h,...c}})})}var eZ=t(67907),eX=t(74796),eY=t(2593),e$=t(55344),e0=t(1726),e1=t(83622),e2=t(21801),e5=t(29731);function mergeColumns(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t={},i=mergeKeysWithStatus(Object.keys(e),Object.keys(n));return Object.entries(i).forEach(e=>{let[n,i]=e;t[n]={name:n,reordered:"reordered"===i}}),Object.entries(e).map((e,n)=>{let[i,r]=e;t[i].baseIndex=n+1,t[i].baseType=r.type}),Object.entries(n).map((e,n)=>{let[i,r]=e;t[i].currentIndex=n+1,t[i].currentType=r.type}),t}function schema_toDataGrid(e){function columnIndexCellClass(e){return void 0===e.baseIndex?"column-index-added":void 0===e.currentIndex?"column-index-removed":!0===e.reordered?"column-index-reordered":"column-index-normal"}function columnNameCellClass(e){return void 0===e.baseIndex?"column-body-added":void 0===e.currentIndex?"column-body-removed":!0===e.reordered?"column-body-reordered":"column-body-normal"}function columnTypeCellClass(e){return void 0===e.baseIndex?"column-body-added":void 0===e.currentIndex?"column-body-removed":e.baseType!==e.currentType?"column-body-type-changed":!0===e.reordered?"column-body-reordered":"column-body-normal"}let n=Object.values(e);return{columns:[{key:"baseIndex",name:"",resizable:!0,minWidth:35,cellClass:columnIndexCellClass},{key:"currentIndex",name:"",resizable:!0,minWidth:35,cellClass:columnIndexCellClass},{key:"name",name:"Name",resizable:!0,cellClass:columnNameCellClass},{key:"baseType",name:"Base Type",resizable:!0,cellClass:columnTypeCellClass},{key:"currentType",name:"Current Type",resizable:!0,cellClass:columnTypeCellClass}],rows:n}}function SchemaView(e){let n,t,{base:r,current:l,enableScreenshot:o=!1}=e,{columns:a,rows:c}=(0,y.useMemo)(()=>schema_toDataGrid(mergeColumns(null==r?void 0:r.columns,null==l?void 0:l.columns)),[r,l]),{lineageGraph:d}=useLineageGraphContext(),u=!(null==d?void 0:d.catalogMetadata.base),h=!(null==d?void 0:d.catalogMetadata.current);u&&h?n="catalog.json is missing on both current and base environments.":u?n="catalog.json is missing on base environment.":h&&(n="catalog.json is missing on current environment.");let m=r&&void 0===r.columns,x=l&&void 0===l.columns;return m&&x?t="Schema information is missing on both current and base environments.":m?t="Schema information is missing on base environment.":x&&(t="Schema information is missing on current environment."),(0,i.jsxs)(s.k,{direction:"column",children:[n?(0,i.jsxs)(eH.b,{status:"warning",fontSize:"12px",p:"8px",children:[(0,i.jsx)(eK.z,{}),n]}):t?(0,i.jsxs)(eH.b,{status:"warning",fontSize:"12px",p:"8px",children:[(0,i.jsx)(eK.z,{}),t]}):(0,i.jsx)(i.Fragment,{}),c.length>0&&(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(ScreenshotDataGrid,{style:{blockSize:"auto",maxHeight:"100%",overflow:"auto",fontSize:"10pt",borderWidth:1},columns:a,rows:c,renderers:{noRowsFallback:(0,i.jsx)(EmptyRowsRenderer,{})},className:"rdg-light",enableScreenshot:o})})]})}t(75165);let e4='select * from {{ ref("mymodel") }}',e6=(0,y.createContext)({sqlQuery:e4,setSqlQuery:()=>{},primaryKeys:void 0,setPrimaryKeys:()=>{}});function RecceQueryContextProvider(e){let{children:n}=e,[t,r]=y.useState(e4),[l,o]=y.useState();return(0,i.jsx)(e6.Provider,{value:{setSqlQuery:r,sqlQuery:t,setPrimaryKeys:o,primaryKeys:l},children:n})}let useRecceQueryContext=()=>(0,y.useContext)(e6),e3=(0,y.createContext)({isNodesFetching:[],setIsNodesFetching:()=>{}});function RowCountStateContextProvider(e){let{children:n}=e,[t,r]=y.useState([]);return(0,i.jsx)(e3.Provider,{value:{isNodesFetching:t,setIsNodesFetching:r},children:n})}var e9=t(29357);function SqlDiffView(e){let{base:n,current:t}=e;return(0,i.jsx)(e9.SV,{height:"500px",language:"sql",theme:"vs",original:null==n?void 0:n.raw_code,modified:null==t?void 0:t.raw_code,options:{readOnly:!0,fontSize:14,lineNumbers:"on",automaticLayout:!0,minimap:{enabled:!1},wordWrap:"on",wrappingIndent:"same"}})}function NodeView(e){let{node:n,onCloseNode:t}=e,[,r]=(0,eB.TH)(),{setSqlQuery:l,setPrimaryKeys:o}=useRecceQueryContext(),a="model"===n.resourceType||"seed"===n.resourceType||"source"===n.resourceType,{isOpen:c,onOpen:d,onClose:m}=(0,ex.q)(),{runAction:p}=useRecceActionContext(),{envInfo:f}=useLineageGraphContext(),{primaryKey:C}=hooks_useModelColumns(n.name),b=(0,y.useCallback)(async()=>{let e=n.id,t=await createCheckByNodeSchema(e);r("/checks/".concat(t.check_id))},[n,r]);return(0,i.jsxs)(eX.r,{height:"100%",templateRows:"auto auto 1fr",children:[(0,i.jsxs)(x.U,{children:[(0,i.jsx)(u.xu,{flex:"0 1 20%",p:"16px",children:(0,i.jsx)(eo.X,{size:"sm",children:n.name})}),(0,i.jsx)(S.L,{}),"modified"===n.changeStatus&&(0,i.jsxs)(u.xu,{children:[(0,i.jsx)(h.z,{onClick:d,leftIcon:(0,i.jsx)(R.tvD,{}),colorScheme:"orange",variant:"solid",children:"Diff"}),(0,i.jsxs)(ep.u_,{isOpen:c,onClose:m,size:"6xl",children:[(0,i.jsx)(ef.Z,{}),(0,i.jsxs)(eg.h,{overflowY:"auto",height:"75%",children:[(0,i.jsx)(ev.x,{children:"Model Raw Code Diff"}),(0,i.jsx)(ej.o,{}),(0,i.jsx)(ey.f,{children:(0,i.jsx)(SqlDiffView,{base:n.data.base,current:n.data.current})})]})]})]}),(0,i.jsx)(u.xu,{flex:"0 1 1%",p:"16px",children:(0,i.jsx)(eY.P,{onClick:t})})]}),(0,i.jsx)(u.xu,{color:"gray",paddingLeft:"16px",children:(0,i.jsxs)(x.U,{spacing:"8px",children:[(0,i.jsx)(ResourceTypeTag,{node:n}),"model"===n.resourceType&&(0,i.jsx)(RowCountTag,{node:n,isInteractive:!0})]})}),a&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(e$.m,{overflow:"auto",as:s.k,children:[(0,i.jsx)(e0.t,{children:(0,i.jsx)(e1.O,{children:"Columns"})}),(0,i.jsx)(e2.n,{overflow:"auto",height:"calc(100% - 42px)",children:(0,i.jsx)(e5.x,{p:0,overflowY:"auto",height:"100%",children:(0,i.jsx)(SchemaView,{base:n.data.base,current:n.data.current})})})]}),(0,i.jsxs)(x.U,{p:"16px",children:[(0,i.jsxs)(g.v,{children:[(0,i.jsx)(eF.j,{as:h.z,size:"sm",colorScheme:"blue",children:"Add check"}),(0,i.jsx)(v.q,{children:(0,i.jsx)(j.s,{onClick:b,children:"Schema Check"})})]}),(0,i.jsx)(S.L,{}),"model"===n.resourceType&&(0,i.jsxs)(i.Fragment,{children:["added"!==n.changeStatus&&"removed"!==n.changeStatus&&(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)(g.v,{children:[(0,i.jsx)(eF.j,{as:h.z,size:"sm",colorScheme:"blue",children:"Advanced Diffs"}),(0,i.jsxs)(v.q,{children:[(0,i.jsx)(j.s,{onClick:()=>{p("profile_diff",{model:n.name},{showForm:!1,showLast:!0})},children:"Profile Diff"}),(0,i.jsx)(j.s,{onClick:()=>{p("value_diff",{model:n.name},{showForm:!0,showLast:!0})},children:"Value Diff"}),(0,i.jsx)(j.s,{onClick:()=>{p("top_k_diff",{model:n.name,column_name:"",k:50},{showForm:!0})},children:"Top-K Diff"}),(0,i.jsx)(j.s,{onClick:()=>{p("histogram_diff",{model:n.name,column_name:"",column_type:""},{showForm:!0})},children:"Histogram Diff"})]})]})}),(0,i.jsx)(h.z,{colorScheme:"blue",size:"sm",onClick:()=>{(null==f?void 0:f.adapterType)==="dbt"?l('select * from {{ ref("'.concat(n.name,'") }}')):(null==f?void 0:f.adapterType)==="sqlmesh"&&l("select * from ".concat(n.name)),o(void 0!==C?[C]:void 0),r("/query")},children:"Query"})]})]})]})]})}var e8=t(45438),e7=t(72491),ne=t(52246),nn=t(25807);async function createLineageDiffCheck(e){let n=await H.post("/api/checks",{type:"lineage_diff",params:{},view_options:e}),t=n.data;return t}function AddSchemaChangesCheckButton(e){var n;let{nodes:t,onFinish:r}=e,[,l]=(0,eB.TH)();return(0,i.jsxs)(h.z,{size:"xs",variant:"outline",isDisabled:0===t.length,onClick:async()=>{let e;1===t.length?e=await createCheckByNodeSchema(t[0].id):await Promise.all(t.map(async e=>{await createCheckByNodeSchema(e.id)})),r(),e?l("/checks/".concat(e.check_id)):l("/checks")},children:[(0,i.jsx)(m.J,{as:null===(n=findByRunType("schema_diff"))||void 0===n?void 0:n.icon}),"Add schema check"]})}function AddLineageDiffCheckButton(e){var n;let{viewMode:t,nodes:r,onFinish:l,isDisabled:o,withIcon:s}=e,[,a]=(0,eB.TH)();return(0,i.jsxs)(h.z,{size:"xs",variant:"outline",backgroundColor:"white",isDisabled:0===r.length||o,onClick:async()=>{let e=r.map(e=>e.id),n=await createLineageDiffCheck({view_mode:t,node_ids:e});l(),n?a("/checks/".concat(n.check_id)):a("/checks")},children:[s&&(0,i.jsx)(m.J,{as:null===(n=findByRunType("lineage_diff"))||void 0===n?void 0:n.icon}),"Add lineage diff check"]})}function NodeSelector(e){var n,t,r,l,o,s;let{viewMode:a,nodes:c,onClose:d,onActionStarted:p,onActionNodeUpdated:f,onActionCompleted:g}=e,[v,j]=(0,y.useState)({mode:"per_node",status:"pending",completed:0,total:0}),C=(0,G.NL)(),[,b]=(0,eB.TH)(),submitRunForNodes=async(e,n,t)=>{let i="multi_nodes";v.mode=i,p(),v.status="running";let r=[];for(let e of c){let t=n(e);t?(e.action={mode:i,status:"skipped",skipReason:t},f(e)):(e.action={mode:i,status:"pending"},r.push(e))}let l=t(r);try{let{run_id:n}=await submitRun(e,l,{nowait:!0});for(v.currentRun={run_id:n},v.total=1;;){let e=await waitRun(n,2);v.currentRun=e;let t=e.error?"failure":e.result?"success":"running";for(let n of r)n.action={mode:i,status:t,run:e},f(n);if(e.error||e.result)break}}catch(e){}if(v.completed=1,"canceling"===v.status){v.status="canceled",g();return}v.status="completed",g()},submitRunsPerNodes=async(e,n)=>{let t="per_node";for(let e of(v.mode=t,p(),v.status="running",c))e.action={mode:t,status:"pending"},f(e);for(let i of(v.completed=0,v.total=c.length,c)){let{params:r,skipReason:l}=n(i);if(l)i.action={mode:t,status:"skipped",skipReason:l},f(i);else try{let{run_id:n}=await submitRun(e,r,{nowait:!0});for(v.currentRun={run_id:n},i.action={mode:t,status:"running"},f(i);;){let e=await waitRun(n,2);v.currentRun=e;let r=e.error?"failure":e.result?"success":"running";if(i.action={mode:t,status:r,run:e},f(i),e.error||e.result)break}}catch(e){}finally{v.currentRun=void 0}if(v.completed++,"canceling"===v.status){v.status="canceled",g();return}}v.status="completed",g()},handleRowCountDiffClick=async()=>{let e=[];for(let n of c)"model"!==n.resourceType?(n.action={mode:"multi_nodes",status:"skipped",skipReason:"Not a model"},f(n)):e.push(n.name);submitRunForNodes("row_count_diff",e=>{if("model"!==e.resourceType)return"Not a model"},e=>{let n={node_names:e.map(e=>e.name)};return n})},handleValueDiffClick=async()=>{submitRunsPerNodes("value_diff",e=>{var n,t;let i=null===(t=e.data)||void 0===t?void 0:null===(n=t.current)||void 0===n?void 0:n.primary_key;if(!i)return{skipReason:"No primary key found. The first unique column is used as primary key."};let r={model:e.name,primary_key:i};return{params:r}})},handleCancel=async()=>{var e;v.status="canceling",(null===(e=v.currentRun)||void 0===e?void 0:e.run_id)&&cancelRun(v.currentRun.run_id)},k=(0,y.useCallback)(async()=>{var e;let n=null===(e=v.currentRun)||void 0===e?void 0:e.run_id;if(!n)return;let t=await createCheckByRun(n);C.invalidateQueries({queryKey:W.checks()}),b("/checks/".concat(t.check_id))},[null===(n=v.currentRun)||void 0===n?void 0:n.run_id,b,C]);return(0,e7.z)(()=>{"running"===v.status&&handleCancel()}),(0,i.jsxs)(u.xu,{bg:"white",rounded:"md",shadow:"dark-lg",children:["pending"===v.status&&(0,i.jsxs)(x.U,{p:"5px 15px",mt:"4",divider:(0,i.jsx)(ne.c,{borderColor:"gray.200"}),spacing:4,children:[(0,i.jsxs)(nn.h,{size:"xs",isAttached:!0,variant:"outline",rounded:"xs",onClick:d,children:[(0,i.jsxs)(h.z,{children:[c.length," selected"]}),(0,i.jsx)(L.h,{"aria-label":"Exit select Mode",icon:(0,i.jsx)(e8.D,{})})]}),(0,i.jsxs)(x.U,{children:[(0,i.jsx)(AddSchemaChangesCheckButton,{nodes:c,onFinish:d}),(0,i.jsx)(AddLineageDiffCheckButton,{viewMode:a,nodes:c,onFinish:d,withIcon:!0})]}),(0,i.jsxs)(x.U,{children:[(0,i.jsxs)(h.z,{size:"xs",variant:"outline",isDisabled:0===c.length,onClick:handleRowCountDiffClick,children:[(0,i.jsx)(m.J,{as:null===(t=findByRunType("row_count_diff"))||void 0===t?void 0:t.icon}),"Row count diff"]}),(0,i.jsxs)(h.z,{size:"xs",variant:"outline",isDisabled:0===c.length,onClick:handleValueDiffClick,children:[(0,i.jsx)(m.J,{as:null===(r=findByRunType("value_diff"))||void 0===r?void 0:r.icon}),"Value diff"]})]})]}),"pending"!==v.status&&(0,i.jsxs)(x.U,{p:"5px 15px",mt:"4",divider:(0,i.jsx)(ne.c,{borderColor:"gray.200"}),spacing:4,children:[(0,i.jsxs)(u.xu,{fontSize:"10pt",children:["Progress: ","per_node"===v.mode?"".concat(v.completed," / ").concat(v.total):(null===(s=v.currentRun)||void 0===s?void 0:null===(o=s.progress)||void 0===o?void 0:o.percentage)?"".concat(100*v.currentRun.progress.percentage,"%"):"completed"===v.status?"100%":"0%"," ","canceled"===v.status?" (canceled)":""]}),"running"===v.status||"canceling"===v.status?(0,i.jsx)(h.z,{size:"xs",variant:"outline",onClick:handleCancel,isLoading:"canceling"===v.status,loadingText:"Canceling",children:"Cancel"}):(0,i.jsxs)(x.U,{children:["multi_nodes"===v.mode&&(null===(l=v.currentRun)||void 0===l?void 0:l.result)&&(0,i.jsx)(h.z,{display:"none",size:"xs",variant:"outline",onClick:k,children:"Add to checklist"}),(0,i.jsx)(h.z,{size:"xs",variant:"outline",onClick:d,children:"Close"})]})]})]})}var nt=t(13886);let ViewModeSelectMenu=e=>{let{viewOptions:n,onViewOptionsChanged:t}=e,r=n.view_mode||"changed_models",handleSelect=e=>{t({...n,view_mode:e})};return(0,i.jsxs)(g.v,{children:[(0,i.jsx)(eF.j,{as:h.z,minWidth:"150px",leftIcon:(0,i.jsx)(m.J,{as:getIconForResourceType("model").icon}),size:"xs",variant:"outline",children:"changed_models"===r?"Changed Models":"All"}),(0,i.jsxs)(v.q,{title:"packages",children:[(0,i.jsx)(j.s,{as:eN.X,size:"sm",isChecked:"changed_models"===r,onChange:()=>handleSelect("changed_models"),children:"Changed Models"}),(0,i.jsx)(j.s,{as:eN.X,size:"sm",isChecked:"all"===r,onChange:()=>handleSelect("all"),children:"All"})]})]})},PackageSelectMenu=e=>{var n,t;let{viewOptions:r,onViewOptionsChanged:l}=e,{lineageGraph:o}=useLineageGraphContext(),s=new Set,a=Object.values((null==o?void 0:o.nodes)||{});for(let e of a)e.packageName&&s.add(e.packageName);let c=null==o?void 0:null===(t=o.manifestMetadata)||void 0===t?void 0:null===(n=t.current)||void 0===n?void 0:n.project_name,d=r.packages?new Set(r.packages):c?new Set([c]):s,u=d.size===s.size,x=0===d.size,p=1===d.size?Array.from(d)[0]:u?"All Packages":x?"No Package":"".concat(d.size," Packages"),handleSelect=e=>{let n=new Set(d);n.has(e)?n.delete(e):n.add(e),l({...r,packages:Array.from(n)})};return(0,i.jsxs)(g.v,{closeOnSelect:!1,children:[(0,i.jsx)(eF.j,{as:h.z,minWidth:"150px",leftIcon:(0,i.jsx)(m.J,{as:F.zFh}),size:"xs",variant:"outline",children:p}),(0,i.jsx)(v.q,{title:"packages",children:(0,i.jsxs)(eV.k,{title:"Select Packages",children:[(0,i.jsx)(j.s,{as:eN.X,size:"sm",isIndeterminate:!u&&!x,isChecked:u,onChange:()=>{u?l({...r,packages:[]}):l({...r,packages:Array.from(s)})},children:"Select All"}),(0,i.jsx)(nt.R,{}),Array.from(s).map(e=>(0,i.jsx)(j.s,{as:eN.X,size:"sm",isChecked:d.has(e),onChange:()=>{console.log("selected"),handleSelect(e)},children:e},e))]})})]})},NodeFilter=e=>{let{onClose:n}=e;return(0,i.jsx)(u.xu,{bg:"white",rounded:"md",shadow:"dark-lg",children:(0,i.jsxs)(x.U,{p:"5px 15px",mt:"4",divider:(0,i.jsx)(ne.c,{borderColor:"gray.200"}),children:[(0,i.jsxs)(x.U,{children:[(0,i.jsx)(ViewModeSelectMenu,{...e}),(0,i.jsx)(PackageSelectMenu,{...e})]}),(0,i.jsxs)(nn.h,{size:"xs",isAttached:!0,variant:"outline",rounded:"xs",children:[(0,i.jsx)(h.z,{onClick:()=>n(!0),children:"Fit and Close"}),(0,i.jsx)(L.h,{"aria-label":"Exit filter Mode",icon:(0,i.jsx)(e8.D,{}),onClick:()=>n(!1)})]})]})})};function NodeRunView(e){var n,t,r,l,o,a,c,d,m;let{node:p,onCloseNode:f}=e,g=null===(n=p.action)||void 0===n?void 0:n.run,[,v]=(0,eB.TH)(),j=(0,G.NL)(),[C,b]=(0,y.useState)(),k=(0,y.useCallback)(async()=>{if(!(null==g?void 0:g.run_id))return;let e=await createCheckByRun(g.run_id,C);j.invalidateQueries({queryKey:W.checks()}),v("/checks/".concat(e.check_id))},[null==g?void 0:g.run_id,v,j,C]),w=(null===(r=p.action)||void 0===r?void 0:null===(t=r.run)||void 0===t?void 0:t.type)==="value_diff"?ValueDiffResultView:(null===(o=p.action)||void 0===o?void 0:null===(l=o.run)||void 0===l?void 0:l.type)==="row_count_diff"?RowCountDiffResultView:null;return(0,i.jsxs)(eX.r,{height:"100%",templateRows:"auto auto 1fr",children:[(0,i.jsxs)(x.U,{children:[(0,i.jsx)(u.xu,{flex:"0 1 20%",p:"16px",children:(0,i.jsx)(eo.X,{size:"sm",children:p.name})}),(0,i.jsx)(S.L,{}),(0,i.jsx)(u.xu,{flex:"0 1 1%",p:"16px",children:(0,i.jsx)(eY.P,{onClick:f})})]}),(0,i.jsx)(u.xu,{color:"gray",paddingLeft:"16px",children:(0,i.jsxs)(x.U,{spacing:"8px",children:[(0,i.jsx)(ResourceTypeTag,{node:p}),(null==g?void 0:g.type)==="row_count_diff"&&(null===(a=g.result)||void 0===a?void 0:a[p.name])&&(0,i.jsx)(RowCountTag,{rowCount:g.result[p.name],node:p})]})}),(0,i.jsxs)(e$.m,{overflow:"auto",as:s.k,children:[(0,i.jsx)(e0.t,{children:(0,i.jsx)(e1.O,{children:"Run"})}),(0,i.jsx)(e2.n,{overflow:"auto",height:"calc(100% - 42px)",children:(0,i.jsx)(e5.x,{p:0,overflowY:"auto",height:"100%",children:w?(0,i.jsx)(RunView,{run:null===(c=p.action)||void 0===c?void 0:c.run,viewOptions:C,onViewOptionsChanged:b,RunResultView:w}):(0,i.jsx)(u.xu,{p:"20px 10px",children:"No run result"})})})]}),(0,i.jsxs)(x.U,{p:"16px",children:[(0,i.jsx)(S.L,{}),(0,i.jsx)(h.z,{size:"sm",colorScheme:"blue",isDisabled:!(null===(m=p.action)||void 0===m?void 0:null===(d=m.run)||void 0===d?void 0:d.result),onClick:k,children:"Add to checklist"})]})]})}function ChangeStatusLegend(){return(0,i.jsx)(u.xu,{bg:"white",padding:"12px",borderWidth:"1px",borderColor:"gray.200",fontSize:"sm",children:Object.entries({added:["Added","Added resource"],removed:["Removed","Removed resource"],modified:["Modified","Modified resource"]}).map(e=>{let[n,[t,r]]=e,{icon:l,color:o}=getIconForChangeStatus(n);return(0,i.jsx)(w.u,{label:r,children:(0,i.jsxs)(s.k,{alignItems:"center",gap:"6px",marginBottom:"2px",children:[(0,i.jsx)(m.J,{color:o,as:l})," ",t]})},n)})})}let ni={customNode:GraphNode},nr={customEdge:GraphEdge},nodeColor=e=>{var n,t;return(null==e?void 0:null===(n=e.data)||void 0===n?void 0:n.changeStatus)?getIconForChangeStatus(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.changeStatus).color:"lightgray"},nl={all:"All",changed_models:"Changed Models"};function _LineageView(e){var n;let{...t}=e,l=(0,r._K)(),{successToast:o,failToast:w}=useClipBoardToast(),{copyToClipboard:S,ImageDownloadModal:_,ref:R}=useCopyToClipboard({renderLibrary:"html-to-image",imageType:"png",shadowEffect:!0,backgroundColor:"white",ignoreElements:e=>{let n=e.className;return!!("string"==typeof n&&n.includes(eD))},onSuccess:()=>{o("Copied the Lineage View as an image to clipboard")},onError:e=>{console.error("Error taking screenshot",e),w("Failed to copy image to clipboard",e)}}),[T,D,I]=(0,r.Rr)([]),[E,N,z]=(0,r.ll)([]),[M,A]=(0,y.useState)(t.viewOptions||{}),{lineageGraph:O,retchLineageGraph:L,isLoading:P,error:V,refetchRunsAggregated:q}=useLineageGraphContext(),B=M.view_mode||t.viewMode||"changed_models",[H,K]=(0,y.useState)("detail"),[W,U]=(0,y.useState)("normal"),[Q,G]=(0,y.useState)(),[J,Z]=(0,y.useState)(!1),[X,Y]=(0,y.useState)(!1),[$,ee]=(0,y.useState)({x:0,y:0});(0,y.useLayoutEffect)(()=>{if(!O)return;let[e,n]=toReactflow(O,M);layout(e,n),D(e),N(n)},[D,N,O]);let centerNode=async e=>{if(e.width&&e.height){let n=e.position.x+e.width/2,t=e.position.y+e.height/2,i=l.getZoom();l.setCenter(n,t,{zoom:i,duration:200})}},en=(0,y.useCallback)(e=>{D(n=>{let t=n.map(n=>n.id===e.id?{...n,data:e}:n);return t})},[D]),handleViewOptionsChanged=e=>{if(!O)return;let[n,t]=toReactflow(O,e);layout(n,t),D(n),N(t),A(e),l.fitView({nodes:n})};if(P)return(0,i.jsx)(s.k,{width:"100%",height:"100%",alignItems:"center",justifyContent:"center",children:(0,i.jsx)(a.$,{size:"xl"})});let closeContextMenu=()=>{Y(!1),ee({x:0,y:0})};return V?(0,i.jsx)(c.M,{h:"100%",children:(0,i.jsxs)(d.g,{children:[(0,i.jsx)(u.xu,{children:"Failed to load lineage data. This could be because the server has been terminated or there is a network error."}),(0,i.jsxs)(u.xu,{children:["[Reason: ",V,"]"]}),(0,i.jsx)(h.z,{colorScheme:"blue",onClick:()=>{L&&L()},children:"Retry"})]})}):"changed_models"!==B||(null==O?void 0:null===(n=O.modifiedSet)||void 0===n?void 0:n.length)?(0,i.jsxs)(s.k,{width:"100%",height:"100%",children:[(0,i.jsx)(u.xu,{flex:"1 0 0px",children:(0,i.jsxs)(r.x$,{nodeTypes:ni,edgeTypes:nr,nodes:T,edges:E,onNodesChange:I,onEdgesChange:z,onNodeClick:(e,n)=>{!1!==t.interactive&&(closeContextMenu(),"detail"===H?(G(n.data),J||(Z(!0),centerNode(n)),D(selectSingleNode(n.id,T))):"action_result"===H?(G(n.data),J||(Z(!0),centerNode(n)),D(selectSingleNode(n.id,T))):D(selectNode(n.id,T)))},onNodeMouseEnter:(e,n)=>{if(!O)return;let t=union(selectUpstream(O,[n.id]),selectDownstream(O,[n.id])),[i,r]=highlightNodes(Array.from(t),T,E);D(i),N(r)},onNodeMouseLeave:(e,n)=>{if(!O)return;let t=selectDownstream(O,O.modifiedSet),[i,r]=highlightNodes(Array.from(t),T,E);D(i),N(r)},onNodeContextMenu:(e,n)=>{"action"===H&&(e.preventDefault(),ee({x:e.clientX,y:e.clientY,selectedNode:n}),Y(!0))},onClick:closeContextMenu,maxZoom:1,minZoom:.1,fitView:!0,nodesDraggable:t.interactive,ref:R,children:[(0,i.jsx)(C.A,{color:"#ccc"}),(0,i.jsx)(b.Z,{showInteractive:!1,position:"top-right",className:eD,children:(0,i.jsx)(b.B,{title:"copy image",onClick:async()=>{S()},children:(0,i.jsx)(m.J,{as:F.C3L})})}),(0,i.jsx)(_,{}),(0,i.jsx)(r.s_,{position:"bottom-left",children:(0,i.jsxs)(x.U,{children:[(0,i.jsx)(ChangeStatusLegend,{}),t.interactive&&(0,i.jsxs)(u.xu,{p:2,flex:"0 1 160px",fontSize:"14px",className:eD,children:[(0,i.jsx)(p.x,{color:"gray",mb:"2px",children:"Actions"}),(0,i.jsxs)(d.g,{spacing:1,align:"baseline",children:[(0,i.jsx)(h.z,{size:"xs",variant:"outline",backgroundColor:"white",isDisabled:"normal"!==W,onClick:()=>{let e="detail"===H?"action":"detail";G(void 0),Z(!1);let n=cleanUpNodes(T,"action"===e);D(n),K(e),U("selector")},children:"Select models"}),(0,i.jsx)(h.z,{size:"xs",variant:"outline",backgroundColor:"white",isDisabled:"normal"!==W,onClick:()=>{U("filter")},children:"Filter nodes"}),(0,i.jsx)(AddLineageDiffCheckButton,{isDisabled:"normal"!==W,viewMode:B,nodes:T.map(e=>e.data),onFinish:()=>K("detail")})]})]})]})}),(0,i.jsx)(r.s_,{position:"top-left",children:(0,i.jsx)(p.x,{fontSize:"xl",color:"grey",opacity:.5,children:T.length>0?nl[B]:"No nodes"})}),(0,i.jsx)(k.a,{nodeColor:nodeColor,nodeStrokeWidth:3,zoomable:!0,pannable:!0}),(0,i.jsxs)(r.s_,{position:"bottom-center",className:eD,children:[(0,i.jsx)(f.R,{in:"selector"===W,unmountOnExit:!0,style:{zIndex:10},children:(0,i.jsx)(NodeSelector,{viewMode:B,nodes:T.map(e=>e.data).filter(e=>e.isSelected),onClose:()=>{K("detail"),U("normal");let e=cleanUpNodes(T);G(void 0),Z(!1),D(e),null==q||q()},onActionStarted:()=>{K("action_result")},onActionNodeUpdated:en,onActionCompleted:()=>{}})}),(0,i.jsx)(f.R,{in:"filter"===W,unmountOnExit:!0,style:{zIndex:10},children:(0,i.jsx)(NodeFilter,{viewOptions:M,onViewOptionsChanged:handleViewOptionsChanged,onClose:e=>{U("normal"),e&&l.fitView()}})})]})]})}),"detail"===H&&Q&&(0,i.jsx)(u.xu,{flex:"0 0 500px",borderLeft:"solid 1px lightgray",height:"100%",children:(0,i.jsx)(NodeView,{node:Q,onCloseNode:()=>{G(void 0),Z(!1),D(cleanUpNodes(T))}})}),"action_result"===H&&Q&&(0,i.jsx)(u.xu,{flex:"0 0 500px",borderLeft:"solid 1px lightgray",height:"100%",children:(0,i.jsx)(NodeRunView,{node:Q,onCloseNode:()=>{G(void 0),Z(!1)}})}),X&&(0,i.jsx)(g.v,{isOpen:!0,onClose:closeContextMenu,children:(0,i.jsxs)(v.q,{style:{position:"absolute",left:"".concat($.x,"px"),top:"".concat($.y,"px")},children:[(0,i.jsx)(j.s,{icon:(0,i.jsx)(eZ.Cv2,{}),onClick:()=>{let e=$.selectedNode;if("action"!==H||void 0===e||void 0===O)return;let n=e.id,t=selectUpstream(O,[n]),i=selectNodes([...t],T);D(i)},children:"Select parent nodes"}),(0,i.jsx)(j.s,{icon:(0,i.jsx)(eZ.IMj,{}),onClick:()=>{let e=$.selectedNode;if("action"!==H||void 0===e||void 0===O)return;let n=e.id,t=selectDownstream(O,[n]),i=selectNodes([...t],T);D(i)},children:"Select child nodes"})]})})]}):(0,i.jsx)(c.M,{h:"100%",children:(0,i.jsxs)(d.g,{children:[(0,i.jsx)(i.Fragment,{children:"No change detected"}),(0,i.jsx)(h.z,{colorScheme:"blue",onClick:()=>{U("normal"),handleViewOptionsChanged({...M,view_mode:"all"})},children:"Show all nodes"})]})})}function LineageView(e){let{...n}=e;return void 0===n.interactive&&(n.interactive=!0),void 0===n.viewMode&&(n.viewMode="changed_models"),(0,i.jsx)(r.tV,{children:(0,i.jsx)(_LineageView,{...n})})}var no=t(69771),ns=t(80111),na=t(98786);function RecceContextProvider(e){let{children:n}=e;return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(RecceQueryContextProvider,{children:(0,i.jsx)(LineageGraphContextProvider,{children:(0,i.jsx)(RowCountStateContextProvider,{children:(0,i.jsx)(RecceActionContextProvider,{children:n})})})})})}function useVersionNumber(){let[e,n]=(0,y.useState)("");return(0,y.useEffect)(()=>{(async function(){try{let e=await H.get("/api/version");n(e.data)}catch(e){console.error("Error fetching version number:",e)}})()},[]),e}var nc=t(45489),nd=t(69005),nu=t(14800),nh=t(2600),nm=t(68677),nx=t(83358),np=t(76070),nf=t(44525),ng=t(93197),nv=t(2495),nj=t(30324),ny=t(234),nC=t(96094),nb=t(36334);function CheckBreadcrumb(e){let{name:n,setName:t}=e,[r,l]=(0,y.useState)(!1),[o,s]=(0,y.useState)(n),a=(0,y.useRef)(null),c=(0,y.useCallback)(()=>{t(o),l(!1)},[t,l,o]);return(0,y.useEffect)(()=>{let handleClickOutside=e=>{a.current&&!a.current.contains(e.target)&&c()};return r&&document.addEventListener("mousedown",handleClickOutside),()=>{document.removeEventListener("mousedown",handleClickOutside)}},[r,a,c]),(0,i.jsxs)(ny.a,{flex:"0 1",fontSize:"12pt",fontWeight:"500",separator:(0,i.jsx)(nb.X,{color:"gray.500"}),children:[(0,i.jsx)(nC.g,{children:(0,i.jsx)(u.xu,{children:"Checklist"})}),(0,i.jsx)(nC.g,{flex:"0 1",cursor:"pointer",children:r?(0,i.jsx)(eO.I,{ref:a,value:o,onChange:e=>{s(e.target.value)},onKeyDown:e=>{"Enter"===e.key?(t(o),l(!1)):"Escape"===e.key&&(s(n),l(!1))},size:"sm",w:"auto",minW:"200px",maxW:"600px"}):(0,i.jsx)(u.xu,{onClick:()=>{s(n),l(!0)},textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",children:n})})]})}function SchemaDiffView(e){let{check:n}=e,{lineageGraph:t}=useLineageGraphContext(),r=n.params,l=r.node_id,o=l?null==t?void 0:t.nodes[l]:void 0;return o?(0,i.jsx)(SchemaView,{base:o.data.base,current:o.data.current,enableScreenshot:!0}):(0,i.jsx)(i.Fragment,{})}var nk=t(33695);function CheckDescription(e){let{value:n,onChange:t}=e,[r,l]=(0,y.useState)(!1),[o,a]=(0,y.useState)(),c=(0,y.useRef)(null);return((0,y.useEffect)(()=>{if(r&&c.current){let e=c.current;e.focus(),e.setSelectionRange(e.value.length,e.value.length)}},[r]),r)?(0,i.jsxs)(s.k,{direction:"column",align:"flex-end",children:[(0,i.jsx)(nk.g,{h:"200px",value:o,onChange:e=>{a(e.target.value)},onKeyDown:e=>{"Escape"===e.key&&l(!1)},ref:c}),(0,i.jsxs)(s.k,{gap:"12px",alignItems:"flex-end",children:[(0,i.jsx)(ez.r,{onClick:()=>{setTimeout(()=>{l(!1)},100)},colorScheme:"blue",children:"cancel"}),(0,i.jsx)(h.z,{mt:"8px",size:"sm",colorScheme:"blue",onClick:()=>{t&&(t(o),l(!1))},children:"Update"})]})]}):(0,i.jsx)(p.x,{maxHeight:"400px",overflow:"auto",fontSize:"11pt",onClick:()=>{a(n||""),l(!0)},whiteSpace:"pre-line",color:n?"inherit":"lightgray",children:n||"Add description here"})}var nw=t(48742);function _templateObject(){let e=(0,nc._)(["\n    **SQL**\n    ```sql\n    ","\n    ```\n    "],["\n    **SQL**\n    \\`\\`\\`sql\n    ","\n    \\`\\`\\`\n    "]);return _templateObject=function(){return e},e}function buildTitle(e){return"".concat(e.is_checked?"✅ ":"").concat(e.name)}function buildDescription(e){return e.description?e.description:"_(no description)_"}function buildQuery(e){var n;return(0,nw.Pn)(_templateObject(),null===(n=e.params)||void 0===n?void 0:n.sql_template)}var query_SqlEditor=e=>{let{value:n,onChange:t,onRun:r,onRunDiff:l,options:o={},...s}=e;return(0,i.jsx)(e9.ZP,{language:"sql",theme:"vs",value:n,onChange:e=>{void 0!==e&&t&&t(e)},onMount:(e,n)=>{r&&e.addCommand(n.KeyMod.CtrlCmd|n.KeyCode.Enter,r),l&&e.addCommand(n.KeyMod.CtrlCmd|n.KeyMod.Shift|n.KeyCode.Enter,l)},options:{tabSize:2,fontSize:16,lineNumbers:"on",automaticLayout:!0,minimap:{enabled:!1},wordWrap:"on",wrappingIndent:"indent",...o}})};function LineageDiffView(e){let{check:n}=e,t={...n.params,...n.view_options};return(0,i.jsx)(s.k,{direction:"column",height:"100%",children:(0,i.jsx)(LineageView,{viewOptions:t,interactive:!1})})}var nS=t(86380);function PresetCheckTemplateView(e){let{name:n,description:t,type:r,params:l,viewOptions:o}=e,s={name:n,description:t,type:r,params:l};o&&(s.view_options=o);let a=nS.ZP.stringify({checks:[s]});return(0,i.jsx)(e9.ML,{height:"300px",language:"yaml",theme:"vs",value:a,options:{readOnly:!0,fontSize:14,lineNumbers:"off",automaticLayout:!0,minimap:{enabled:!1},wordWrap:"on",wrappingIndent:"same",scrollBeyondLastLine:!1}})}function CheckDetail_templateObject(){let e=(0,nc._)(["\n  <details><summary>","</summary>\n\n  ","\n\n  </details>"]);return CheckDetail_templateObject=function(){return e},e}let useCancelOnUnmount=e=>{let{runId:n,isPending:t,setAborting:i}=e;(0,y.useEffect)(()=>()=>{i(!1),n&&t&&cancelRun(n)},[t,n,i])},CheckDetail=e=>{var n;let{checkId:t}=e,r=(0,G.NL)(),[,l]=(0,eB.TH)(),{successToast:o,failToast:a}=useClipBoardToast(),[d,x]=(0,y.useState)(),[p,f]=(0,y.useState)(),[C,b]=(0,y.useState)(!1),{isOpen:k,onOpen:R,onClose:T}=(0,ex.q)(),Overlay=()=>(0,i.jsx)(ef.Z,{bg:"blackAlpha.300",backdropFilter:"blur(10px) "}),[D,I]=(0,y.useState)((0,i.jsx)(Overlay,{})),{isLoading:E,error:N,refetch:z,data:M}=(0,U.a)({queryKey:W.check(t),queryFn:async()=>getCheck(t),refetchOnMount:!1,staleTime:3e5}),O=(null==M?void 0:M.type)?findByRunType(null==M?void 0:M.type):void 0,F=(null==M?void 0:M.is_preset)||!1,{mutate:P}=(0,eq.D)({mutationFn:e=>updateCheck(t,e),onSuccess:()=>{r.invalidateQueries({queryKey:W.check(t)}),r.invalidateQueries({queryKey:W.checks()})}}),{mutate:V}=(0,eq.D)({mutationFn:()=>deleteCheck(t),onSuccess:()=>{r.invalidateQueries({queryKey:W.checks()}),l("/checks")}}),submitRunFn=async()=>{let e=null==M?void 0:M.type;if(!e)return;let{run_id:n}=await submitRunFromCheck(t,{nowait:!0});for(x(n);;){let e=await waitRun(n,2);if(f(e.progress),e.result||e.error)return b(!1),f(void 0),e}},{data:q,mutate:B,error:H,isIdle:K,isPending:Q}=(0,eq.D)({mutationFn:submitRunFn,onSuccess:e=>{z()}}),handleRerun=async()=>{B()},J=(0,y.useCallback)(async()=>{if(b(!0),d)return await cancelRun(d)},[d]);useCancelOnUnmount({runId:d,isPending:Q,setAborting:b});let handleCopy=async()=>{if(!M)return;let e=buildMarkdown(M);if(!navigator.clipboard){a("Failed to copy the check to clipboard",Error("Copy to clipboard is available only in secure contexts (HTTPS)"));return}try{await navigator.clipboard.writeText(e),o("Copied the check to the clipboard")}catch(e){a("Failed to copy the check to clipboard",e)}},Z=(0,y.useCallback)(()=>{let e=null==M?void 0:M.is_checked;P({is_checked:!e})},[null==M?void 0:M.is_checked,P]);if(E)return(0,i.jsx)(c.M,{h:"100%",children:"Loading"});if(N)return(0,i.jsxs)(c.M,{h:"100%",children:["Error: ",N.message]});let X=K?null==M?void 0:M.last_run:q,Y=(null==X?void 0:X.run_at)?(0,eW.Z)(new Date(X.run_at),{addSuffix:!0}):null;return(0,i.jsxs)(s.k,{height:"100%",width:"100%",maxHeight:"100%",direction:"column",children:[(0,i.jsxs)(s.k,{p:"0px 16px",alignItems:"center",children:[(0,i.jsx)(CheckBreadcrumb,{name:(null==M?void 0:M.name)||"",setName:e=>{P({name:e})}}),(0,i.jsx)(S.L,{}),F&&(0,i.jsx)(w.u,{label:"Preset Check defined in recce config",children:(0,i.jsxs)(A.Vp,{size:"sm",children:[(0,i.jsx)(A.AD,{boxSize:"14px",as:nv.bX4}),"Preset"]})}),(0,i.jsxs)(g.v,{children:[(0,i.jsx)(eF.j,{isRound:!0,as:L.h,icon:(0,i.jsx)(m.J,{as:_.D_A}),variant:"ghost"}),(0,i.jsxs)(v.q,{children:[(0,i.jsx)(j.s,{icon:(0,i.jsx)(nj.ovA,{}),onClick:()=>{I((0,i.jsx)(Overlay,{})),R()},children:"Get Preset Check Template"}),(0,i.jsx)(j.s,{icon:(0,i.jsx)(nf.p,{}),onClick:()=>V(),children:"Delete"})]})]}),Y&&(0,i.jsx)(u.xu,{textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",fontSize:"10pt",children:Y}),(null==O?void 0:O.RunResultView)&&(0,i.jsx)(w.u,{label:"Rerun",children:(0,i.jsx)(L.h,{isRound:!0,isLoading:Q,variant:"ghost","aria-label":"Rerun",icon:(0,i.jsx)($.n,{}),onClick:()=>handleRerun()})}),(0,i.jsx)(w.u,{label:"Copy markdown",children:(0,i.jsx)(L.h,{isRound:!0,variant:"ghost","aria-label":"Copy markdown",icon:(0,i.jsx)(em.T,{}),onClick:()=>handleCopy()})}),(0,i.jsx)(w.u,{label:(null==M?void 0:M.is_checked)?"Mark as unchecked":"Mark as checked",children:(0,i.jsx)(h.z,{size:"sm",colorScheme:(null==M?void 0:M.is_checked)?"green":"gray",leftIcon:(0,i.jsx)(ng.r,{}),onClick:()=>Z(),children:(null==M?void 0:M.is_checked)?"Checked":"Unchecked"})})]}),(0,i.jsx)(u.xu,{p:"8px 16px",minHeight:"100px",children:(0,i.jsx)(CheckDescription,{value:null==M?void 0:M.description,onChange:e=>{P({description:e})}},null==M?void 0:M.check_id)}),((null==M?void 0:M.type)==="query"||(null==M?void 0:M.type)==="query_diff")&&(0,i.jsx)(nd.U,{defaultIndex:[],allowToggle:!0,children:(0,i.jsxs)(nu.Q,{children:[(0,i.jsxs)(nh.K,{children:["query",(0,i.jsx)(nm.X,{})]}),(0,i.jsx)(nx.H,{children:(0,i.jsx)(u.xu,{height:"400px",width:"100%",border:"lightgray 1px solid ",children:(0,i.jsx)(query_SqlEditor,{value:(null===(n=null==M?void 0:M.params)||void 0===n?void 0:n.sql_template)||"",options:{readOnly:!0}})})})]})}),(0,i.jsxs)(u.xu,{style:{contain:"size"},flex:"1 1 0%",children:[(null==O?void 0:O.RunResultView)&&(0,i.jsx)(RunView,{isPending:Q,isAborting:C,isCheckDetail:!0,run:X,error:H,progress:p,RunResultView:O.RunResultView,viewOptions:null==M?void 0:M.view_options,onViewOptionsChanged:e=>{P({view_options:e})},onCancel:J,onExecuteRun:handleRerun}),M&&"schema_diff"===M.type&&(0,i.jsx)(SchemaDiffView,{check:M}),M&&"lineage_diff"===M.type&&(0,i.jsx)(LineageDiffView,{check:M})]}),(0,i.jsxs)(ep.u_,{isOpen:k,onClose:T,isCentered:!0,size:"6xl",children:[D,(0,i.jsxs)(eg.h,{overflowY:"auto",height:"40%",width:"60%",children:[(0,i.jsx)(ev.x,{children:"Preset Check Template"}),(0,i.jsx)(ej.o,{}),(0,i.jsxs)(ey.f,{children:[(0,i.jsx)(eo.X,{size:"sm",fontWeight:"bold",children:(0,i.jsx)(np.y$,{query:"recce.yml",styles:{px:"1",py:"0",bg:"red.100"},children:"Please copy the following template and paste it into the recce.yml file."})}),(0,i.jsx)("br",{}),(0,i.jsx)(PresetCheckTemplateView,{name:(null==M?void 0:M.name)||"",description:(null==M?void 0:M.description)||"",type:(null==M?void 0:M.type)||"",params:null==M?void 0:M.params,viewOptions:null==M?void 0:M.view_options})]})]})]})]})};function buildMarkdown(e){return(0,nw.RI)(CheckDetail_templateObject(),buildTitle(e),buildBody(e))}function buildBody(e){return"query"===e.type||"query_diff"===e.type?"".concat(buildDescription(e),"\n\n").concat(buildQuery(e)):buildDescription(e)}var n_=t(38505);let ChecklistItem=e=>{var n;let{check:t,selected:r,onSelect:l}=e,o=(0,G.NL)(),a=t.check_id,{mutate:c}=(0,eq.D)({mutationFn:e=>updateCheck(a,e),onSuccess:()=>{o.invalidateQueries({queryKey:W.check(a)}),o.invalidateQueries({queryKey:W.checks()})}}),d=(null===(n=findByRunType(t.type))||void 0===n?void 0:n.icon)||ee.WzH;return(0,i.jsxs)(s.k,{width:"100%",p:"10px 20px",cursor:"pointer",_hover:{bg:"gray.200"},bg:r?"gray.100":"inherit",onClick:()=>l(t.check_id),alignItems:"center",gap:"5px",children:[(0,i.jsx)(m.J,{as:d}),(0,i.jsx)(u.xu,{flex:"1",textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",children:t.name}),t.is_checked&&(0,i.jsx)(m.J,{color:"green",as:R.FJM})]})},CheckList=e=>{let{checks:n,selectedItem:t,onCheckSelected:r,onChecksReordered:l}=e;return(0,i.jsx)(n_.Z5,{onDragEnd:e=>{e.destination&&l(e.source.index,e.destination.index)},children:(0,i.jsx)(n_.bK,{droppableId:"checklist",children:e=>(0,i.jsxs)(d.g,{...e.droppableProps,ref:e.innerRef,w:"full",spacing:"0",flex:"1",children:[n.map((e,n)=>(0,i.jsx)(n_._l,{draggableId:e.check_id,index:n,children:n=>(0,i.jsx)(s.k,{ref:n.innerRef,...n.draggableProps,...n.dragHandleProps,w:"full",children:(0,i.jsx)(ChecklistItem,{check:e,selected:e.check_id===t,onSelect:r},e.check_id)})},e.check_id)),e.placeholder]})})})};function CheckPage_templateObject(){let e=(0,nc._)(["\n    <details><summary>","</summary>\n\n    ","\n\n    </details>"]);return CheckPage_templateObject=function(){return e},e}let CheckPage=()=>{let[,e]=(0,eB.TH)(),[,n]=(0,eB.yj)("/checks/:checkId"),t=(0,G.NL)(),{successToast:r,failToast:l}=useClipBoardToast(),o=null==n?void 0:n.checkId,{isLoading:a,error:h,data:m,status:x}=(0,U.a)({queryKey:W.checks(),queryFn:listChecks,refetchOnMount:!0}),p=(0,y.useCallback)(n=>{e("/checks/".concat(n))},[e]),[f,g]=(0,y.useState)(m||[]),{mutate:v}=(0,eq.D)({mutationFn:e=>reorderChecks(e),onSuccess:()=>{t.invalidateQueries({queryKey:W.checks()})}}),j=(0,y.useCallback)((e,n)=>{let t=[...f],[i]=t.splice(e,1);t.splice(n,0,i),v({source:e,destination:n}),g(t)},[f,g,v]);return((0,y.useCallback)(async()=>{let e=await createSimpleCheck();t.invalidateQueries({queryKey:W.checks()}),p(e.check_id)},[t,p]),(0,y.useEffect)(()=>{"success"===x&&(!o&&m.length>0&&e("/checks/".concat(m[0].check_id)),g(m))},[x,o,m,g,e]),a)?(0,i.jsx)(i.Fragment,{children:"Loading"}):h?(0,i.jsxs)(i.Fragment,{children:["Error: ",h.message]}):(null==m?void 0:m.length)?(0,i.jsxs)(s.k,{height:"100%",children:[(0,i.jsx)(u.xu,{flex:"0 0 400px",borderRight:"lightgray solid 1px",height:"100%",style:{contain:"size"},children:(0,i.jsxs)(d.g,{spacing:0,align:"flex-end",h:"100%",children:[(0,i.jsx)(w.u,{label:"Copy checklist to the clipboard",children:(0,i.jsx)(L.h,{mr:"10px",variant:"unstyled","aria-label":"Copy checklist to the clipboard",onClick:async()=>{let e=CheckPage_buildMarkdown(m);if(!navigator.clipboard){l("Failed to copy checklist to clipboard",Error("Copy to clipboard is available only in secure contexts (HTTPS)"));return}try{await navigator.clipboard.writeText(e),r("Copied ".concat(m.length," checks to the clipboard"))}catch(e){l("Failed to copy checklist to clipboard",e)}},icon:(0,i.jsx)(em.T,{})})}),(0,i.jsx)(eM.i,{mb:"8px"}),(0,i.jsx)(CheckList,{checks:f,selectedItem:o,onCheckSelected:p,onChecksReordered:j})]})}),(0,i.jsx)(u.xu,{flex:"1",height:"100%",width:"calc(100% - 400px)",children:(0,i.jsx)(eB.rs,{children:(0,i.jsx)(eB.AW,{path:"/checks/:checkId",children:e=>(0,i.jsx)(CheckDetail,{checkId:e.checkId},e.checkId)})})})]}):(0,i.jsx)(c.M,{h:"100%",children:(0,i.jsx)(u.xu,{children:"No checks"})})};function CheckPage_buildMarkdown(e){let n=e.map(e=>(0,nw.RI)(CheckPage_templateObject(),buildTitle(e),buildDescription(e)));return n.join("\n\n")}async function submitQuery(e,n){return await submitRun("query",e,n)}async function submitQueryDiff(e,n){return await submitRun("query_diff",e,n)}var nR=t(60186);let QueryForm=e=>{let{defaultPrimaryKeys:n,onPrimaryKeysChange:t,...r}=e,{lineageGraph:l}=useLineageGraphContext(),o=(0,y.useMemo)(()=>{if(!l)return[];let e=new Set;for(let i in l.nodes){var n,t;let r=l.nodes[i],o=null===(n=r.data.base)||void 0===n?void 0:n.columns,s=null===(t=r.data.current)||void 0===t?void 0:t.columns;for(let n in o)e.add(n);for(let n in s)e.add(n)}return Array.from(e).sort()},[l]);return(0,i.jsx)(s.k,{...r,children:(0,i.jsxs)(en.NI,{m:"4px 8px",children:[(0,i.jsxs)(et.l,{children:["Primary key"," ",(0,i.jsx)(w.u,{label:"When a primary key is present, the query difference is computed in the warehouse through joins. Otherwise, it's computed on the client side.",children:(0,i.jsx)(N.s,{color:"gray.600",boxSize:"3"})})]}),(0,i.jsxs)(nR.Qc,{restoreOnBlurIfEmpty:!1,multiple:!0,creatable:!0,filter:(e,n)=>n.startsWith(e),onChange:e=>t(e),defaultValues:void 0!==n&&0!==n.length?n:void 0,children:[(0,i.jsx)(nR.Vp,{placeholder:"Select primary key...",variant:"outline",children:e=>{let{tags:n}=e;return n.map((e,n)=>(0,i.jsx)(nR.Y4,{label:e.label,onRemove:e.onRemove},n))}}),(0,i.jsxs)(nR.Jm,{children:[o.map((e,n)=>(0,i.jsx)(nR.Gb,{value:e,children:e},"option-".concat(n))),(0,i.jsx)(nR.JU,{children:e=>{let{value:n}=e;return(0,i.jsxs)(s.k,{children:["Add '",n,"' to List"]})}})]})]})]})})},QueryPage=()=>{let{sqlQuery:e,setSqlQuery:n,primaryKeys:t,setPrimaryKeys:r}=useRecceQueryContext(),{envInfo:l}=useLineageGraphContext(),o=e;(null==l?void 0:l.adapterType)==="sqlmesh"&&e===e4&&(o="select * from db.mymodel");let[a,c]=(0,y.useState)(),[d,m]=(0,y.useState)(),[x,p]=(0,y.useState)({}),f=(0,G.NL)(),[,g]=(0,eB.TH)(),queryFn=async e=>{c(e);let{run_id:n}="query"===e?await submitQuery({sql_template:o},{nowait:!0}):await submitQueryDiff({sql_template:o,primary_keys:t},{nowait:!0});return m(n),await waitRun(n)},{data:v,mutate:j,error:C,isPending:b}=(0,eq.D)({mutationFn:queryFn,onSuccess:e=>{p({})}}),k=(0,y.useCallback)(async()=>{if(d)return await cancelRun(d)},[d]),w=(0,y.useCallback)(async e=>{if(!(null==e?void 0:e.run_id))return;let n=await createCheckByRun(e.run_id,x);f.invalidateQueries({queryKey:W.checks()}),g("/checks/".concat(n.check_id))},[g,x,f]);return(0,i.jsxs)(s.k,{direction:"column",height:"100%",children:[(0,i.jsxs)(s.k,{justifyContent:"right",padding:"5px",gap:"5px",children:[(0,i.jsx)(h.z,{colorScheme:"blue",onClick:()=>j("query_diff"),isDisabled:b,size:"sm",children:"Run Diff"}),(0,i.jsx)(h.z,{colorScheme:"blue",onClick:()=>j("query"),isDisabled:b,size:"sm",children:"Run"})]}),(0,i.jsxs)(s.k,{direction:"row",height:"300px",children:[(0,i.jsx)(u.xu,{width:"70%",border:"1px solid #CBD5E0",children:(0,i.jsx)(query_SqlEditor,{value:o,onChange:n,onRun:()=>j("query"),onRunDiff:()=>j("query_diff")})}),(0,i.jsx)(QueryForm,{ml:"10px",p:"5px",width:"30%",border:"1px",borderColor:"gray.300",defaultPrimaryKeys:t,onPrimaryKeysChange:r})]}),(0,i.jsx)(s.k,{flex:"1",direction:"column",children:"query"===a?(0,i.jsx)(RunView,{run:v,error:C,isPending:b,onCancel:k,children:e=>(0,i.jsx)(QueryResultView,{...e,onAddToChecklist:w})},d):(0,i.jsx)(RunView,{isPending:b,run:v,error:C,viewOptions:x,onViewOptionsChanged:p,onCancel:k,children:e=>(0,i.jsx)(QueryDiffResultView,{...e,onAddToChecklist:w})},d)})]})};var nT=t(72952);let hashNavigate=e=>(0,nT.c4)("#!"+e),useHashLocation=()=>{let e=(0,nT.LD)(()=>window.location.hash.replace(/^#!/,"")||"/",()=>"/ssr");return[e,hashNavigate]};var nD=t(82017),nI=t(41546);let RunPage=e=>{var n;let{runId:t}=e,{isPending:r,error:l,data:o}=(0,U.a)({queryKey:W.run(t),queryFn:async()=>waitRun(t)}),s=(null==o?void 0:o.type)?null===(n=findByRunType(o.type))||void 0===n?void 0:n.RunResultView:void 0;return(0,i.jsx)(RunView,{isPending:r,error:l,run:o,RunResultView:s})};var nE=t(26954);let Fallback=e=>{let{error:n,resetError:t}=e;return(0,i.jsx)(c.M,{height:"100%",backgroundColor:"gray.50",children:(0,i.jsxs)(s.k,{p:4,direction:"column",justifyContent:"flex-start",backgroundColor:"white",border:"solid lightgray 1px",minHeight:"200px",children:[(0,i.jsx)(eo.X,{width:"800px",size:"md",children:"You have encountered an error"}),(0,i.jsx)(u.xu,{flex:"1",fontSize:"10pt",children:n.toString()}),(0,i.jsx)(h.z,{justifySelf:"center",alignSelf:"center",mt:"20px",colorScheme:"blue",size:"sm",onClick:()=>{t()},children:"Reset"})]})})},ErrorBoundary=e=>{let{children:n}=e;return(0,i.jsx)(nE.SV,{fallback:Fallback,children:n})};async function exportState(){let e=await H.post("/api/export");return e.data}async function importState(e){let n=new FormData;n.append("file",e);let t=await H.post("/api/import",n);return t.data}var nN=t(54726);function StateExporter(){let e=(0,J.p)(),handleExport=async()=>{try{let e=await exportState(),n=JSON.stringify(e,null,2),t=new Blob([n],{type:"application/json"}),i=new Date,r="recce-state-".concat((0,e_.ZP)(i,"yyyy-MM-dd-HH-mm-ss"),".json");eT()(t,r)}catch(n){console.error("Export failed",n),e({title:"Export failed",description:"".concat(n),status:"error",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})}};return(0,i.jsx)(w.u,{label:"Export",children:(0,i.jsx)(L.h,{pt:"6px",variant:"unstyled","aria-label":"Export state",onClick:handleExport,icon:(0,i.jsx)(m.J,{as:nN.tRY,boxSize:"1.2em"})})})}var nz=t(73672);function StateImporter(){let e=(0,J.p)(),n=(0,G.NL)(),t=(0,y.useRef)(null),r=(0,y.useRef)(null),[l,o]=(0,y.useState)(null),{isOpen:a,onOpen:c,onClose:d}=(0,ex.q)(),[u,x]=(0,eB.TH)(),[,f]=useRunsAggregated(),g=(0,y.useCallback)(async()=>{if(l){try{let{runs:t,checks:i}=await importState(l);f(),await n.invalidateQueries({queryKey:W.checks()}),u.includes("/checks")&&x("/checks"),e({description:"".concat(t," runs and ").concat(i," checks imported successfully"),status:"info",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})}catch(n){console.error("Import failed",n),e({title:"Import failed",description:"".concat(n),status:"error",variant:"left-accent",position:"bottom",duration:5e3,isClosable:!0})}d()}},[n,l,e,d,u,x,f]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(w.u,{label:"Import",children:(0,i.jsx)(L.h,{pt:"6px",variant:"unstyled","aria-label":"Import state",onClick:()=>{t.current&&t.current.click()},icon:(0,i.jsx)(m.J,{as:nN.wQf,boxSize:"1.2em"})})}),(0,i.jsx)("input",{type:"file",style:{display:"none"},ref:t,onChange:e=>{var n;(null===(n=e.target.files)||void 0===n?void 0:n.length)===1&&(o(e.target.files[0]),c())}}),(0,i.jsx)(nz.a,{isOpen:a,leastDestructiveRef:r,onClose:d,size:"xl",children:(0,i.jsx)(ef.Z,{children:(0,i.jsxs)(nz._,{children:[(0,i.jsx)(ev.x,{fontSize:"lg",fontWeight:"bold",children:"Import state"}),(0,i.jsx)(ey.f,{children:(0,i.jsxs)(s.k,{px:"5px",gap:"5px",rounded:"md",direction:"column",children:[(0,i.jsxs)(s.k,{alignItems:"center",gap:"5px",children:[(0,i.jsx)(N.s,{color:"red.600"}),(0,i.jsx)(p.x,{as:"span",fontWeight:"500",color:"red.600",children:"Caution!"})]}),(0,i.jsx)(s.k,{children:(0,i.jsxs)(p.x,{children:["The current runs and checks will be"," ",(0,i.jsx)(p.x,{as:"span",fontWeight:"600",children:"merged"})," ","with the imported state"]})})]})}),(0,i.jsxs)(eb.m,{children:[(0,i.jsx)(h.z,{ref:r,onClick:d,children:"Cancel"}),(0,i.jsx)(h.z,{colorScheme:"blue",onClick:g,ml:"5px",children:"Import"})]})]})})})]})}t(41759);var nM=t(34573),nA=t(64602),nO=t(87972),nL=t(63429),nF=t(68625),nP=t(51239),nV=t(49364),nq=t(43644),nB=t(17307);function formatTimestamp(e){let n=(0,nB.Z)(e),t=(0,e_.ZP)(n,"yyyy-MM-dd'T'HH:mm:ss");return t}function renderInfoEntries(e){return Object.values(e).every(e=>null===e)?[(0,i.jsx)(s.k,{ml:"10px",children:"No information"},"no info")]:Object.entries(e).filter(e=>{let[n,t]=e;return"url"!==n&&null!=t}).map(e=>{let[n,t]=e;return(0,i.jsxs)(nM.HC,{ml:"10px",children:[n,": ",t]},n)})}function EnvInfo(){var e,n,t,r,l,o;let{envInfo:a,reviewMode:c,lineageGraph:d}=useLineageGraphContext(),{isOpen:u,onOpen:x,onClose:p}=(0,ex.q)(),f=null==a?void 0:a.git,g=null==a?void 0:a.pullRequest,v={...f,...g},j=null==a?void 0:null===(e=a.dbt)||void 0===e?void 0:e.base,y=null==a?void 0:null===(n=a.dbt)||void 0===n?void 0:n.current,C=(null==j?void 0:j.generated_at)?formatTimestamp(null==j?void 0:j.generated_at):"",b=(null==y?void 0:y.generated_at)?formatTimestamp(null==y?void 0:y.generated_at):"",k=new Set,S=new Set;if(null==d?void 0:d.nodes)for(let e of Object.values(null==d?void 0:d.nodes))(null===(l=e.data.base)||void 0===l?void 0:l.schema)&&k.add(e.data.base.schema),(null===(o=e.data.current)||void 0===o?void 0:o.schema)&&S.add(e.data.current.schema);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(w.u,{label:"Environment Info",children:(0,i.jsx)(L.h,{pt:"6px",variant:"unstyled","aria-label":"Export state",onClick:x,icon:(0,i.jsx)(m.J,{as:nj.lS4,boxSize:"1.5em",color:"gray.500"})})}),(0,i.jsxs)(ep.u_,{isOpen:u,onClose:p,size:"3xl",children:[(0,i.jsx)(ef.Z,{}),(0,i.jsxs)(eg.h,{children:[(0,i.jsx)(ev.x,{children:"Environment Information"}),(0,i.jsx)(ej.o,{}),(0,i.jsx)(ey.f,{children:(0,i.jsxs)(s.k,{direction:"column",gap:"5px",children:[c?(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)(s.k,{justifyContent:"left",gap:"5px",direction:"column",children:[(0,i.jsx)(eo.X,{size:"sm",children:"Review Information"}),(0,i.jsxs)(nM.QI,{spacing:1,children:[(null==v?void 0:v.url)&&(0,i.jsxs)(nM.HC,{ml:"10px",children:["url:"," ",(0,i.jsx)(ez.r,{href:v.url,color:"blue.500",isExternal:!0,children:v.url})]}),v&&renderInfoEntries(v)]})]})}):(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)(s.k,{justifyContent:"left",gap:"5px",direction:"column",children:[(0,i.jsx)(eo.X,{size:"sm",children:"Dev Information"}),(0,i.jsx)(nM.QI,{spacing:1,children:f&&renderInfoEntries(f)})]})}),(0,i.jsx)(eM.i,{}),(null==a?void 0:a.adapterType)==="dbt"&&(0,i.jsxs)(s.k,{justifyContent:"left",gap:"5px",direction:"column",children:[(0,i.jsx)(eo.X,{size:"sm",children:"DBT"}),(0,i.jsx)(nA.x,{children:(0,i.jsxs)(nO.i,{variant:"simple",children:[(0,i.jsx)(nL.h,{children:(0,i.jsxs)(nF.Tr,{children:[(0,i.jsx)(nP.Th,{}),(0,i.jsx)(nP.Th,{children:"base"}),(0,i.jsx)(nP.Th,{children:"current"})]})}),(0,i.jsxs)(nV.p,{children:[(0,i.jsxs)(nF.Tr,{children:[(0,i.jsx)(nq.Td,{children:"schema"}),(0,i.jsx)(nq.Td,{children:JSON.stringify(Array.from(k))}),(0,i.jsx)(nq.Td,{children:JSON.stringify(Array.from(S))})]}),(0,i.jsxs)(nF.Tr,{children:[(0,i.jsx)(nq.Td,{children:"version"}),(0,i.jsx)(nq.Td,{children:null==j?void 0:j.dbt_version}),(0,i.jsx)(nq.Td,{children:null==y?void 0:y.dbt_version})]}),(0,i.jsxs)(nF.Tr,{children:[(0,i.jsx)(nq.Td,{children:"timestamp"}),(0,i.jsx)(nq.Td,{children:C}),(0,i.jsx)(nq.Td,{children:b})]})]})]})})]}),(null==a?void 0:a.adapterType)==="sqlmesh"&&(0,i.jsxs)(s.k,{justifyContent:"left",gap:"5px",direction:"column",children:[(0,i.jsx)(eo.X,{size:"sm",children:"SQLMesh"}),(0,i.jsx)(nA.x,{children:(0,i.jsxs)(nO.i,{variant:"simple",children:[(0,i.jsx)(nL.h,{children:(0,i.jsxs)(nF.Tr,{children:[(0,i.jsx)(nP.Th,{}),(0,i.jsx)(nP.Th,{children:"base"}),(0,i.jsx)(nP.Th,{children:"current"})]})}),(0,i.jsx)(nV.p,{children:(0,i.jsxs)(nF.Tr,{children:[(0,i.jsx)(nq.Td,{children:"Environment"}),(0,i.jsx)(nq.Td,{children:null==a?void 0:null===(t=a.sqlmesh)||void 0===t?void 0:t.base_env}),(0,i.jsx)(nq.Td,{children:null==a?void 0:null===(r=a.sqlmesh)||void 0===r?void 0:r.current_env})]})})]})})]})]})}),(0,i.jsx)(eb.m,{children:(0,i.jsx)(h.z,{colorScheme:"blue",mr:3,onClick:p,children:"Close"})})]})]})]})}var nH=t(12218);function getCookie(e){var n=document.cookie.match("(^|;)\\s*"+e+"\\s*=\\s*([^;]+)");return n?n.pop():""}let RouteAlwaysMount=e=>{let{children:n,path:t}=e,[r]=(0,eB.yj)(t);return(0,i.jsx)(u.xu,{display:r?"block":"none",height:"100%",children:n})};function LinkIcon(e){let{icon:n,href:t,...r}=e;return(0,i.jsx)(ez.r,{height:"20px",color:"white",href:t,isExternal:!0,...r,children:(0,i.jsx)(m.J,{color:"white",boxSize:"20px",as:n})})}function TopBar(){var e;let{reviewMode:n,isDemoSite:t,envInfo:r}=useLineageGraphContext(),l=useVersionNumber(),o=null==r?void 0:null===(e=r.pullRequest)||void 0===e?void 0:e.url;return(0,i.jsxs)(s.k,{gap:"10px",minHeight:"40px",alignItems:"center",bg:"rgb(255, 110, 66)",children:[(0,i.jsx)(eC.E,{boxSize:"20px",ml:"18px",src:"/logo/recce-logo-white.png",alt:"recce-logo-white"}),(0,i.jsx)(eo.X,{as:"h1",fontFamily:'"Montserrat", sans-serif',fontSize:"lg",color:"white",children:"RECCE"}),(0,i.jsx)(no.C,{fontSize:"sm",color:"white",colorScheme:"whiteAlpha",variant:"outline",children:l}),n&&(0,i.jsx)(no.C,{fontSize:"sm",color:"white",colorScheme:"whiteAlpha",variant:"outline",children:"review mode"}),(0,i.jsx)(S.L,{}),t&&o&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(N.s,{}),(0,i.jsxs)(p.x,{children:["Please check"," ",(0,i.jsx)(ez.r,{textDecoration:"underline",fontWeight:"600",href:o,isExternal:!0,children:"this Pull Request"})," ","comment for context about this Recce instance"]})]}),(0,i.jsx)(S.L,{}),(0,i.jsx)(LinkIcon,{icon:R.hJX,href:"https://github.com/DataRecce/recce"}),(0,i.jsx)(LinkIcon,{icon:R.w5k,href:"https://getdbt.slack.com/archives/C05C28V7CPP"}),(0,i.jsx)(LinkIcon,{mr:"18px",icon:R.MXt,href:"https://datarecce.io/docs"})]})}function NavBar(){let{isDemoSite:e}=useLineageGraphContext(),[n,t]=(0,eB.TH)(),r=[{name:"Lineage",href:"/lineage"},{name:"Query",href:"/query"},{name:"Checks",href:"/checks"}],l=el().findIndex(r,e=>{let{href:t}=e;return n.startsWith(t)});return(0,i.jsx)(e$.m,{index:l,children:(0,i.jsxs)(e0.t,{children:[r.map(e=>{let{name:n,href:r}=e;return(0,i.jsx)(e1.O,{onClick:()=>{t(r)},children:n},n)}),(0,i.jsx)(S.L,{}),!e&&(0,i.jsx)(StateImporter,{}),(0,i.jsx)(StateExporter,{}),(0,i.jsx)(EnvInfo,{})]})})}function Home(){(0,y.useLayoutEffect)(()=>{let e=getCookie("recce_user_id");if(e&&nH.env.AMPLITUDE_API_KEY)try{na.S1(nH.env.AMPLITUDE_API_KEY,e,{defaultTracking:!0})}catch(e){console.error(e)}},[]);let e=(0,nD.Z)({components:{MuiTooltip:{styleOverrides:{tooltip:{zIndex:1500}}}}});return(0,i.jsx)(nI.Z,{theme:e,children:(0,i.jsx)(ns.x,{children:(0,i.jsx)(G.aH,{client:K,children:(0,i.jsx)(eB.F0,{hook:useHashLocation,children:(0,i.jsx)(RecceContextProvider,{children:(0,i.jsxs)(s.k,{direction:"column",height:"100vh",children:[(0,i.jsx)(TopBar,{}),(0,i.jsx)(NavBar,{}),(0,i.jsx)(ErrorBoundary,{children:(0,i.jsxs)(u.xu,{p:0,overflow:"auto",flex:"1",style:{contain:"size"},children:[(0,i.jsx)(RouteAlwaysMount,{path:"/lineage",children:(0,i.jsx)(LineageView,{})}),(0,i.jsxs)(eB.rs,{children:[(0,i.jsx)(eB.AW,{path:"/query",children:(0,i.jsx)(QueryPage,{})}),(0,i.jsx)(eB.AW,{path:"/checks/:slug*",children:(0,i.jsx)(CheckPage,{})}),(0,i.jsx)(eB.AW,{path:"/runs/:runId",children:e=>{let{runId:n}=e;return(0,i.jsx)(RunPage,{runId:n})}}),(0,i.jsx)(eB.AW,{path:"/ssr",children:(0,i.jsx)(i.Fragment,{children:"Loading"})}),(0,i.jsx)(eB.AW,{children:(0,i.jsx)(eB.l_,{to:"/lineage"})})]})]})})]})})})})})})}},88727:function(){},7866:function(){},75165:function(){}},function(e){e.O(0,[634,145,170,591,521,462,531,498,43,182,710,615,971,495,599,512,582,297,62,744],function(){return e(e.s=99178)}),_N_E=e.O()}]);